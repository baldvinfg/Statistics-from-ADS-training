---
title: "Gratio_analysis"
author: "Baldvin Fannar"
date: "2024-04-23"
output: rmdformats::readthedown
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '/Users/baldvinfannar/Dropbox/BFG/Skóladót/Cambridge - BS/Af stóru tölvu/All_data')
```

```{r, echo=FALSE, include=FALSE}
# set working directory
## For Analysis computer
# setwd("C:/Users/bfg21/Desktop/Image61072_old_protocol_ADS_models/morphometrics_data_file")
## For Mac
#setwd("/Users/baldvinfannar/Dropbox/BFG/Skóladót/Cambridge - BS/Af stóru tölvu/All_data")
getwd()
```

```{r, echo=FALSE, include=FALSE}
# load libraries
library(ggplot2)
library(lawstat)
library(Hmisc)
library(fuzzyjoin)
library(ggpmisc)
library(knitr)
library(stats)
library(rmdformats)
library(dplyr)
library(tidyr)
#library(tidyverse)
#library(stringr)
```

# 1) Difference between Baldvin and Sebastian

## Settings

```{r}
# Settings
dpi_set = 300
alpha_set = 0.5
jitter_width = 0
point_size = 4
point_alpha = 0.7


# Let's import our data
raw_DATA<- read.table("/Users/baldvinfannar/Dropbox/BFG/Skóladót/Cambridge - BS/Af stóru tölvu/All_data/Sebastian vs Baldvin/Gratio_results_combined_labelled.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

#raw_DATA

# Let's start by changing g_ratio into a numeric variable
raw_DATA$g_ratio <- as.numeric(gsub(",", ".", raw_DATA$g_ratio))
raw_DATA$axon_diameter <- as.numeric(gsub(",", ".", raw_DATA$axon_diameter))
```


## Statistics

```{r}
# Let's start by comparing the differences
## Is the data normally distributed?
#shapiro.test(raw_DATA$g_ratio[raw_DATA$analyser == "Baldvin"])
#shapiro.test(raw_DATA$g_ratio[raw_DATA$analyser == "Sebastian"])
## Both give a p-value << 0.5, so the data does NOT follow a normal distribution, so we need to use a non-parametric test such as Wilcoxon rank-sum test)
wilcox_result <- wilcox.test(g_ratio ~ analyser, data = raw_DATA)
wilcox_result
#P-value > 0.05, suggesting there is not a statistically significant difference between the two analysers

# Assuming 'raw_DATA' has a column named 'sample_ID' which uniquely identifies each observation

# Due to the size of the dataset we used a welch t-test
# Subset data for each analyser
data_Baldvin <- raw_DATA[raw_DATA$analyser == "Baldvin", ]
data_Sebastian <- raw_DATA[raw_DATA$analyser == "Sebastian", ]

# Perform Welch's t-test
welch_test_result <- t.test(g_ratio ~ analyser, data = raw_DATA, var.equal = FALSE)

# Print the test result
print(welch_test_result)


# Now, we need to find what the mean difference is for the analysers
# Check if the number of observations is the same for both analysers
if (nrow(data_Baldvin) != nrow(data_Sebastian)) {
  stop("The number of observations is not the same for both analysers.")
}

# Calculate the difference between paired observations
paired_difference <- data_Baldvin$g_ratio - data_Sebastian$g_ratio

# Calculate Cohen's d
mean_difference <- mean(paired_difference)
sd_paired <- sd(paired_difference)
cohens_d <- mean_difference / sd_paired

# Calculate mean difference
mean_difference
cohens_d

# Now let's do the same for axon diameter
# Let's start by comparing the differences
## Is the data normally distributed?
shapiro.test(raw_DATA$axon_diameter[raw_DATA$analyser == "Baldvin"])
shapiro.test(raw_DATA$axon_diameter[raw_DATA$analyser == "Sebastian"])
## Both give a p-value << 0.5, so the data does NOT follow a normal distribution, so we need to use a non-parametric test such as Wilcoxon rank-sum test)
#wilcox_result <- wilcox.test(axon_diameter ~ analyser, data = raw_DATA)
#wilcox_result
#P-value > 0.05, suggesting there is not a statistically significant difference between the two analysers
welch_test_result_axon <- t.test(axon_diameter ~ analyser, data = raw_DATA, var.equal = FALSE)

# Print the test result
print(welch_test_result_axon)


# Subset data for each analyser
data_Baldvin <- raw_DATA[raw_DATA$analyser == "Baldvin", ]
data_Sebastian <- raw_DATA[raw_DATA$analyser == "Sebastian", ]

# Now, we need to find what the mean difference is for the analysers
# Check if the number of observations is the same for both analysers
if (nrow(data_Baldvin) != nrow(data_Sebastian)) {
  stop("The number of observations is not the same for both analysers.")
}

# Calculate the difference between paired observations
paired_difference <- data_Baldvin$axon_diameter - data_Sebastian$axon_diameter

# Calculate Cohen's d
mean_difference <- mean(paired_difference)
sd_paired <- sd(paired_difference)
cohens_d <- mean_difference / sd_paired

# Calculate mean difference
mean_difference
cohens_d
```

## Graphs

```{r}
# Plot positives ratio
bald_vs_seb <- ggplot(raw_DATA, aes(x = analyser, y = g_ratio, color = analyser)) +
  geom_point(shape = 16, size = 3, alpha = 0.3, position = position_jitter(width = .1)) +
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_y_continuous(breaks = seq(0.35, 1, 0.05), limits = c(0.35, 1), expand = c(0, 0)) +
  scale_color_manual(values = c("Baldvin" = "#00BFC4", "Sebastian" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of Baldvin vs Sebastian",
    x = "Analyser",
    y = "G-ratio"
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15), # Default text size for the plot
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5), # Larger and bold title
    axis.title.x = element_text(size = 16, face = "bold"), # Larger x-axis title
    axis.title.y = element_text(size = 16, face = "bold"), # Larger y-axis title
    axis.text.x = element_text(size = 15),  # Adjusting axis text sizes
    axis.text.y = element_text(size = 15),
    legend.position = "none"
  ) #+
  #geom_hline(yintercept = seq(0.35, 1, by = 0.05), linetype = "dashed", color = "gray")

# Add p-value annotation, assuming 'welch_test_result' holds your test results
p_value_text <- ifelse(welch_test_result$p.value < 0.0001, "p < 0.0001", sprintf("p = %.4f", welch_test_result$p.value))
bald_vs_seb <- bald_vs_seb + annotate("text", x = 1.5, y = 0.975, label = p_value_text, size = 6, color = "black") # Increased size for the p-value text

# Print the plot
print(bald_vs_seb)

#Save as a .png file
ggsave("Sebastian vs Baldvin/Gratio_results_Seb_vs_Bald.png", bg = "white", dpi = 300)
```

```{r}
# Now let's do it for the axon diameter
bald_vs_seb_axondiam <- ggplot(raw_DATA, aes(x = analyser, y = axon_diameter, color = analyser)) +
  geom_point(shape = 16, size = 3, alpha = 0.3, position = position_jitter(width = .1)) +
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_y_continuous(breaks = seq(0, 2500, 250), limits = c(0, 2500), expand = c(0, 0)) +
  scale_color_manual(values = c("Baldvin" = "#00BFC4", "Sebastian" = "#F8766D")) +
  labs(
    title = "Axon Diameter Comparison of Baldvin vs Sebastian",
    x = "Analyser",
    y = "Axon diameter (nm)"
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),  # Default text size for the plot
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Larger and bold title
    axis.title.x = element_text(size = 16, face = "bold"),  # Larger x-axis title
    axis.title.y = element_text(size = 16, face = "bold"),  # Larger y-axis title
    axis.text.x = element_text(size = 15),  # Adjusting axis text sizes
    axis.text.y = element_text(size = 15),
    legend.position = "none"
  ) #+
  #geom_hline(yintercept = seq(0, 2500, by = 250), linetype = "dashed", color = "gray")  # Consistent line style

# Add p-value annotation, assuming 'welch_test_result_axon' holds your test results
p_value_text <- ifelse(welch_test_result_axon$p.value < 0.0001, "p < 0.0001", sprintf("p = %.4f", welch_test_result_axon$p.value))
bald_vs_seb_axondiam <- bald_vs_seb_axondiam + annotate("text", x = 1.5, y = 2400, label = p_value_text, size = 6, color = "black")  # Increased size for the p-value text

# Print the plot
print(bald_vs_seb_axondiam)

#Save as a .png file
ggsave("Sebastian vs Baldvin/Axon_diameter_results_Seb_vs_Bald.png", bg = "white", dpi = 300)
```

```{r} 
# Now let's plot for every individual axon
ggplot(raw_DATA, aes(x = neuron_number, y = g_ratio, color = analyser)) +
  geom_point(position = position_dodge(width = 0.5)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), 
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 12),
        legend.title = element_blank()) +
  labs(y = "G-ratio", title = "G-ratio Comparison by Analyser for Selected Images") +
  scale_color_manual(values = c("Baldvin" = "blue", "Sebastian" = "red"))

ggsave("Sebastian vs Baldvin/Gratio_results_Seb_vs_Bald_indiv_axon.png", bg = "transparent", dpi = 300)
```

```{r} 
# Now let's look at the spread of the data
# First we need to calculate the differences in g-ratio between Sebastian and Baldvin
differences <- raw_DATA %>%
  group_by(neuron_number) %>%
  filter(n() == 2) %>%
  summarise(diff_g_ratio = diff(g_ratio)) %>%
  ungroup()
differences

# Visualise this
ggplot(differences, aes(x = diff_g_ratio)) +
  geom_density(fill = "lightblue") +
  labs(x = "Difference in G-ratio", y = "Density", title = "Density of G-ratio Differences") +
  theme_minimal()

ggplot(differences, aes(x = "", y = diff_g_ratio)) +
  geom_boxplot(fill = "lightgreen") +
  labs(x = "", y = "Difference in G-ratio", title = "Boxplot of G-ratio Differences") +
  theme_minimal()

# Adjusting the text properties to match the first plot
neuron_plot <- ggplot(raw_DATA, aes(x = neuron_number, y = g_ratio, group = analyser, color = analyser)) +
  geom_point(position = position_dodge(width = 0.2)) +
  geom_line(aes(group = neuron_number), position = position_dodge(width = 0.2)) +
  #geom_hline(yintercept = seq(0.5, 0.9, by = 0.05), linetype = "dashed", color = "grey") +
  scale_y_continuous(breaks = seq(0.5, 0.9, .1), limits = c(0.5, 0.9), expand = c(0, 0)) +
  labs(
    x = "Neuron",
    y = "G-ratio",
    title = "Comparison of G-ratio by Neuron",
    color = "Analyser"  # Adjusted the legend title
  ) +
  scale_color_manual(values = c("Baldvin" = "blue", "Sebastian" = "red")) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),  # Consistent text size
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Matching plot title size and style
    axis.title.x = element_text(size = 16, face = "bold"),  # Matching axis title sizes
    axis.title.y = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 15),  # Adjusting axis text sizes and rotation
    axis.text.y = element_text(size = 15),
    legend.title = element_text(size = 15, face = "bold")  # Adjusted legend title size
  )

# Print the adjusted plot
print(neuron_plot)

ggsave("Sebastian vs Baldvin/Gratio_results_Seb_vs_Bald_indiv_axon_w_line.png", bg = "transparent", dpi = 300, width = 6, height = 6)

# And now for axon diameter
axon_diameter_plot <- ggplot(raw_DATA, aes(x = neuron_number, y = axon_diameter, group = analyser, color = analyser)) +
  geom_point(position = position_dodge(width = 0.2)) +
  geom_line(aes(group = neuron_number), position = position_dodge(width = 0.2)) +
  geom_hline(yintercept = seq(0.5, 0.9, by = 0.05), linetype = "dashed", color = "grey") +
  scale_y_continuous(breaks = seq(0, 2500, 250), limits = c(0, 2500), expand = c(0, 0)) +
  labs(
    x = "Neuron",
    y = "Axon diameter (nm)",
    title = "Comparison of Axon diameter by Neuron",
    color = "Analyser"  # Set the legend title
  ) +
  scale_color_manual(values = c("Baldvin" = "blue", "Sebastian" = "red")) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),  # Consistent text size
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Matching plot title size and style
    axis.title.x = element_text(size = 16, face = "bold"),  # Matching axis title sizes
    axis.title.y = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 15),  # Adjusting axis text sizes and rotation
    axis.text.y = element_text(size = 15),
    legend.title = element_text(size = 15, face = "bold")  # Adjusted legend title size
  )

# Print the adjusted plot
print(axon_diameter_plot)


ggsave("Sebastian vs Baldvin/Axon_diameter_results_Seb_vs_Bald_indiv_axon_w_line.png", bg = "transparent", dpi = 300)


```

```{r}
# Now let's make a Bland-Altman plot. Why? A Bland-Altman plot (also known as a Differences vs. Averages plot) is a graphical method to compare two sets of measurements. It allows you to investigate the agreement between two different assays or measurements. It plots the difference between two measurements against the average of those measurements.

# First let's calculate the average and difference for the Bland-Altman plot
bland_altman_data <- raw_DATA %>%
  filter(analyser == "Baldvin") %>%
  rename(Baldvin_g_ratio = g_ratio) %>%
  left_join(raw_DATA %>% filter(analyser == "Sebastian") %>% rename(Sebastian_g_ratio = g_ratio), by = "neuron_number") %>%
  mutate(
    Average = (Baldvin_g_ratio + Sebastian_g_ratio) / 2,
    Difference = Baldvin_g_ratio - Sebastian_g_ratio,
    CenteredDifference = Difference - mean(Difference)  # Centering the differences around zero
  )

# Calculate new mean difference (which should be zero now) and limits of agreement
mean_diff <- mean(bland_altman_data$CenteredDifference)  # Should be zero or very close depending on floating-point precision
sd_diff <- sd(bland_altman_data$CenteredDifference)
lower_limit <- -0.011615  # New lower limit
upper_limit <- 0.011615  # New upper limit

# Create the Bland-Altman plot with centered differences
bland_altman_plot <- ggplot(bland_altman_data, aes(x = Average, y = CenteredDifference)) +
  geom_point() +
  geom_hline(yintercept = mean_diff, linetype = "dotted", color = "gray") +
  geom_hline(yintercept = lower_limit, linetype = "solid", color = "red") +
  geom_hline(yintercept = upper_limit, linetype = "solid", color = "red") +
  annotate("text", x = max(bland_altman_data$Average), y = upper_limit, 
           label = sprintf("Upper Limit: %.5f", upper_limit), hjust = 1, vjust = -1, 
           size = 4) +  # Adjusted size
  annotate("text", x = max(bland_altman_data$Average), y = lower_limit, 
           label = sprintf("Lower Limit: %.5f", lower_limit), hjust = 1, vjust = 1.5, 
           size = 4) +  # Adjusted size
  scale_y_continuous(limits = c(-0.2, 0.2), breaks = seq(-0.2, 0.2, by = 0.05)) +
  theme_minimal() +
  theme(
    axis.line = element_line(color = "black", size = 1),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),  # Adjusted size and style
    axis.title.x = element_text(size = 14, face = "bold"),  # Adjusted size and style
    axis.title.y = element_text(size = 14, face = "bold"),  # Adjusted size and style
    axis.text.x = element_text(size = 15, family = "Arial"),  # Adjusted size and font
    axis.text.y = element_text(size = 15, family = "Arial"),  # Adjusted size and font
    legend.position = "none",
    panel.grid.major.x = element_blank(), # Remove major vertical grid lines
    panel.grid.minor.x = element_blank(), # Remove minor vertical grid lines
    panel.grid.major.y = element_blank(), # Remove major horizontal grid lines
    panel.grid.minor.y = element_blank()  # Remove minor horizontal grid lines
  ) +
  labs(
    x = "Average of Baldvin and Sebastian's Measurements",
    y = "Centered Difference (Baldvin - Sebastian)",
    title = "G-ratio Difference Between Analyzers"
  )


# Print the adjusted plot
print(bland_altman_plot)


ggsave("Sebastian vs Baldvin/Bland_Altman_plot.png", bg="white", dpi = 300, height = 6, width = 6)
```

```{r}
#Extra code
#Lets try a Bland-Altman plot
#raw_DATA <- raw_DATA %>% 
  #group_by(neuron_number) %>% 
  #mutate(mean_g_ratio = mean(g_ratio), diff_g_ratio = diff(g_ratio)) %>%
  #ungroup()

#ggplot(raw_DATA, aes(x = mean_g_ratio, y = diff_g_ratio)) +
  #geom_point() +
  #geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  #labs(x = "Average G-ratio", y = "Difference in G-ratio", title = "Bland-Altman Plot") +
  #theme_minimal()
```

```{r}
# Now let's plot Baldvin and Sebastian's data side by side with lines between the corresponding axons (If there are many unique neurons, maybe it's a good idea to hide the legend)
ggplot(raw_DATA, aes(x = analyser, y = g_ratio, group = neuron_number)) +
  geom_point(aes(color = neuron_number), position = position_dodge(width = 0)) +  
  # Here I could use dodge to reduce overplotting (just change the width)
  geom_line(aes(group = neuron_number)) +  
  # Connects mine and Sebastian's measurements for each neuron
  theme_minimal() +
  labs(x = "", y = "G-ratio", title = "Paired G-ratio Measurements Comparison") +
  theme(legend.position = "none")  
  #If there are many unique neurons, maybe it's a good idea to hide the legend

# Now let's make it a little bit more understandable/readable
ggplot(raw_DATA, aes(x = analyser, y = g_ratio)) +
  geom_point(aes(color = factor(neuron_number)), position = position_dodge(width = 0.5)) +
  geom_line(aes(group = neuron_number), position = position_dodge(width = 0.5)) +
  theme_minimal() +
  labs(x = "Analyser", y = "G-ratio", title = "Paired G-ratio Measurements Comparison") +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5, face="bold"))  # Center the title)

ggsave("Sebastian vs Baldvin/Paired_gratio_measurements_comparison.png", bg = "white", dpi = 300)


# Calculate the total number of data points
total_points <- nrow(bland_altman_data)

# Calculate the number of points within the specified limits
points_within_limits <- sum(bland_altman_data$CenteredDifference >= lower_limit & bland_altman_data$CenteredDifference <= upper_limit)

# Calculate the number of points outside the specified limits
points_outside_limits <- total_points - points_within_limits

# Output the counts
cat("Total number of data points:", total_points, "\n")
cat("Number of points within the limits ±0.011615:", points_within_limits, "\n")
cat("Number of points outside the limits:", points_outside_limits, "\n")

# Calculate the percentage of points within the specified limits
within_limits <- bland_altman_data$CenteredDifference >= lower_limit & bland_altman_data$CenteredDifference <= upper_limit
percentage_within_limits <- mean(within_limits) * 100

# Output the percentage
print(paste("Percentage of points within the threshold ±0.011615:", round(percentage_within_limits, 2), "%"))

```

## Some code to be able to merge Sebastians tracings with mine so I can compare them directly

```{r}
# Split the data into two separate datasets for each analyser
data_Baldvin <- raw_DATA %>%
  filter(analyser == "Baldvin") %>%
  select(neuron_number, g_ratio, axon_diameter) %>%
  rename(Baldvin_g_ratio = g_ratio, Baldvin_axon_diameter = axon_diameter)

data_Sebastian <- raw_DATA %>%
  filter(analyser == "Sebastian") %>%
  select(neuron_number, g_ratio, axon_diameter) %>%
  rename(Sebastian_g_ratio = g_ratio, Sebastian_axon_diameter = axon_diameter)

# Join datasets by neuron_number
combined_data <- full_join(data_Baldvin, data_Sebastian, by = "neuron_number")

# Checking the combined dataset
print(combined_data)

my.formula_all <- y~x

# Assuming combined_data is prepared as previously described
combined_data_plot <- ggplot(combined_data, aes(x = Baldvin_g_ratio, y = Sebastian_g_ratio)) +
  geom_point(shape = 16, size = 5, alpha = 0.6) +  # Set point size and transparency
  geom_abline(slope = 1, intercept = 0, linetype = "dotted", color = "red", size = 1) +  # Add the y=x line in red
  scale_x_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1), expand = c(0, 0)) +
  scale_y_continuous(breaks = seq(0.2, 1, 0.1), limits = c(0.3, 1), expand = c(0, 0)) +
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +
  stat_poly_eq(formula = my.formula_all, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # adjust label.size for equation size
  labs(
    title = "Comparison of G-ratio Measurements",
    x = "Baldvin's G-ratio",
    y = "Sebastian's G-ratio"
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    legend.position = "none"
  )

# Print the adjusted plot
print(combined_data_plot)

ggsave("Sebastian vs Baldvin/Baldvin_vs_Sebastian_line_of_fit.png", bg = "white", dpi = 300, height = 6, width = 6)


# Calculate the absolute differences
combined_data$abs_diff_gratio <- abs(combined_data$Baldvin_g_ratio - combined_data$Sebastian_g_ratio)

# Compute the average of the absolute differences
average_abs_difference_new <- mean(combined_data$abs_diff_gratio)

# Display the result
print(paste("Average absolute G-ratio difference:", average_abs_difference_new))

```



# 2) Checking variability (Baldvin 10 axons traced 5 times)

## Settings

```{r}
# Lets start by reading the data from the files
# First we need to check the current working directory
getwd()

# Next, let's import the data from the files
files <- list.files(path = "Tracings to check variability", pattern = "Results[1-5]\\.txt", full.names = TRUE)
files

# Read each file, add a 'source' column, and an 'axon_number' column
data_list <- lapply(files, function(file, idx) {
  data <- read.table(file, header=TRUE, sep="\t", stringsAsFactors = FALSE)
  data$source <- idx
  data <- data %>% 
    mutate(axon_number = row_number()) # Assigning a sequential number to each axon
  return(data)
}, idx = 1:length(files))

# Now let's combine the data into a single data frame
variability_combined_data <- do.call(rbind, data_list)
```

## Statistics
```{r}
# Compute the statistics for each axon
variability_axon_stats <- variability_combined_data %>%
  group_by(axon_number) %>%
  summarise(
    Average_gRatio = mean(gratio),
    SD_gRatio = sd(gratio),
    Median_gRatio = median(gratio)
  )

# We find that the averages and means of the 10 axons are:
variability_axon_stats

# Let's compute the overall average and median standard deviation across all axons
variability_overall_stats <- summarise(variability_axon_stats, Avg_SD = mean(SD_gRatio), Median_SD = median(SD_gRatio))
variability_overall_stats

# So: From this we say that the maximum difference we will allow between the manual tracings and AI data is 0.01161462
```

## Graphs

```{r, warning=FALSE}
# Let's plot the average g-ratio for each axon with error bars
ggplot(variability_combined_data, aes(x=factor(axon_number), y=gratio)) +
  geom_boxplot(fill="lightgray", colour="black", alpha=0.5) +
  geom_point(position=position_jitter(width=0.1), alpha=0.6, color="blue") +
  labs(x="Axon Number", y="G-ratio", title="Combined Boxplot and Jittered Points of G-ratio by Axon") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))



# Calculate the difference from the average for each tracing
variability_combined_data <- variability_combined_data %>%
  group_by(axon_number) %>%
  mutate(diff_from_avg = gratio - mean(gratio))

# Calculate the standard deviation of the differences for each axon
sd_diff <- variability_combined_data %>%
  group_by(axon_number) %>%
  summarise(
    diff_from_avg = mean(gratio) - gratio,
    sd_diff = sd(diff_from_avg)
  )

# I want to add a value for the standard deviation onto one graph

# First I need to calculate the average standard deviation and mean from axon_stats
average_sd <- mean(sd_diff$sd_diff)

# Updated ggplot code with a white background and a y-axis line
ggplot(variability_combined_data, aes(x = factor(axon_number), y = diff_from_avg)) +
  geom_point(position = position_dodge(width = 0.75), color = "#4682B4", size=2.5) +
  geom_errorbar(data = sd_diff, aes(ymin = -sd_diff, ymax = sd_diff), width = 0.25, color = "black", size = 0.5) +
  labs(
    x = "Axon Number",
    y = "Δ g-ratio from Mean",
    title = "Axonal Variation in g-ratio",
    subtitle = "Error bars represent standard deviation from the mean"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 10),
    legend.position = "none",
    panel.background = element_rect(fill = "white", colour = "white"),
    axis.line = element_line(color = "black")
  ) +
  scale_x_discrete(breaks = variability_axon_stats$axon_number) +
  geom_segment(aes(x = 0, y = 0, xend = 0, yend = max(variability_combined_data$diff_from_avg)), 
               color = "black", size = 0.5) +
  guides(colour = guide_legend(title = "Axon")) +
  annotate("text", x = Inf, y = Inf, label = paste("Avg SD:", round(average_sd, 6)), 
           hjust = 1, vjust = 1, size = 5, color = "black", parse = FALSE)

# Save the final plot with a white background
ggsave("Tracings to check variability/gratio_variability_final_white_bg.png", width = 10, height = 8, dpi = 300, bg="white")

# Updated ggplot code with a white background and combined boxplot and points
ggplot(variability_combined_data, aes(x = factor(axon_number), y = diff_from_avg)) +
  geom_boxplot(aes(group = factor(axon_number)), fill = "grey80", color = "black", alpha = 0.5) +
  geom_point(position = position_dodge(width = 0.75), color = "#4682B4", size = 2.5) +
  geom_errorbar(data = sd_diff, aes(ymin = -sd_diff, ymax = sd_diff, group = factor(axon_number)), 
                width = 0.25, color = "black", size = 0.5) +
  labs(
    x = "Axon Number",
    y = "Δ g-ratio from Mean",
    title = "Axonal Variation in g-ratio",
    subtitle = "Boxplots and individual points show variation"
  ) +
  theme_minimal(base_size = 14) +
theme(
    axis.text.x = element_text(vjust = 1, hjust = 1),
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "none",
    panel.background = element_rect(fill = "white", colour = "white"),
    plot.background = element_rect(fill = "white", colour = "white"),
    panel.grid.major = element_blank(), # Remove major grid lines
    panel.grid.minor = element_blank(), # Remove minor grid lines
    axis.line = element_line(color = "black")
)  +
  scale_x_discrete(breaks = variability_axon_stats$axon_number) +
  annotate("text", x = Inf, y = Inf, label = paste("Avg SD:", round(average_sd, 6)), 
           hjust = 1, vjust = 1, size = 5, color = "black", parse = FALSE)


# Save the final plot with a white background and updated style
ggsave("Tracings to check variability/gratio_variability_final_dot_box.png", width = 6, height = 6, dpi = 300, bg = "white")
```


# 3) ADS data - (Image 61072 - Best original model) -> Testing original protocol best model on image 61072 (1 image from the original training dataset)

## Settings

```{r}
# Let's start by importing our data
morph_test_61072 <- read.table("Image61072/Morpho_test_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_61072 <- read.table("Image61072/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_test_61072$name = "test"
morph_man_61072$name = "manual"

# Let's combine the manual and test (auto) datasets together
joined_data_man_test_61072 = rbind(morph_man_61072, morph_test_61072)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_test_61072_selection = subset(joined_data_man_test_61072, axon_diam..um. >= 0.2)

# Let's do it for the manual and test datasets separately
morph_man_61072_selection = subset(morph_man_61072, axon_diam..um. >= 0.2)
morph_test_61072_selection = subset(morph_test_61072, axon_diam..um. >= 0.2)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61072) so:
# Exclude all rows where x0 (px) < 500 or x0 (px) > 3800
joined_data_man_test_61072_final = subset(joined_data_man_test_61072_selection, x0..px. >= 500 & x0..px. <= 3800 & y0..px. >= 275 & y0..px. <= 3600)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_61072_final = subset(morph_man_61072_selection, x0..px. >= 500 & x0..px. <= 3800 & y0..px. >= 275 & y0..px. <= 3600)
morph_test_61072_final = subset(morph_test_61072_selection, x0..px. >= 500 & x0..px. <= 3800 & y0..px. >= 275 & y0..px. <= 3600)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_test_61072 = difference_inner_join(morph_man_61072_final, morph_test_61072_final, by = c("x0..px.", "y0..px."), max_dist = 10 ) # Here we initially used a maximum distance of 10 pixels, this turned out to be too narrow, so we changed it to 100
```

## Statistics

```{r}
# First, let's check if the data follows a normal distribution using a Shapiro-Wilk Test for Normality
shapiro.test(joined_data_man_test_61072_final$gratio[joined_data_man_test_61072_final$name == "manual"])
shapiro.test(joined_data_man_test_61072_final$gratio[joined_data_man_test_61072_final$name == "test"])

# Okay, we see that for both we have a (p>0.05), which means we cannot reject the null-hypothesis and thus the data can be considered to follow a normal distribution, so we should perform a parametric test:

# Let's perform a paired t-test on my filtered data
t_test_result_61072 <- t.test(model_compare_man_test_61072$gratio.x, model_compare_man_test_61072$gratio.y, paired = TRUE)
t_test_result_61072

# We get a p-value of 0.02531. Since the p-value is less than 0.05, we reject the null hypothesis and say that there is a statistically significant difference between the two methods of measurement.

# Now we need to figure out the effect size
# First we calculate mean difference
mean_difference <- mean(model_compare_man_test_61072$gratio.x - model_compare_man_test_61072$gratio.y)

# Calculate standard deviation of differences
sd_difference <- sd(model_compare_man_test_61072$gratio.x - model_compare_man_test_61072$gratio.y)

# Calculate Cohen's d
effect_size <- mean_difference / sd_difference

# Display results
cat("Mean Difference:", mean_difference, "\n")
cat("Effect Size (Cohen's d):", effect_size, "\n")

# The mean difference we get is 0.01712859, this is higher than the maximum difference we concluded was acceptable from the variability comparison.


```

## Graphs

```{r}
# Let's compare the test model and manual tracings
ggplot(joined_data_man_test_61072_final, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 5, alpha = 0.6, position = position_jitter(width = .1)) +
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "test" = "ADS test model")) +
  scale_y_continuous(breaks = seq(0.5, 0.85, 0.05), limits = c(0.5, 0.85), expand = c(0, 0)) +
  scale_color_manual(values = c("manual" = "#00BFC4", "test" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of Ground Truth vs ADS test model",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  #scale_color_manual(aesthetics = "colour", 
   #                  breaks=c("OPALIN", "PDGFRA"), 
    #                 labels = c("Opalin-cre", "Pdgfra-cre"),
     #                values = c("#ba3c3c", "#9290d1") )  +
  #ylab("internodal length [um]") +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),  # Center the title
    axis.title.x = element_text(face = "bold"),  # Set x axis title in bold
    axis.title.y = element_text(face = "bold"),  # Set y axis title in bold
    #axis.line = element_line(size= 2, colour = graph_col),
    #axis.ticks.y = element_line(size = 2, colour = graph_col),
    #axis.ticks.x = element_blank(),
    #axis.ticks.length=unit(.5, "cm"),
    #axis.title=element_blank(),
    #axis.text= element_blank(),
    #legend.title = element_blank(),
    legend.position = "none"
    #legend.direction = "vertical",
    #legend.text = element_text(colour="black", size = 12)
  ) +
  geom_hline(yintercept = seq(0.5, 0.85, by = 0.05), linetype = "dashed", color = "gray")  # Add dashed lines

ggsave("Image61072/geom_point_gratio_man_vs_test_61072_dashed.png", bg = "white", dpi = 200)
```

```{r, warning=FALSE}
# Let's plot the gratio of the model against the gratio of the manual tracings

my.formula_61072 <- y~x



ggplot(model_compare_man_test_61072, aes(x = gratio.x, y = gratio.y)) +
  geom_point(shape = 16, size = 5, alpha = .6) +
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +
  stat_poly_eq(formula = my.formula_61072, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # adjust label.size for equation size
  scale_x_continuous(breaks = seq(0.5, 0.85, 0.1), limits = c(0.5, 0.85), expand = c(0, 0)) +
  scale_y_continuous(breaks = seq(0.5, 0.85, 0.1), limits = c(0.5, 0.85), expand = c(0, 0)) +
  labs(
    x = "G-ratio of the Ground Truth", # new x label
    y = "G-ratio of the Model" # new y label
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 20),
    axis.line = element_line(size = 2, colour = "black"),
    axis.ticks.y = element_line(size = 2, colour = "black"),
    axis.ticks.length = unit(.5, "cm"),
    axis.text = element_text(size = 18), # adjust size for axis text
    axis.title = element_text(size = 20, face = "bold"), # bold axis titles
    legend.position = "none",
    plot.caption = element_text(size = 16) # adjust size for caption (equation)
  )

ggsave("Image61072/model_vs_manual_line_of_fit.png", dpi = 200)

```

```{r}
# Let's create a violin graph to see the difference in distributions
ggplot(joined_data_man_test_61072_final, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +  # Adding a boxplot inside the violin for more detail
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
  theme_minimal() +
  scale_x_discrete(labels = c("Ground Truth", "ADS test model")) +
  scale_fill_manual(values = c(manual = "blue", test = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS test model")) +
  theme(legend.position = "none")
```

```{r}
# Lets add a variable that shows the gratio difference
# Assuming model_compare already contains the gratio values as gratio.x (manual) and gratio.y (auto)
model_compare_gratio_difference_61072 <- model_compare_man_test_61072 %>%
  mutate(diff_gratio = gratio.x - gratio.y,
         percent_diff_gratio = ((gratio.x - gratio.y) / gratio.y) * 100)

# Plotting percent differences
# First with gratio on x-axis
ggplot(model_compare_gratio_difference_61072, aes(x = gratio.x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Gratio",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_61072, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Then with axon diameter on x axis
ggplot(model_compare_gratio_difference_61072, aes(x = axon_diam..um..x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Axon diameter (um)",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_61072, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()


# Let's see how many points are within our limit
within_limit_count_61072 <- model_compare_gratio_difference_61072 %>%
  filter(abs(diff_gratio) <= 0.011615) %>%
  summarise(count = n())

total_points_61072 <- nrow(model_compare_gratio_difference_61072)

proportion_within_limit_61072 <- within_limit_count_61072 / total_points_61072

percentage_within_limit_61072 <- proportion_within_limit_61072 * 100

print(paste("Percentage of points within ±0.011615 limit:", round(percentage_within_limit_61072, 2), "%"))



# Do this with gratio and diameter on y axis
# Also, just raw difference, not just percent difference
```

# 4) ADS data - (Image 61073 - Best original model) -> Testing original protocol best model on image 61073 (1 image NOT from the original training dataset)

## Settings

```{r}
# Let's start by importing our data
morph_test_61073 <- read.table("Image61073/Morpho_test_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_61073 <- read.table("Image61073/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_test_61073$name = "test"
morph_man_61073$name = "manual"

# Let's combine the manual and test (auto) datasets together
joined_data_man_test_61073 = rbind(morph_man_61073, morph_test_61073)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_test_61073_selection = subset(joined_data_man_test_61073, axon_diam..um. >= 0.2)
joined_data_man_test_61073_selection = subset(joined_data_man_test_61073_selection, myelin_thickness..um. > 0.01)

# Let's do it for the manual and test datasets separately
morph_man_61073_selection = subset(morph_man_61073, axon_diam..um. >= 0.2)
morph_man_61073_selection = subset(morph_man_61073_selection, myelin_thickness..um. > 0.01)
morph_test_61073_selection = subset(morph_test_61073, axon_diam..um. >= 0.2)
morph_test_61073_selection = subset(morph_test_61073_selection, myelin_thickness..um. > 0.01)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61073) so:
# Exclude all rows where x0 (px) < 550 or x0 (px) > 3900 and y0 (px) < 250 or y0 (px) > 3650
joined_data_man_test_61073_final = subset(joined_data_man_test_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_61073_final = subset(morph_man_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)
morph_test_61073_final = subset(morph_test_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_test_61073 = difference_inner_join(morph_man_61073_final, morph_test_61073_final, by = c("x0..px.", "y0..px."), max_dist = 100 ) # Here we initially used a maximum distance of 10 pixels, this turned out to be too narrow, so we changed it to 100
```

## Statistics

```{r}
# First, let's check if the data follows a normal distribution using a Shapiro-Wilk Test for Normality
shapiro.test(joined_data_man_test_61073_final$gratio[joined_data_man_test_61073_final$name == "manual"])
shapiro.test(joined_data_man_test_61073_final$gratio[joined_data_man_test_61073_final$name == "test"])

# Okay, we see that for both we have a (p>0.05), which means we cannot reject the null-hypothesis and thus the data can be considered to follow a normal distribution, so we should perform a parametric test:

# Let's perform a paired t-test on my filtered data
t_test_result_61073 <- t.test(model_compare_man_test_61073$gratio.x, model_compare_man_test_61073$gratio.y, paired = TRUE)
t_test_result_61073

### CHANGE: We get a p-value of 0.7082. Since the p-value is greater than 0.05, we can't reject the null hypothesis and say that there is not a statistically significant difference between the two methods of measurement.

# Now we need to figure out the effect size
# First we calculate mean difference
mean_difference_61073 <- mean(model_compare_man_test_61073$gratio.x - model_compare_man_test_61073$gratio.y)

# Calculate standard deviation of differences
sd_difference_61073 <- sd(model_compare_man_test_61073$gratio.x - model_compare_man_test_61073$gratio.y)

# Calculate Cohen's d
effect_size_61073 <- mean_difference_61073 / sd_difference_61073

# Display results
cat("Mean Difference:", mean_difference_61073, "\n")
cat("Effect Size (Cohen's d):", effect_size_61073, "\n")

# The mean difference we get is X, this is higher than the maximum difference we concluded was acceptable from the variability comparison.

# Let's calculate the average of the absolute difference of g-ratios

# Calculate the absolute differences
model_compare_man_test_61073$abs_diff_gratio <- abs(model_compare_man_test_61073$gratio.x - model_compare_man_test_61073$gratio.y)

# Compute the average of the absolute differences
average_abs_difference_61073 <- mean(model_compare_man_test_61073$abs_diff_gratio)

# Display the result
print(paste("Average absolute G-ratio difference:", average_abs_difference_61073))


```

## Graphs

```{r}
# Let's compare the test model and manual tracings
joined_data_man_test_61073_final$name <- factor(joined_data_man_test_61073_final$name, levels = c("manual", "test"))

test_model_manual_graph <- ggplot(joined_data_man_test_61073_final, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 3, alpha = 0.5, position = position_jitter(width = .1)) +  # Match point size and alpha to other graphs
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "test" = "Best Model")) +  # Ensure labels are specific to test
  scale_y_continuous(breaks = seq(0.45, 0.95, 0.05), limits = c(0.45, 0.95), expand = c(0, 0)) +
  scale_color_manual(values = c("manual" = "#00BFC4", "test" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of ground truth vs best model",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15), # Match font size
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5), # Adjust title size and style
    axis.title.x = element_text(size = 16, face = "bold"), # Adjust axis title size and style
    axis.title.y = element_text(size = 16, face = "bold"), # Adjust axis title size and style
    axis.text.x = element_text(size = 15),  # Adjust axis text size
    axis.text.y = element_text(size = 15),  # Adjust axis text size
    legend.position = "none"
  ) #+
  #geom_hline(yintercept = seq(0.45, 0.95, by = 0.05), linetype = "dashed", color = "gray")  # Keep horizontal grid lines

# Add p-value annotation with updated position and text size
test_model_manual_graph <- test_model_manual_graph + annotate("text", x = 1.5, y = 0.925, label = sprintf("p = %.4f", t_test_result_61073$p.value), size = 6, color = "black")  # Match text size and color

# Print the updated plot
print(test_model_manual_graph)


ggsave("Image61073/geom_point_gratio_man_vs_test_61073_dashed.png", bg = "white", dpi = 200)

```

```{r, warning=FALSE}
# Let's plot the gratio of the model against the gratio of the manual tracings

my.formula_61073 <- y~x

# Update the graph to match the style of model_compare_man_model13_61073_updated
model_compare_man_test_61073_updated <- ggplot(model_compare_man_test_61073, aes(x = gratio.x, y = gratio.y)) +
  geom_point(shape = 16, size = 5, alpha = 0.6) +  # Match point size and transparency
  geom_abline(slope = 1, intercept = 0, linetype = "dotted", color = "red", size = 1) +  # Match the y=x line style
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +
  stat_poly_eq(formula = my.formula_61073, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # Adjust label size for equation
  scale_x_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1), expand = c(0, 0)) + # Match x-axis scale
  scale_y_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1), expand = c(0, 0)) + # Match y-axis scale
  labs(
    title = "Comparison of G-ratio Measurements",
    x = "G-ratio of the Ground Truth", # Update x label
    y = "G-ratio of the Best Model" # Update y label to be specific to this model
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    legend.position = "none"
  )

# Print the updated plot
print(model_compare_man_test_61073_updated)

ggsave("Image61073/model_vs_manual_line_of_fit.png", dpi = 200)
```

```{r}
# Let's create a violin graph to see the difference in distributions
ggplot(joined_data_man_test_61073_final, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +  # Adding a boxplot inside the violin for more detail
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
  theme_minimal() +
  scale_x_discrete(labels = c("Ground Truth", "ADS test model")) +
  scale_fill_manual(values = c(manual = "blue", test = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS test model")) +
  theme(legend.position = "none")
```


```{r}
# Lets add a variable that shows the gratio difference
# Assuming model_compare already contains the gratio values as gratio.x (manual) and gratio.y (auto)
model_compare_gratio_difference_61073 <- model_compare_man_test_61073 %>%
  mutate(diff_gratio = gratio.x - gratio.y,
         percent_diff_gratio = ((gratio.x - gratio.y) / gratio.y) * 100)

# Plotting percent differences
# First with gratio on x-axis
ggplot(model_compare_gratio_difference_61073, aes(x = gratio.x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Gratio",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_61073, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Then with axon diameter on x axis
ggplot(model_compare_gratio_difference_61073, aes(x = axon_diam..um..x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Axon diameter (um)",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_61073, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Let's see how many points are within our limit
within_limit_count_61073 <- model_compare_gratio_difference_61073 %>%
  filter(abs(diff_gratio) <= 0.011615) %>%
  summarise(count = n())

total_points_61073 <- nrow(model_compare_gratio_difference_61073)

proportion_within_limit_61073 <- within_limit_count_61073 / total_points_61073

percentage_within_limit_61073 <- proportion_within_limit_61073 * 100

print(paste("Percentage of points within ±0.011615 limit:", round(percentage_within_limit_61073, 2), "%"))

# Do this with gratio and diameter on y axis
# Also, just raw difference, not just percent difference
```
# 5) ADS data - (Image 414 - Best new model) -> Testing new protocol best model on image 414 (1 image from the new training dataset)

## Settings

```{r}
# Let's start by importing our data
morph_test_414 <- read.table("Image414/Morpho_test_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_414 <- read.table("Image414/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_test_414$name = "test"
morph_man_414$name = "manual"

# Let's combine the manual and test (auto) datasets together
joined_data_man_test_414 = rbind(morph_man_414, morph_test_414)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_test_414_selection = subset(joined_data_man_test_414, axon_diam..um. >= 0.2)

# Let's do it for the manual and test datasets separately
morph_man_414_selection = subset(morph_man_414, axon_diam..um. >= 0.2)
morph_test_414_selection = subset(morph_test_414, axon_diam..um. >= 0.2)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 414) so:
# Exclude all rows where x0 (px) < 325 or x0 (px) > 3800 and y0 (px) < 400 or y0 (px) > 3700
joined_data_man_test_414_final = subset(joined_data_man_test_414_selection, x0..px. >= 325 & x0..px. <= 3800 & y0..px. >= 400 & y0..px. <= 3700)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_414_final = subset(morph_man_414_selection, x0..px. >= 325 & x0..px. <= 3800 & y0..px. >= 400 & y0..px. <= 3700)
morph_test_414_final = subset(morph_test_414_selection, x0..px. >= 325 & x0..px. <= 3800 & y0..px. >= 400 & y0..px. <= 3700)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_test_414 = difference_inner_join(morph_man_414_final, morph_test_414_final, by = c("x0..px.", "y0..px."), max_dist = 10 ) # Here we initially used a maximum distance of 10 pixels, this turned out to be too narrow, so we changed it to 100
```

## Statistics

```{r}
# First, let's check if the data follows a normal distribution using a Shapiro-Wilk Test for Normality
shapiro.test(joined_data_man_test_414_final$gratio[joined_data_man_test_414_final$name == "manual"])
shapiro.test(joined_data_man_test_414_final$gratio[joined_data_man_test_414_final$name == "test"])

# Okay, we see that for both we have a (p>0.05), which means we cannot reject the null-hypothesis and thus the data can be considered to follow a normal distribution, so we should perform a parametric test:

# Let's perform a paired t-test on my filtered data
t_test_result_414 <- t.test(model_compare_man_test_414$gratio.x, model_compare_man_test_414$gratio.y, paired = TRUE)
t_test_result_414

### CHANGE: We get a p-value of 0.7082. Since the p-value is greater than 0.05, we can't reject the null hypothesis and say that there is not a statistically significant difference between the two methods of measurement.

# Now we need to figure out the effect size
# First we calculate mean difference
mean_difference_414 <- mean(model_compare_man_test_414$gratio.x - model_compare_man_test_414$gratio.y)

# Calculate standard deviation of differences
sd_difference_414 <- sd(model_compare_man_test_414$gratio.x - model_compare_man_test_414$gratio.y)

# Calculate Cohen's d
effect_size_414 <- mean_difference_414 / sd_difference_414

# Display results
cat("Mean Difference:", mean_difference_414, "\n")
cat("Effect Size (Cohen's d):", effect_size_414, "\n")

# The mean difference we get is X, this is higher than the maximum difference we concluded was acceptable from the variability comparison.


```

## Graphs

```{r}
# Let's compare the test model and manual tracings
ggplot(joined_data_man_test_414_final, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 5, alpha = 0.6, position = position_jitter(width = .1)) +
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "test" = "ADS test model")) +
  scale_y_continuous(breaks = seq(0.5, 0.85, 0.05), limits = c(0.5, 0.85), expand = c(0, 0)) +
  scale_color_manual(values = c("manual" = "#00BFC4", "test" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of Ground Truth vs ADS test model",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  #scale_color_manual(aesthetics = "colour", 
   #                  breaks=c("OPALIN", "PDGFRA"), 
    #                 labels = c("Opalin-cre", "Pdgfra-cre"),
     #                values = c("#ba3c3c", "#9290d1") )  +
  #ylab("internodal length [um]") +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),  # Center the title
    axis.title.x = element_text(face = "bold"),  # Set x axis title in bold
    axis.title.y = element_text(face = "bold"),  # Set y axis title in bold
    #axis.line = element_line(size= 2, colour = graph_col),
    #axis.ticks.y = element_line(size = 2, colour = graph_col),
    #axis.ticks.x = element_blank(),
    #axis.ticks.length=unit(.5, "cm"),
    #axis.title=element_blank(),
    #axis.text= element_blank(),
    #legend.title = element_blank(),
    legend.position = "none"
    #legend.direction = "vertical",
    #legend.text = element_text(colour="black", size = 12)
  ) +
  geom_hline(yintercept = seq(0.5, 0.85, by = 0.05), linetype = "dashed", color = "gray")  # Add dashed lines

ggsave("Image414/geom_point_gratio_man_vs_test_414_dashed.png", bg = "white", dpi = 200)
```

```{r, warning=FALSE}
# Let's plot the gratio of the model against the gratio of the manual tracings

my.formula_414 <- y~x

ggplot(model_compare_man_test_414, aes(x = gratio.x, y = gratio.y)) +
  geom_point(shape = 16, size = 5, alpha = .6) +
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +
  stat_poly_eq(formula = my.formula_414, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # adjust label.size for equation size
  scale_x_continuous(breaks = seq(0.5, 0.85, 0.1), limits = c(0.5, 0.85), expand = c(0, 0)) +
  scale_y_continuous(breaks = seq(0.5, 0.85, 0.1), limits = c(0.5, 0.85), expand = c(0, 0)) +
  labs(
    x = "G-ratio of the Ground Truth", # new x label
    y = "G-ratio of the Model" # new y label
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 20),
    axis.line = element_line(size = 2, colour = "black"),
    axis.ticks.y = element_line(size = 2, colour = "black"),
    axis.ticks.length = unit(.5, "cm"),
    axis.text = element_text(size = 18), # adjust size for axis text
    axis.title = element_text(size = 20, face = "bold"), # bold axis titles
    legend.position = "none",
    plot.caption = element_text(size = 16) # adjust size for caption (equation)
  )

ggsave("Image414/model_vs_manual_line_of_fit.png", dpi = 200)

```

```{r}
# Let's create a violin graph to see the difference in distributions
ggplot(joined_data_man_test_414_final, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +  # Adding a boxplot inside the violin for more detail
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
  theme_minimal() +
  scale_x_discrete(labels = c("Ground Truth", "ADS test model")) +
  scale_fill_manual(values = c(manual = "blue", test = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS test model")) +
  theme(legend.position = "none")
```

```{r}
# Lets add a variable that shows the gratio difference
# Assuming model_compare already contains the gratio values as gratio.x (manual) and gratio.y (auto)
model_compare_gratio_difference_414 <- model_compare_man_test_414 %>%
  mutate(diff_gratio = gratio.x - gratio.y,
         percent_diff_gratio = ((gratio.x - gratio.y) / gratio.y) * 100)

# Plotting percent differences
# First with gratio on x-axis
ggplot(model_compare_gratio_difference_414, aes(x = gratio.x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Gratio",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_414, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Then with axon diameter on x axis
ggplot(model_compare_gratio_difference_414, aes(x = axon_diam..um..x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Axon diameter (um)",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_414, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Let's see how many points are within our limit
within_limit_count_414 <- model_compare_gratio_difference_414 %>%
  filter(abs(diff_gratio) <= 0.011615) %>%
  summarise(count = n())

total_points_414 <- nrow(model_compare_gratio_difference_414)

proportion_within_limit_414 <- within_limit_count_414 / total_points_414

percentage_within_limit_414 <- proportion_within_limit_414 * 100

print(paste("Percentage of points within ±0.011615 limit:", round(percentage_within_limit_414, 2), "%"))

# Do this with gratio and diameter on y axis
# Also, just raw difference, not just percent difference
```

# 6) ADS data - (Image 434 - Best new model) -> Testing new protocol best model on image 434 (1 image NOT from the new training dataset)

## Settings

```{r}
# Let's start by importing our data
morph_test_434 <- read.table("Image434/Morpho_test_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_434 <- read.table("Image434/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_test_434$name = "test"
morph_man_434$name = "manual"

# Let's combine the manual and test (auto) datasets together
joined_data_man_test_434 = rbind(morph_man_434, morph_test_434)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_test_434_selection = subset(joined_data_man_test_434, axon_diam..um. >= 0.2)

# Let's do it for the manual and test datasets separately
morph_man_434_selection = subset(morph_man_434, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)
morph_test_434_selection = subset(morph_test_434, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 434) so:
# Exclude all rows where x0 (px) < 250 or x0 (px) > 3750 and y0 (px) < 300 or y0 (px) > 3500
joined_data_man_test_434_final = subset(joined_data_man_test_434_selection, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 300 & y0..px. <= 3500)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 250-3750 and y0 (px) is outside 300-3500
morph_man_434_final = subset(morph_man_434_selection, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 300 & y0..px. <= 3500)
morph_test_434_final = subset(morph_test_434_selection, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 300 & y0..px. <= 3500)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_test_434 = difference_inner_join(morph_man_434_final, morph_test_434_final, by = c("x0..px.", "y0..px."), max_dist = 100 ) # Here we initially used a maximum distance of 10 pixels, this turned out to be too narrow, so we changed it to 100
```

## Statistics

```{r}
# First, let's check if the data follows a normal distribution using a Shapiro-Wilk Test for Normality
shapiro.test(joined_data_man_test_434_final$gratio[joined_data_man_test_434_final$name == "manual"])
shapiro.test(joined_data_man_test_434_final$gratio[joined_data_man_test_434_final$name == "test"])

# Okay, we see that for both we have a (p>0.05), which means we cannot reject the null-hypothesis and thus the data can be considered to follow a normal distribution, so we should perform a parametric test:

# One of the datasets 'test' does not follow a normal distribution, so we should use a non-parametric test such as a wilcoxon rank sum test
wilcox_result <- wilcox.test(gratio ~ name, data = joined_data_man_test_434_final)
wilcox_result

# Let's perform a paired t-test on my filtered data
#t_test_result_434 <- t.test(model_compare_man_test_434$gratio.x, model_compare_man_test_434$gratio.y, paired = TRUE)
#t_test_result_434

### CHANGE: We get a p-value of 0.7082. Since the p-value is greater than 0.05, we can't reject the null hypothesis and say that there is not a statistically significant difference between the two methods of measurement.

# Now we need to figure out the effect size
# First we calculate mean difference
mean_difference_434 <- mean(model_compare_man_test_434$gratio.x - model_compare_man_test_434$gratio.y)

# Calculate standard deviation of differences
sd_difference_434 <- sd(model_compare_man_test_434$gratio.x - model_compare_man_test_434$gratio.y)

# Calculate Cohen's d
effect_size_434 <- mean_difference_434 / sd_difference_434

# Display results
cat("Mean Difference:", mean_difference_434, "\n")
cat("Effect Size (Cohen's d):", effect_size_434, "\n")

# The mean difference we get is X, this is higher than the maximum difference we concluded was acceptable from the variability comparison.


# Let's calculate the average of the absolute difference of g-ratios

# Calculate the absolute differences
model_compare_man_test_434$abs_diff_gratio <- abs(model_compare_man_test_434$gratio.x - model_compare_man_test_434$gratio.y)

# Compute the average of the absolute differences
average_abs_difference_434 <- mean(model_compare_man_test_434$abs_diff_gratio)

# Display the result
print(paste("Average absolute G-ratio difference:", average_abs_difference_434))

```

## Graphs

```{r}
# Let's compare the test model and manual tracings
ggplot(joined_data_man_test_434_final, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 5, alpha = 0.6, position = position_jitter(width = .1)) +
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "test" = "ADS test model")) +
  scale_y_continuous(breaks = seq(0.5, 0.85, 0.05), limits = c(0.5, 0.85), expand = c(0, 0)) +
  scale_color_manual(values = c("manual" = "#00BFC4", "test" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of Ground Truth vs ADS test model",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  #scale_color_manual(aesthetics = "colour", 
   #                  breaks=c("OPALIN", "PDGFRA"), 
    #                 labels = c("Opalin-cre", "Pdgfra-cre"),
     #                values = c("#ba3c3c", "#9290d1") )  +
  #ylab("internodal length [um]") +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),  # Center the title
    axis.title.x = element_text(face = "bold"),  # Set x axis title in bold
    axis.title.y = element_text(face = "bold"),  # Set y axis title in bold
    #axis.line = element_line(size= 2, colour = graph_col),
    #axis.ticks.y = element_line(size = 2, colour = graph_col),
    #axis.ticks.x = element_blank(),
    #axis.ticks.length=unit(.5, "cm"),
    #axis.title=element_blank(),
    #axis.text= element_blank(),
    #legend.title = element_blank(),
    legend.position = "none"
    #legend.direction = "vertical",
    #legend.text = element_text(colour="black", size = 12)
  ) +
  geom_hline(yintercept = seq(0.5, 0.85, by = 0.05), linetype = "dashed", color = "gray")  # Add dashed lines

ggsave("Image434/geom_point_gratio_man_vs_test_434_dashed.png", bg = "white", dpi = 200)
```

```{r, warning=FALSE}
# Let's plot the gratio of the model against the gratio of the manual tracings

my.formula_434 <- y~x

ggplot(model_compare_man_test_434, aes(x = gratio.x, y = gratio.y)) +
  geom_point(shape = 16, size = 5, alpha = .6) +
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +
  stat_poly_eq(formula = my.formula_414, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # adjust label.size for equation size
  scale_x_continuous(breaks = seq(0.5, 0.85, 0.1), limits = c(0.5, 0.85), expand = c(0, 0)) +
  scale_y_continuous(breaks = seq(0.5, 0.85, 0.1), limits = c(0.5, 0.85), expand = c(0, 0)) +
  labs(
    x = "G-ratio of the Ground Truth", # new x label
    y = "G-ratio of the Model" # new y label
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 20),
    axis.line = element_line(size = 2, colour = "black"),
    axis.ticks.y = element_line(size = 2, colour = "black"),
    axis.ticks.length = unit(.5, "cm"),
    axis.text = element_text(size = 18), # adjust size for axis text
    axis.title = element_text(size = 20, face = "bold"), # bold axis titles
    legend.position = "none",
    plot.caption = element_text(size = 16) # adjust size for caption (equation)
  )

ggsave("Image434/model_vs_manual_line_of_fit.png", dpi = 200)

```

```{r}
# Let's create a violin graph to see the difference in distributions
ggplot(joined_data_man_test_434_final, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +  # Adding a boxplot inside the violin for more detail
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
  theme_minimal() +
  scale_x_discrete(labels = c("Ground Truth", "ADS test model")) +
  scale_fill_manual(values = c(manual = "blue", test = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS test model")) +
  theme(legend.position = "none")
```

```{r}
# Lets add a variable that shows the gratio difference
# Assuming model_compare already contains the gratio values as gratio.x (manual) and gratio.y (auto)
model_compare_gratio_difference_434 <- model_compare_man_test_434 %>%
  mutate(diff_gratio = gratio.x - gratio.y,
         percent_diff_gratio = ((gratio.x - gratio.y) / gratio.y) * 100)

# Plotting percent differences
# First with gratio on x-axis
ggplot(model_compare_gratio_difference_434, aes(x = gratio.x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Gratio",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_434, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Then with axon diameter on x axis
ggplot(model_compare_gratio_difference_434, aes(x = axon_diam..um..x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Axon diameter (um)",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_434, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Let's see how many points are within our limit
within_limit_count_434 <- model_compare_gratio_difference_434 %>%
  filter(abs(diff_gratio) <= 0.011615) %>%
  summarise(count = n())

total_points_434 <- nrow(model_compare_gratio_difference_434)

proportion_within_limit_434 <- within_limit_count_434 / total_points_434

percentage_within_limit_434 <- proportion_within_limit_434 * 100

print(paste("Percentage of points within ±0.011615 limit:", round(percentage_within_limit_434, 2), "%"))


# Do this with gratio and diameter on y axis
# Also, just raw difference, not just percent difference
```

# 7) ADS data - (All images - best original model) -> Testing original protocol best model on the 10 training images from the original protocol

## Settings

```{r}
# Let's import the 'test' dataset
morph_test_all_1 <- read.table("Original_protocol_all_images/Morpho_test_1.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_2 <- read.table("Original_protocol_all_images/Morpho_test_2.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_3 <- read.table("Original_protocol_all_images/Morpho_test_3.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_4 <- read.table("Original_protocol_all_images/Morpho_test_4.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_5 <- read.table("Original_protocol_all_images/Morpho_test_5.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_6 <- read.table("Original_protocol_all_images/Morpho_test_6.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_7 <- read.table("Original_protocol_all_images/Morpho_test_7.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_8 <- read.table("Original_protocol_all_images/Morpho_test_8.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_9 <- read.table("Original_protocol_all_images/Morpho_test_9.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_10 <- read.table("Original_protocol_all_images/Morpho_test_10.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's remove all edge axons
## I've found that 600<y<3400 and 200<x<4000 cut out all the edge axons and leave in all the whole axons in image 2336
## I've found that 150<y<3670 and 400<x<4000 cut out all the edge axons and leave in all the whole axons in image 4090
## I've found that 300<y<3200 and 200<x<3700 cut out all the edge axons and leave in all the whole axons in image 5087
## I've found that 700<y<3750 and 450<x<3800 cut out all the edge axons and leave in all the whole axons in image 5767
## I've found that 300<y<3800 and 200<x<3700 cut out all the edge axons and leave in all the whole axons in image 61071
## I've found that 500<y<3800 and 275<x<3600 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 200<y<3650 and 400<x<3700 cut out all the edge axons and leave in all the whole axons in image 80021
## I've found that 500<y<3700 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 80022
## I've found that 500<y<3575 and 775<x<3800 cut out all the edge axons and leave in all the whole axons in image 8969
## I've found that 250<y<3900 and 250<x<3500 cut out all the edge axons and leave in all the whole axons in image 9867

morph_test_all_1_select = subset(morph_test_all_1, x0..px. >= 200 & x0..px. <= 4000 & y0..px. >= 600 & y0..px. <= 3400)
morph_test_all_2_select = subset(morph_test_all_2, x0..px. >= 400 & x0..px. <= 4000 & y0..px. >= 150 & y0..px. <= 3670)
morph_test_all_3_select = subset(morph_test_all_3, x0..px. >= 200 & x0..px. <= 3700 & y0..px. >= 300 & y0..px. <= 3200)
morph_test_all_4_select = subset(morph_test_all_4, x0..px. >= 450 & x0..px. <= 3800 & y0..px. >= 700 & y0..px. <= 3750)
morph_test_all_5_select = subset(morph_test_all_5, x0..px. >= 200 & x0..px. <= 3700 & y0..px. >= 300 & y0..px. <= 3800)
morph_test_all_6_select = subset(morph_test_all_6, x0..px. >= 275 & x0..px. <= 3600 & y0..px. >= 500 & y0..px. <= 3800)
morph_test_all_7_select = subset(morph_test_all_7, x0..px. >= 400 & x0..px. <= 3700 & y0..px. >= 200 & y0..px. <= 3650)
morph_test_all_8_select = subset(morph_test_all_8, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 500 & y0..px. <= 3700)
morph_test_all_9_select = subset(morph_test_all_9, x0..px. >= 725 & x0..px. <= 3800 & y0..px. >= 500 & y0..px. <= 3575)
morph_test_all_10_select = subset(morph_test_all_10, x0..px. >= 250 & x0..px. <= 3500 & y0..px. >= 250 & y0..px. <= 3900)


# Let's combine them all into one dataset
morph_test_all = rbind(morph_test_all_1_select, morph_test_all_2_select, morph_test_all_3_select, morph_test_all_4_select,
                       morph_test_all_5_select, morph_test_all_6_select, morph_test_all_7_select, morph_test_all_8_select,
                       morph_test_all_9_select, morph_test_all_10_select)

# Let's see combine all the unfiltered ones into one dataset (not necessary, just what we did when we were trying to figure out the data)
morph_test_all_original = rbind(morph_test_all_1, morph_test_all_2, morph_test_all_3, morph_test_all_4,
                       morph_test_all_5, morph_test_all_6, morph_test_all_7, morph_test_all_8,
                       morph_test_all_9, morph_test_all_10)

nrow(morph_test_all)
nrow(morph_test_all_original)

write.table(morph_test_all, file = "morph_test_all.csv", sep = "\t", row.names = F)

# Let's add a name tag
morph_test_all$name = "test"

# Let's import the 'manual' dataset
morph_manual_all_1 <- read.table("Original_protocol_all_images/Morpho_manual_1.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_2 <- read.table("Original_protocol_all_images/Morpho_manual_2.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_3 <- read.table("Original_protocol_all_images/Morpho_manual_3.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_4 <- read.table("Original_protocol_all_images/Morpho_manual_4.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_5 <- read.table("Original_protocol_all_images/Morpho_manual_5.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_6 <- read.table("Original_protocol_all_images/Morpho_manual_6.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_7 <- read.table("Original_protocol_all_images/Morpho_manual_7.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_8 <- read.table("Original_protocol_all_images/Morpho_manual_8.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_9 <- read.table("Original_protocol_all_images/Morpho_manual_9.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_10 <- read.table("Original_protocol_all_images/Morpho_manual_10.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's remove all edge axons
## I've found that 600<y<3400 and 200<x<4000 cut out all the edge axons and leave in all the whole axons in image 2336
## I've found that 150<y<3670 and 400<x<4000 cut out all the edge axons and leave in all the whole axons in image 4090
## I've found that 300<y<3200 and 200<x<3700 cut out all the edge axons and leave in all the whole axons in image 5087
## I've found that 700<y<3750 and 450<x<3800 cut out all the edge axons and leave in all the whole axons in image 5767
## I've found that 300<y<3800 and 200<x<3700 cut out all the edge axons and leave in all the whole axons in image 61071
## I've found that 500<y<3800 and 275<x<3600 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 200<y<3650 and 400<x<3700 cut out all the edge axons and leave in all the whole axons in image 80021
## I've found that 500<y<3700 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 80022
## I've found that 500<y<3575 and 775<x<3800 cut out all the edge axons and leave in all the whole axons in image 8969
## I've found that 250<y<3900 and 250<x<3500 cut out all the edge axons and leave in all the whole axons in image 9867

morph_manual_all_1_select = subset(morph_manual_all_1, x0..px. >= 200 & x0..px. <= 4000 & y0..px. >= 600 & y0..px. <= 3400)
morph_manual_all_2_select = subset(morph_manual_all_2, x0..px. >= 400 & x0..px. <= 4000 & y0..px. >= 150 & y0..px. <= 3670)
morph_manual_all_3_select = subset(morph_manual_all_3, x0..px. >= 200 & x0..px. <= 3700 & y0..px. >= 300 & y0..px. <= 3200)
morph_manual_all_4_select = subset(morph_manual_all_4, x0..px. >= 450 & x0..px. <= 3800 & y0..px. >= 700 & y0..px. <= 3750)
morph_manual_all_5_select = subset(morph_manual_all_5, x0..px. >= 200 & x0..px. <= 3700 & y0..px. >= 300 & y0..px. <= 3800)
morph_manual_all_6_select = subset(morph_manual_all_6, x0..px. >= 275 & x0..px. <= 3600 & y0..px. >= 500 & y0..px. <= 3800)
morph_manual_all_7_select = subset(morph_manual_all_7, x0..px. >= 400 & x0..px. <= 3700 & y0..px. >= 200 & y0..px. <= 3650)
morph_manual_all_8_select = subset(morph_manual_all_8, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 500 & y0..px. <= 3700)
morph_manual_all_9_select = subset(morph_manual_all_9, x0..px. >= 725 & x0..px. <= 3800 & y0..px. >= 500 & y0..px. <= 3575)
morph_manual_all_10_select = subset(morph_manual_all_10, x0..px. >= 250 & x0..px. <= 3500 & y0..px. >= 250 & y0..px. <= 3900)


# Let's combine them all into one dataset
morph_manual_all = rbind(morph_manual_all_1_select, morph_manual_all_2_select, morph_manual_all_3_select, morph_manual_all_4_select,
                         morph_manual_all_5_select, morph_manual_all_6_select, morph_manual_all_7_select, morph_manual_all_8_select,
                         morph_manual_all_9_select, morph_manual_all_10_select)

morph_manual_all_original = rbind(morph_manual_all_1, morph_manual_all_2, morph_manual_all_3, morph_manual_all_4,
                         morph_manual_all_5, morph_manual_all_6, morph_manual_all_7, morph_manual_all_8,
                         morph_manual_all_9, morph_manual_all_10)

nrow(morph_manual_all)
nrow(morph_manual_all_original)

write.table(morph_manual_all, file = "morph_manual_all.csv", sep = "\t", row.names = F)

# Let's add a name tag
morph_manual_all$name = "manual"

# Let's combine the test and manual dataset together
joined_data_man_test_all= rbind(morph_test_all, morph_manual_all)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts.
joined_data_man_test_all_final = subset(joined_data_man_test_all, axon_diam..um. >= 0.2)

# Let's remove all non-myelinated axons
joined_data_man_test_all_final = subset(joined_data_man_test_all_final, myelin_thickness..um. > 0.01)

# Let's do it for the manual and test datasets separately
morph_manual_all_final = subset(morph_manual_all, axon_diam..um. >= 0.2)
morph_manual_all_final = subset(morph_manual_all, myelin_thickness..um. > 0.01)
morph_test_all_final = subset(morph_test_all, axon_diam..um. >= 0.2)
morph_test_all_final = subset(morph_test_all, myelin_thickness..um. > 0.01)


# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
# model_compare_man_test_all = difference_inner_join(morph_manual_all_final, morph_test_all_final, by = c("x0..px.", "y0..px."), max_dist = 10 ) # Here we initially used a maximum distance of 10 pixels, this turned out to be too narrow, so we changed it to 100
# IMPORTANT: We found out that if we do this, we are comparing many pictures to each other, so a centroid from one image might be attached to a centroid of an axon in another image, so we need to use fuzzyjoin on all the images separately (see what we did with the x1-10 etc.)

# write.table(model_compare_man_test_all, file = "data.csv", sep = "\t", row.names = F)


x1 = difference_inner_join(morph_manual_all_1_select, morph_test_all_1_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
x2 = difference_inner_join(morph_manual_all_2_select, morph_test_all_2_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
x3 = difference_inner_join(morph_manual_all_3_select, morph_test_all_3_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
x4 = difference_inner_join(morph_manual_all_4_select, morph_test_all_4_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
x5 = difference_inner_join(morph_manual_all_5_select, morph_test_all_5_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
x6 = difference_inner_join(morph_manual_all_6_select, morph_test_all_6_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
x7 = difference_inner_join(morph_manual_all_7_select, morph_test_all_7_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
x8 = difference_inner_join(morph_manual_all_8_select, morph_test_all_8_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
x9 = difference_inner_join(morph_manual_all_9_select, morph_test_all_9_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
x10 = difference_inner_join(morph_manual_all_10_select, morph_test_all_10_select, by = c("x0..px.", "y0..px."), max_dist = 100 )

joined_x = rbind(x1, x2, x3, x4, x5, x6, x7, x8, x9, x10)

joined_x_final = subset(joined_x, axon_diam..um..x >= 0.2, myelin_thickness..um..x > 0.01)
joined_x_final_final = subset(joined_x_final, axon_diam..um..y >= 0.2)
joined_x_final_final = subset(joined_x_final_final, myelin_thickness..um..y > 0.01)

# Now I need to remove all the rows with NaN values (only two, most likely unmyelinated axons and/or artefacts in the ADS image, but it's easy to filter those out, and they do keep me from getting my data so I think it's alright)

joined_x_final_final <- na.omit(joined_x_final_final)

# IMPORTANT: look at myelin area -> need to remove the unmyelinates axons!

```

## Statistics

```{r}
# First, let's check if the data follows a normal distribution using a Shapiro-Wilk Test for Normality
shapiro.test(joined_data_man_test_all_final$gratio[joined_data_man_test_all_final$name == "manual"])
shapiro.test(joined_data_man_test_all_final$gratio[joined_data_man_test_all_final$name == "test"])

# Okay, we see that for both we have a (p<0.05), which means we cannot reject the null-hypothesis and thus the data can NOT be considered to follow a normal distribution, so we should perform a non-parametric test:


# Perform the Wilcoxon signed-rank test
#wilcox_test_result <- wilcox.test(joined_x_final_final$gratio.x, joined_x_final_final$gratio.y, paired = TRUE)

# Print the test result
#print(wilcox_test_result)


### We get a p-value of 0.0004389. Since the p-value is lower than 0.05, we reject the null hypothesis and say that there is a statistically significant difference between the two methods of measurement.

# Won't use here! Let's perform a paired t-test on my filtered data
t_test_result_all <- t.test(joined_x_final_final$gratio.x, joined_x_final_final$gratio.y, paired = FALSE)
t_test_result_all



# Now we need to figure out the effect size
# First we calculate mean difference
mean_difference_all <- mean(joined_x_final_final$gratio.x - joined_x_final_final$gratio.y)

# Calculate standard deviation of differences
sd_difference_all <- sd(joined_x_final_final$gratio.x - joined_x_final_final$gratio.y)

# Calculate Cohen's d
effect_size_all <- mean_difference_all / sd_difference_all

# Display results
cat("Mean Difference:", mean_difference_all, "\n")
cat("Effect Size (Cohen's d):", effect_size_all, "\n")

# The mean difference we get is X, this is higher than the maximum difference we concluded was acceptable from the variability comparison.


# Let's calculate the average of the absolute difference of g-ratios

# Calculate the absolute differences
joined_x_final_final$abs_diff_gratio <- abs(joined_x_final_final$gratio.x - joined_x_final_final$gratio.y)

# Compute the average of the absolute differences
average_abs_difference <- mean(joined_x_final_final$abs_diff_gratio)

# Display the result
print(paste("Average absolute G-ratio difference:", average_abs_difference))

a <- mean(joined_data_man_test_all_final$gratio[joined_data_man_test_all_final$name=="test"])
b <- mean(joined_data_man_test_all_final$gratio[joined_data_man_test_all_final$name=="manual"])
b-a

c <- mean(joined_data_man_test_all_new_final$gratio[joined_data_man_test_all_new_final$name=="test"])
d <- mean(joined_data_man_test_all_new_final$gratio[joined_data_man_test_all_new_final$name=="manual"])
d-c

e <- mean(joined_data_man_default_all_final$gratio[joined_data_man_default_all_final$name=="default"])
f <- mean(joined_data_man_default_all_final$gratio[joined_data_man_default_all_final$name=="manual"])
f-e
```

## Graphs

```{r}
# Let's compare the test model and manual tracings

# Example data setup (ensure this reflects your actual data structure)
# joined_data_man_test_all_final <- data.frame(
#   name = c("Ground Truth", "ADS test model", "Ground Truth", "ADS test model"),
#   gratio = c(0.6, 0.62, 0.7, 0.67)
# )

# Define ymax carefully to place text above the highest point of your data
# ymax <- max(joined_data_man_test_all_final$gratio, na.rm = TRUE) * 1.1

formatted_p_value <- ifelse(t_test_result_all$p.value < 0.0001, "p < 0.0001", sprintf("p = %.4f", t_test_result_all$p.value))

test_all_manual_graph <- ggplot(joined_data_man_test_all_final, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 3, alpha = 0.3, position = position_jitter(width = .1)) +  # Match point size and alpha to other graphs
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "test" = "Best Model")) +
  scale_y_continuous(breaks = seq(0.3, 1, 0.05), limits = c(0.3, 1), expand = c(0, 0)) +  # Adjust y-axis scale to match
  scale_color_manual(values = c("manual" = "#00BFC4", "test" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of ground truth vs best model",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Adjust title size and style
    axis.title.x = element_text(size = 16, face = "bold"),  # Adjust axis title size and style
    axis.title.y = element_text(size = 16, face = "bold"),  # Adjust axis title size and style
    axis.text.x = element_text(size = 15),  # Adjust axis text size
    axis.text.y = element_text(size = 15),  # Adjust axis text size
    legend.position = "none"
  ) #+
  #geom_hline(yintercept = seq(0.45, 0.95, by = 0.05), linetype = "dashed", color = "gray")  # Keep horizontal grid lines

# Add p-value annotation with updated position and text size
ymax <- max(joined_data_man_test_all_final$gratio, na.rm = TRUE) + 0.05
test_all_manual_graph <- test_all_manual_graph +
  geom_segment(aes(x = 1, xend = 2, y = ymax, yend = ymax), color = "black") +  # Horizontal line
  geom_segment(aes(x = 1, xend = 1, y = ymax - 0.01, yend = ymax), color = "black") +  # Left vertical line
  geom_segment(aes(x = 2, xend = 2, y = ymax - 0.01, yend = ymax), color = "black") +  # Right vertical line
  #annotate("text", x = 1.5, y = ymax + 0.01, label = "*", size = 6, color = "black") +
  annotate("text", x = 1.5, y = ymax - 0.03, label = formatted_p_value, size = 4, color = "black")  # Display p-value

# Print the plot
print(test_all_manual_graph)

ggsave("Original_protocol_all_images/geom_point_gratio_man_vs_test_all_dashed.png", bg = "white", dpi = 200)
```

```{r, warning=FALSE}
# Let's plot the gratio of the model against the gratio of the manual tracings
my.formula_all <- y~x

joined_x_final_final_updated <- ggplot(joined_x_final_final, aes(x = gratio.x, y = gratio.y)) +
  geom_point(shape = 16, size = 5, alpha = 0.6) +  # Ensure point size and transparency match
  geom_abline(slope = 1, intercept = 0, linetype = "dotted", color = "red", size = 1) +  # Consistent y=x line style
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +  # Consistent line smoothing
  stat_poly_eq(formula = my.formula_all, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # Consistent label size for equation
  scale_x_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1.01), expand = c(0, 0)) + # Adjust x-axis scale to match
  scale_y_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1.01), expand = c(0, 0)) + # Adjust y-axis scale to match
  labs(
    title = "Comparison of G-ratio Measurements",
    x = "G-ratio of the Ground Truth", # Updated x label
    y = "G-ratio of the Model" # Update y label to be specific to this model
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    legend.position = "none"
  )

# Print the updated plot
print(joined_x_final_final_updated)

ggsave("Original_protocol_all_images/model_vs_manual_line_of_fit.png", dpi = 200)

```

```{r}
# Let's create a violin graph to see the difference in distributions
ggplot(joined_data_man_test_all_final, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +  # Adding a boxplot inside the violin for more detail
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1), expand = c(0, 0)) + # Adjusting y-axis scale
  theme_minimal() +
  scale_x_discrete(labels = c("Ground Truth", "ADS test model")) +
  scale_fill_manual(values = c(manual = "blue", test = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS test model")) +
  theme(legend.position = "none")

ggsave("Original_protocol_all_images/violin_plot.png", bg = "white", dpi = 200)
```

```{r}
# Lets add a variable that shows the gratio difference
# Assuming model_compare already contains the gratio values as gratio.x (manual) and gratio.y (auto)
model_compare_gratio_difference_all <- joined_x_final_final %>%
  mutate(diff_gratio = gratio.x - gratio.y,
         percent_diff_gratio = ((gratio.x - gratio.y) / gratio.y) * 100)

# Plotting gratio differences
# First with gratio on x-axis
ggplot(model_compare_gratio_difference_all, aes(x = gratio.x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Match reference line style
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  annotate("text", x = max(model_compare_gratio_difference_all$gratio.x), y = 0.011615, 
           label = sprintf("Upper Limit: %.5f", 0.011615), hjust = 1, vjust = -1, size = 4) +  # Adjust text size and position
  annotate("text", x = max(model_compare_gratio_difference_all$gratio.x) + 0.01, y = -0.011615, 
           label = sprintf("Lower Limit: %.5f", -0.011615), hjust = 1, vjust = 1.5, size = 4) +  # Adjust text size and position
  scale_y_continuous(limits = c(-0.2, 0.2), breaks = seq(-0.2, 0.2, by = 0.05), expand = c(0, 0)) +
  labs(
    title = "Difference in G-ratio (Ground Truth vs. Best Model)",
    x = "G-ratio of Ground Truth",
    y = "Difference in G-ratio"
  ) +
  theme_minimal() +
  theme(
    axis.line = element_line(color = "black", size = 1),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Match title size and style
    axis.title.x = element_text(size = 16, face = "bold"),  # Match x-axis title size and style
    axis.title.y = element_text(size = 16, face = "bold"),  # Match y-axis title size and style
    axis.text.x = element_text(size = 15, family = "Arial"),  # Adjust axis text sizes
    axis.text.y = element_text(size = 15, family = "Arial"),
    legend.position = "none",
    panel.grid.major.x = element_blank(), # Remove major vertical grid lines
    panel.grid.minor.x = element_blank(), # Remove minor vertical grid lines
    panel.grid.major.y = element_blank(), # Remove major horizontal grid lines
    panel.grid.minor.y = element_blank()  # Remove minor horizontal grid lines
  )

ggsave("Original_protocol_all_images/g_ratio_difference.png", bg = "white", dpi = 200)

# Extra, didn't use
ggplot(model_compare_gratio_difference_all, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Then with axon diameter on x axis
ggplot(model_compare_gratio_difference_all, aes(x = axon_diam..um..x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  annotate("text", x = 1.725, y = 0.021615, label = sprintf("Upper Limit: %.5f", 0.011615), hjust = 1, vjust = -1, size = 3) +
  annotate("text", x = 1.725, y = -0.021615, label = sprintf("Lower Limit: %.5f", -0.011615), hjust = 1, vjust = 1.5, size = 3) +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Axon diameter (um)",
       y = "Difference in Gratio",
       color = "GT g-ratio") +
  theme_minimal() +
  theme(
    axis.line = element_line(color = "black", size = 1),
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 8)) +
  scale_y_continuous(limits = c(-0.2, 0.2), breaks = seq(-0.2, 0.2, by = 0.05), expand = c(0, 0))  # Setting y-axis scale from -0.2 to 0.2

ggsave("Original_protocol_all_images/axon_diam_difference.png", bg = "white", dpi = 200)

# And again with colour
ggplot(model_compare_gratio_difference_all, aes(x = axon_diam..um..x, y = diff_gratio, color =gratio.x)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  annotate("text", x = 1.725, y = 0.021615, label = sprintf("Upper Limit: %.5f", 0.011615), hjust = 1, vjust = -1, size = 3) +
  annotate("text", x = 1.725, y = -0.021615, label = sprintf("Lower Limit: %.5f", -0.011615), hjust = 1, vjust = 1.5, size = 3) +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Axon diameter (um)",
       y = "Difference in Gratio",
       color = "GT g-ratio") +
  theme_minimal() +
  theme(
    axis.line = element_line(color = "black", size = 1),
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 8)) +
  scale_y_continuous(limits = c(-0.2, 0.2), breaks = seq(-0.2, 0.2, by = 0.05), expand = c(0, 0))  # Setting y-axis scale from -0.2 to 0.2

ggsave("Original_protocol_all_images/axon_diam_difference_with_colour.png", bg = "white", dpi = 200)

ggplot(model_compare_gratio_difference_all, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Let's see how many points are within our limit
within_limit_count_all <- model_compare_gratio_difference_all %>%
  filter(abs(diff_gratio) <= 0.011615) %>%
  summarise(count = n())

total_points_all <- nrow(model_compare_gratio_difference_all)

proportion_within_limit_all <- within_limit_count_all / total_points_all

percentage_within_limit_all <- proportion_within_limit_all * 100

print(paste("Percentage of points within ±0.011615 limit:", round(percentage_within_limit_all, 2), "%"))


# Do this with gratio and diameter on y axis
# Also, just raw difference, not just percent difference
```

# 8) ADS data - New protocol (all images)

## Settings

```{r}
# Let's import the 'test' dataset
morph_test_all_new_1 <- read.table("New_protocol_all_images/Morpho_test_1.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_new_2 <- read.table("New_protocol_all_images/Morpho_test_2.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_new_3 <- read.table("New_protocol_all_images/Morpho_test_3.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_new_4 <- read.table("New_protocol_all_images/Morpho_test_4.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_new_5 <- read.table("New_protocol_all_images/Morpho_test_5.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_new_6 <- read.table("New_protocol_all_images/Morpho_test_6.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_new_7 <- read.table("New_protocol_all_images/Morpho_test_7.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_new_8 <- read.table("New_protocol_all_images/Morpho_test_8.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_new_9 <- read.table("New_protocol_all_images/Morpho_test_9.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_test_all_new_10 <- read.table("New_protocol_all_images/Morpho_test_10.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's remove all edge axons
## I've found that 600<y<3400 and 200<x<4000 cut out all the edge axons and leave in all the whole axons in image 2336
## I've found that 150<y<3670 and 400<x<4000 cut out all the edge axons and leave in all the whole axons in image 4090
## I've found that 300<y<3200 and 200<x<3700 cut out all the edge axons and leave in all the whole axons in image 5087
## I've found that 700<y<3750 and 450<x<3800 cut out all the edge axons and leave in all the whole axons in image 5767
## I've found that 300<y<3800 and 200<x<3700 cut out all the edge axons and leave in all the whole axons in image 61071
## I've found that 500<y<3800 and 275<x<3600 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 200<y<3650 and 400<x<3700 cut out all the edge axons and leave in all the whole axons in image 80021
## I've found that 500<y<3700 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 80022
## I've found that 500<y<3575 and 775<x<3800 cut out all the edge axons and leave in all the whole axons in image 8969
## I've found that 250<y<3900 and 250<x<3500 cut out all the edge axons and leave in all the whole axons in image 9867

morph_test_all_new_1_select = subset(morph_test_all_new_1, x0..px. >= 200 & x0..px. <= 4000 & y0..px. >= 600 & y0..px. <= 3400)
morph_test_all_new_2_select = subset(morph_test_all_new_2, x0..px. >= 400 & x0..px. <= 4000 & y0..px. >= 150 & y0..px. <= 3670)
morph_test_all_new_3_select = subset(morph_test_all_new_3, x0..px. >= 200 & x0..px. <= 3700 & y0..px. >= 300 & y0..px. <= 3200)
morph_test_all_new_4_select = subset(morph_test_all_new_4, x0..px. >= 450 & x0..px. <= 3800 & y0..px. >= 700 & y0..px. <= 3750)
morph_test_all_new_5_select = subset(morph_test_all_new_5, x0..px. >= 200 & x0..px. <= 3700 & y0..px. >= 300 & y0..px. <= 3800)
morph_test_all_new_6_select = subset(morph_test_all_new_6, x0..px. >= 275 & x0..px. <= 3600 & y0..px. >= 500 & y0..px. <= 3800)
morph_test_all_new_7_select = subset(morph_test_all_new_7, x0..px. >= 400 & x0..px. <= 3700 & y0..px. >= 200 & y0..px. <= 3650)
morph_test_all_new_8_select = subset(morph_test_all_new_8, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 500 & y0..px. <= 3700)
morph_test_all_new_9_select = subset(morph_test_all_new_9, x0..px. >= 725 & x0..px. <= 3800 & y0..px. >= 500 & y0..px. <= 3575)
morph_test_all_new_10_select = subset(morph_test_all_new_10, x0..px. >= 250 & x0..px. <= 3500 & y0..px. >= 250 & y0..px. <= 3900)


# Let's combine them all into one dataset
morph_test_all_new = rbind(morph_test_all_new_1_select, morph_test_all_new_2_select, morph_test_all_new_3_select,
                           morph_test_all_new_4_select, morph_test_all_new_5_select, morph_test_all_new_6_select,
                           morph_test_all_new_7_select, morph_test_all_new_8_select, morph_test_all_new_9_select, 
                           morph_test_all_new_10_select)
# Let's add a name tag
morph_test_all_new$name = "test"

# Let's import the 'manual' dataset
morph_manual_all_new_1 <- read.table("New_protocol_all_images/Morpho_manual_1.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_new_2 <- read.table("New_protocol_all_images/Morpho_manual_2.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_new_3 <- read.table("New_protocol_all_images/Morpho_manual_3.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_new_4 <- read.table("New_protocol_all_images/Morpho_manual_4.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_new_5 <- read.table("New_protocol_all_images/Morpho_manual_5.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_new_6 <- read.table("New_protocol_all_images/Morpho_manual_6.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_new_7 <- read.table("New_protocol_all_images/Morpho_manual_7.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_new_8 <- read.table("New_protocol_all_images/Morpho_manual_8.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_new_9 <- read.table("New_protocol_all_images/Morpho_manual_9.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_new_10 <- read.table("New_protocol_all_images/Morpho_manual_10.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's remove all edge axons
## I've found that 260<y<3650 and 250<x<3730 cut out all the edge axons and leave in all the whole axons in image 411
## I've found that 500<y<3700 and 250<x<3700 cut out all the edge axons and leave in all the whole axons in image 412
## I've found that 550<y<3800 and 300<x<3800 cut out all the edge axons and leave in all the whole axons in image 413
## I've found that 325<y<3800 and 400<x<3700 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 350<y<3650 and 550<x<3860 cut out all the edge axons and leave in all the whole axons in image 415
## I've found that 200<y<3900 and 600<x<3800 cut out all the edge axons and leave in all the whole axons in image 416
## I've found that 350<y<3650 and 400<x<3800 cut out all the edge axons and leave in all the whole axons in image 421
## I've found that 150<y<3900 and 525<x<3900 cut out all the edge axons and leave in all the whole axons in image 431
## I've found that 300<y<3700 and 600<x<3700 cut out all the edge axons and leave in all the whole axons in image 432
## I've found that 250<y<3650 and 600<x<3655 cut out all the edge axons and leave in all the whole axons in image 433

morph_manual_all_new_1_select = subset(morph_manual_all_new_1, x0..px. >= 250 & x0..px. <= 3730 & y0..px. >= 260 & y0..px. <= 3650)
morph_manual_all_new_2_select = subset(morph_manual_all_new_2, x0..px. >= 250 & x0..px. <= 3700 & y0..px. >= 500 & y0..px. <= 3700)
morph_manual_all_new_3_select = subset(morph_manual_all_new_3, x0..px. >= 300 & x0..px. <= 3800 & y0..px. >= 550 & y0..px. <= 3800)
morph_manual_all_new_4_select = subset(morph_manual_all_new_4, x0..px. >= 400 & x0..px. <= 3700 & y0..px. >= 325 & y0..px. <= 3800)
morph_manual_all_new_5_select = subset(morph_manual_all_new_5, x0..px. >= 550 & x0..px. <= 3860 & y0..px. >= 350 & y0..px. <= 3650)
morph_manual_all_new_6_select = subset(morph_manual_all_new_6, x0..px. >= 600 & x0..px. <= 3800 & y0..px. >= 200 & y0..px. <= 3900)
morph_manual_all_new_7_select = subset(morph_manual_all_new_7, x0..px. >= 400 & x0..px. <= 3800 & y0..px. >= 350 & y0..px. <= 3650)
morph_manual_all_new_8_select = subset(morph_manual_all_new_8, x0..px. >= 525 & x0..px. <= 3900 & y0..px. >= 150 & y0..px. <= 3900)
morph_manual_all_new_9_select = subset(morph_manual_all_new_9, x0..px. >= 600 & x0..px. <= 3700 & y0..px. >= 300 & y0..px. <= 3700)
morph_manual_all_new_10_select = subset(morph_manual_all_new_10, x0..px. >= 600 & x0..px. <= 3655 & y0..px. >= 250 & y0..px. <= 3650)


# Let's combine them all into one dataset
morph_manual_all_new = rbind(morph_manual_all_new_1_select, morph_manual_all_new_2_select, morph_manual_all_new_3_select,
                         morph_manual_all_new_4_select, morph_manual_all_new_5_select, morph_manual_all_new_6_select,
                         morph_manual_all_new_7_select, morph_manual_all_new_8_select, morph_manual_all_new_9_select,
                         morph_manual_all_new_10_select)

# Let's add a name tag
morph_manual_all_new$name = "manual"

# Let's combine the test and manual dataset together
joined_data_man_test_all_new= rbind(morph_test_all_new, morph_manual_all_new)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_test_all_new_final = subset(joined_data_man_test_all_new, axon_diam..um. >= 0.2)

# Let's remove all non-myelinated axons
joined_data_man_test_all_new_final = subset(joined_data_man_test_all_new_final, myelin_thickness..um. > 0.01)

# Let's do it for the manual and test datasets separately
morph_manual_all_new_final = subset(morph_manual_all_new, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)
morph_test_all_new_final = subset(morph_test_all_new, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)


# This is so that i can look at the data and see if there is anything wrong, such as all gratios above 0.9 not representing actual axons
#morph_test_all_new_experiment = subset(morph_test_all_new_2_select, axon_diam..um. >= 0.2)


# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
#model_compare_man_test_all_new = difference_inner_join(morph_manual_all_new_final, morph_test_all_new_final, by = c("x0..px.", "y0..px."), max_dist = 10 ) # Here we initially used a maximum distance of 10 pixels, this turned out to be too narrow, so we changed it to 100

#write.table(model_compare_man_test_all_new, file = "data_new.csv", sep = "\t", row.names = F)

z1 = difference_inner_join(morph_manual_all_new_1_select, morph_test_all_new_1_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
z2 = difference_inner_join(morph_manual_all_new_2_select, morph_test_all_new_2_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
z3 = difference_inner_join(morph_manual_all_new_3_select, morph_test_all_new_3_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
z4 = difference_inner_join(morph_manual_all_new_4_select, morph_test_all_new_4_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
z5 = difference_inner_join(morph_manual_all_new_5_select, morph_test_all_new_5_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
z6 = difference_inner_join(morph_manual_all_new_6_select, morph_test_all_new_6_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
z7 = difference_inner_join(morph_manual_all_new_7_select, morph_test_all_new_7_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
z8 = difference_inner_join(morph_manual_all_new_8_select, morph_test_all_new_8_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
z9 = difference_inner_join(morph_manual_all_new_9_select, morph_test_all_new_9_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
z10 = difference_inner_join(morph_manual_all_new_10_select, morph_test_all_new_10_select, by = c("x0..px.", "y0..px."), max_dist = 100 )

joined_z = rbind(z1, z2, z3, z4, z5, z6, z7, z8, z9, z10)

joined_z_final = subset(joined_z, axon_diam..um..x >= 0.2, myelin_thickness..um..x > 0.01)
joined_z_final_final = subset(joined_z_final, axon_diam..um..y >= 0.2)
joined_z_final_final = subset(joined_z_final_final, myelin_thickness..um..y > 0.01)

# Now I need to remove all the rows with NaN values (only two, most likely unmyelinated axons and/or artefacts in the ADS image, but it's easy to filter those out, and they do keep me from getting my data so I think it's alright)

joined_z_final_final <- na.omit(joined_z_final_final)

# IMPORTANT: look at myelin area -> need to remove the unmyelinates axons!

```

## Statistics

```{r}
# First, let's check if the data follows a normal distribution using a Shapiro-Wilk Test for Normality
shapiro.test(joined_data_man_test_all_new_final$gratio[joined_data_man_test_all_new_final$name == "manual"])
shapiro.test(joined_data_man_test_all_new_final$gratio[joined_data_man_test_all_new_final$name == "test"])

# Okay, we see that for both we have a (p>0.05), which means we cannot reject the null-hypothesis and thus the data can be considered to follow a normal distribution, so we should perform a parametric test:


# Perform the Wilcoxon signed-rank test
#wilcox_test_result <- wilcox.test(model_compare_man_test_all_new$gratio.x, model_compare_man_test_all_new$gratio.y, paired = TRUE)

# Print the test result
#print(wilcox_test_result)

### We get a p-value of 0.0004389. Since the p-value is lower than 0.05, we reject the null hypothesis and say that there is a statistically significant difference between the two methods of measurement.

# Won't use here! Let's perform a paired t-test on my filtered data
t_test_result_all_new <- t.test(joined_z_final_final$gratio.x, joined_z_final_final$gratio.y, paired = FALSE)
t_test_result_all_new

mean(joined_z_final_final$gratio.x)
# Now we need to figure out the effect size
# First we calculate mean difference
mean_difference_all_new <- mean(joined_z_final_final$gratio.x - joined_z_final_final$gratio.y)

# Calculate standard deviation of differences
sd_difference_all_new <- sd(joined_z_final_final$gratio.x - joined_z_final_final$gratio.y)

# Calculate Cohen's d
effect_size_all_new <- mean_difference_all_new / sd_difference_all_new

# Display results
cat("Mean Difference:", mean_difference_all_new, "\n")
cat("Effect Size (Cohen's d):", effect_size_all_new, "\n")

# The mean difference we get is X, this is higher than the maximum difference we concluded was acceptable from the variability comparison.



# Let's calculate the average of the absolute difference of g-ratios

# Calculate the absolute differences
joined_z_final_final$abs_diff_gratio <- abs(joined_z_final_final$gratio.x - joined_z_final_final$gratio.y)

# Compute the average of the absolute differences
average_abs_difference_new <- mean(joined_z_final_final$abs_diff_gratio)

# Display the result
print(paste("Average absolute G-ratio difference:", average_abs_difference_new))

```

## Graphs

```{r}
# Let's compare the test model and manual tracings
formatted_p_value <- ifelse(t_test_result_all_new$p.value < 0.0001, "p < 0.0001", sprintf("p = %.4f", t_test_result_all_new$p.value))

test_all_new_manual_graph <- ggplot(joined_data_man_test_all_new_final, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 3, alpha = 0.3, position = position_jitter(width = .1)) +  # Match point size and alpha
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "test" = "New Model")) +
  scale_y_continuous(breaks = seq(0.3, 1, 0.05), limits = c(0.3, 1), expand = c(0, 0)) +  # Ensure y-axis scale matches
  scale_color_manual(values = c("manual" = "#00BFC4", "test" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of ground truth vs new model",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Adjust title size and style to match
    axis.title.x = element_text(size = 16, face = "bold"),  # Adjust axis title size and style
    axis.title.y = element_text(size = 16, face = "bold"),  # Adjust axis title size and style
    axis.text.x = element_text(size = 15),  # Adjust axis text size
    axis.text.y = element_text(size = 15),  # Adjust axis text size
    legend.position = "none"
  ) 

ymax <- max(joined_data_man_test_all_new_final$gratio, na.rm = TRUE) + 0.05

test_all_new_manual_graph <- test_all_new_manual_graph +
  geom_segment(aes(x = 1, xend = 2, y = ymax, yend = ymax), color = "black") + # Horizontal line
  geom_segment(aes(x = 1, xend = 1, y = ymax - 0.01, yend = ymax), color = "black") + # Left vertical line
  geom_segment(aes(x = 2, xend = 2, y = ymax - 0.01, yend = ymax), color = "black") + # Right vertical line
  #annotate("text", x = 1.5, y = ymax + 0.01, label = "*", size = 6, color = "black") +
  annotate("text", x = 1.5, y = ymax - 0.03, label = formatted_p_value, size = 4, color = "black")  # Display p-value

# Print the plot
print(test_all_new_manual_graph)

ggsave("New_protocol_all_images/geom_point_gratio_man_vs_test_all_dashed.png", bg = "white", dpi = 200)
```

```{r, warning=FALSE}
# Let's plot the gratio of the model against the gratio of the manual tracings

my.formula_all_new <- y~x

ggplot(joined_z_final_final, aes(x = gratio.x, y = gratio.y)) +
  geom_point(shape = 16, size = 5, alpha = 0.6) +  # Match point size and transparency
  geom_abline(slope = 1, intercept = 0, linetype = "dotted", color = "red", size = 1) +  # Consistent y=x line style
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +  # Consistent line smoothing
  stat_poly_eq(formula = my.formula_all_new, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # Consistent label size for equation
  scale_x_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1.01), expand = c(0, 0)) + # Adjust x-axis scale to match
  scale_y_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1.01), expand = c(0, 0)) + # Adjust y-axis scale to match
  labs(
    title = "Comparison of G-ratio Measurements",
    x = "G-ratio of the Ground Truth", # Match x label
    y = "G-ratio of the New Model" # Match y label
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Adjust title size and style to match
    axis.title.x = element_text(size = 16, face = "bold"),  # Adjust axis title size and style to match
    axis.title.y = element_text(size = 16, face = "bold"),  # Adjust axis title size and style to match
    axis.text.x = element_text(size = 15),  # Adjust axis text size to match
    axis.text.y = element_text(size = 15),  # Adjust axis text size to match
    legend.position = "none"  # Ensure no legend is displayed
  )

ggsave("New_protocol_all_images/model_vs_manual_line_of_fit.png", dpi = 200)

```

```{r}
# Let's create a violin graph to see the difference in distributions
ggplot(joined_data_man_test_all_new_final, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +  # Adding a boxplot inside the violin for more detail
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
  theme_minimal() +
  scale_x_discrete(labels = c("Ground Truth", "ADS test model")) +
  scale_fill_manual(values = c(manual = "blue", test = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS test model")) +
  theme(legend.position = "none")

ggsave("New_protocol_all_images/violin_plot.png", bg = "white", dpi = 200)
```


```{r}
# Lets add a variable that shows the gratio difference
# Assuming model_compare already contains the gratio values as gratio.x (manual) and gratio.y (auto)
# Update your transformation logic if needed (assuming your data transformation is correct)
model_compare_gratio_difference_all_new <- joined_z_final_final %>%
  mutate(diff_gratio = gratio.x - gratio.y,
         percent_diff_gratio = ((gratio.x - gratio.y) / gratio.y) * 100)

# Plotting percent differences
# First with gratio on x-axis
ggplot(model_compare_gratio_difference_all_new, aes(x = gratio.x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  annotate("text", max(bland_altman_data$Average), y = 0.011615,
           label = sprintf("Upper Limit: %.5f", 0.011615), hjust = 1, vjust = -1, size = 4) +
  annotate("text", x = max(bland_altman_data$Average), y = -0.011615,
           label = sprintf("Lower Limit: %.5f", -0.011615), hjust = 1, vjust = 1.5, size = 4) +
  labs(
    title = "Difference in G-ratio (Ground Truth vs. New Model)",
    x = "G-ratio of Ground Truth",
    y = "Difference in G-ratio"
  ) +
  theme_minimal() +
  theme(
    axis.line = element_line(color = "black", size = 1),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 15, family = "Arial"),
    axis.text.y = element_text(size = 15, family = "Arial"),
    legend.position = "none",
    panel.grid.major.x = element_blank(), # Remove major vertical grid lines
    panel.grid.minor.x = element_blank(), # Remove minor vertical grid lines
    panel.grid.major.y = element_blank(), # Remove major horizontal grid lines
    panel.grid.minor.y = element_blank()  # Remove minor horizontal grid lines
  ) +
  scale_y_continuous(limits = c(-0.2, 0.2), breaks = seq(-0.2, 0.2, by = 0.05), expand = c(0, 0))

ggsave("New_protocol_all_images/g_ratio_difference.png", bg = "white", dpi = 200)



ggplot(model_compare_gratio_difference_all_new, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Then with axon diameter on x axis
ggplot(model_compare_gratio_difference_all_new, aes(x = axon_diam..um..x, y = diff_gratio)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red") +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  annotate("text", x = 1.725, y = 0.021615, label = sprintf("Upper Limit: %.5f", 0.011615), hjust = 1, vjust = -1, size = 3) +
  annotate("text", x = 1.725, y = -0.021615, label = sprintf("Lower Limit: %.5f", -0.011615), hjust = 1, vjust = 1.5, size = 3) +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Axon diameter (um)",
       y = "Difference in Gratio") +
  theme_minimal() +
  theme(
    axis.line = element_line(color = "black", size = 1),
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 8)) +
  scale_y_continuous(limits = c(-0.2, 0.2), breaks = seq(-0.2, 0.2, by = 0.05), expand = c(0, 0))  # Setting y-axis scale from -0.2 to 0.2

ggsave("New_protocol_all_images/axon_diam_difference.png", bg = "white", dpi = 200)

ggplot(model_compare_gratio_difference_all_new, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Let's see how many points are within our limit
within_limit_count_all_new <- model_compare_gratio_difference_all_new %>%
  filter(abs(diff_gratio) <= 0.011615) %>%
  summarise(count = n())

total_points_all_new <- nrow(model_compare_gratio_difference_all_new)

proportion_within_limit_all_new <- within_limit_count_all_new / total_points_all_new

percentage_within_limit_all_new <- proportion_within_limit_all_new * 100

print(paste("Percentage of points within ±0.011615 limit:", round(percentage_within_limit_all_new, 2), "%"))


# Do this with gratio and diameter on y axis
# Also, just raw difference, not just percent difference
```

# 9) ADS data - Original protocol - Default model (all images)

## Settings

```{r}
# Let's import the 'default' dataset
morph_default_all_1 <- read.table("Original_protocol_all_images/Morpho_default_1.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_default_all_2 <- read.table("Original_protocol_all_images/Morpho_default_2.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_default_all_3 <- read.table("Original_protocol_all_images/Morpho_default_3.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_default_all_4 <- read.table("Original_protocol_all_images/Morpho_default_4.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_default_all_5 <- read.table("Original_protocol_all_images/Morpho_default_5.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_default_all_6 <- read.table("Original_protocol_all_images/Morpho_default_6.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_default_all_7 <- read.table("Original_protocol_all_images/Morpho_default_7.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_default_all_8 <- read.table("Original_protocol_all_images/Morpho_default_8.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_default_all_9 <- read.table("Original_protocol_all_images/Morpho_default_9.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_default_all_10 <- read.table("Original_protocol_all_images/Morpho_default_10.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's remove all edge axons
## I've found that 600<y<3400 and 200<x<4000 cut out all the edge axons and leave in all the whole axons in image 2336
## I've found that 150<y<3670 and 400<x<4000 cut out all the edge axons and leave in all the whole axons in image 4090
## I've found that 300<y<3200 and 200<x<3700 cut out all the edge axons and leave in all the whole axons in image 5087
## I've found that 700<y<3750 and 450<x<3800 cut out all the edge axons and leave in all the whole axons in image 5767
## I've found that 300<y<3800 and 200<x<3700 cut out all the edge axons and leave in all the whole axons in image 61071
## I've found that 500<y<3800 and 275<x<3600 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 200<y<3650 and 400<x<3700 cut out all the edge axons and leave in all the whole axons in image 80021
## I've found that 500<y<3700 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 80022
## I've found that 500<y<3575 and 775<x<3800 cut out all the edge axons and leave in all the whole axons in image 8969
## I've found that 250<y<3900 and 250<x<3500 cut out all the edge axons and leave in all the whole axons in image 9867

morph_default_all_1_select = subset(morph_default_all_1, x0..px. >= 200 & x0..px. <= 4000 & y0..px. >= 600 & y0..px. <= 3400)
morph_default_all_2_select = subset(morph_default_all_2, x0..px. >= 400 & x0..px. <= 4000 & y0..px. >= 150 & y0..px. <= 3670)
morph_default_all_3_select = subset(morph_default_all_3, x0..px. >= 200 & x0..px. <= 3700 & y0..px. >= 300 & y0..px. <= 3200)
morph_default_all_4_select = subset(morph_default_all_4, x0..px. >= 450 & x0..px. <= 3800 & y0..px. >= 700 & y0..px. <= 3750)
morph_default_all_5_select = subset(morph_default_all_5, x0..px. >= 200 & x0..px. <= 3700 & y0..px. >= 300 & y0..px. <= 3800)
morph_default_all_6_select = subset(morph_default_all_6, x0..px. >= 275 & x0..px. <= 3600 & y0..px. >= 500 & y0..px. <= 3800)
morph_default_all_7_select = subset(morph_default_all_7, x0..px. >= 400 & x0..px. <= 3700 & y0..px. >= 200 & y0..px. <= 3650)
morph_default_all_8_select = subset(morph_default_all_8, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 500 & y0..px. <= 3700)
morph_default_all_9_select = subset(morph_default_all_9, x0..px. >= 725 & x0..px. <= 3800 & y0..px. >= 500 & y0..px. <= 3575)
morph_default_all_10_select = subset(morph_default_all_10, x0..px. >= 250 & x0..px. <= 3500 & y0..px. >= 250 & y0..px. <= 3900)


# Let's combine them all into one dataset
morph_default_all = rbind(morph_default_all_1_select, morph_default_all_2_select, morph_default_all_3_select, morph_default_all_4_select,
                       morph_default_all_5_select, morph_default_all_6_select, morph_default_all_7_select, morph_default_all_8_select,
                       morph_default_all_9_select, morph_default_all_10_select)

# Let's see combine all the unfiltered ones into one dataset (not necessary, just what we did when we were trying to figure out the data)
morph_default_all_original = rbind(morph_default_all_1, morph_default_all_2, morph_default_all_3, morph_default_all_4,
                       morph_default_all_5, morph_default_all_6, morph_default_all_7, morph_default_all_8,
                       morph_default_all_9, morph_default_all_10)

nrow(morph_default_all)
nrow(morph_default_all_original)

# Let's add a name tag
morph_default_all$name = "default"

# Let's import the 'manual' dataset
morph_manual_all_1 <- read.table("Original_protocol_all_images/Morpho_manual_1.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_2 <- read.table("Original_protocol_all_images/Morpho_manual_2.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_3 <- read.table("Original_protocol_all_images/Morpho_manual_3.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_4 <- read.table("Original_protocol_all_images/Morpho_manual_4.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_5 <- read.table("Original_protocol_all_images/Morpho_manual_5.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_6 <- read.table("Original_protocol_all_images/Morpho_manual_6.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_7 <- read.table("Original_protocol_all_images/Morpho_manual_7.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_8 <- read.table("Original_protocol_all_images/Morpho_manual_8.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_9 <- read.table("Original_protocol_all_images/Morpho_manual_9.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_manual_all_10 <- read.table("Original_protocol_all_images/Morpho_manual_10.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's remove all edge axons
## I've found that 600<y<3400 and 200<x<4000 cut out all the edge axons and leave in all the whole axons in image 2336
## I've found that 150<y<3670 and 400<x<4000 cut out all the edge axons and leave in all the whole axons in image 4090
## I've found that 300<y<3200 and 200<x<3700 cut out all the edge axons and leave in all the whole axons in image 5087
## I've found that 700<y<3750 and 450<x<3800 cut out all the edge axons and leave in all the whole axons in image 5767
## I've found that 300<y<3800 and 200<x<3700 cut out all the edge axons and leave in all the whole axons in image 61071
## I've found that 500<y<3800 and 275<x<3600 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 200<y<3650 and 400<x<3700 cut out all the edge axons and leave in all the whole axons in image 80021
## I've found that 500<y<3700 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 80022
## I've found that 500<y<3575 and 775<x<3800 cut out all the edge axons and leave in all the whole axons in image 8969
## I've found that 250<y<3900 and 250<x<3500 cut out all the edge axons and leave in all the whole axons in image 9867

morph_manual_all_1_select = subset(morph_manual_all_1, x0..px. >= 200 & x0..px. <= 4000 & y0..px. >= 600 & y0..px. <= 3400)
morph_manual_all_2_select = subset(morph_manual_all_2, x0..px. >= 400 & x0..px. <= 4000 & y0..px. >= 150 & y0..px. <= 3670)
morph_manual_all_3_select = subset(morph_manual_all_3, x0..px. >= 200 & x0..px. <= 3700 & y0..px. >= 300 & y0..px. <= 3200)
morph_manual_all_4_select = subset(morph_manual_all_4, x0..px. >= 450 & x0..px. <= 3800 & y0..px. >= 700 & y0..px. <= 3750)
morph_manual_all_5_select = subset(morph_manual_all_5, x0..px. >= 200 & x0..px. <= 3700 & y0..px. >= 300 & y0..px. <= 3800)
morph_manual_all_6_select = subset(morph_manual_all_6, x0..px. >= 275 & x0..px. <= 3600 & y0..px. >= 500 & y0..px. <= 3800)
morph_manual_all_7_select = subset(morph_manual_all_7, x0..px. >= 400 & x0..px. <= 3700 & y0..px. >= 200 & y0..px. <= 3650)
morph_manual_all_8_select = subset(morph_manual_all_8, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 500 & y0..px. <= 3700)
morph_manual_all_9_select = subset(morph_manual_all_9, x0..px. >= 725 & x0..px. <= 3800 & y0..px. >= 500 & y0..px. <= 3575)
morph_manual_all_10_select = subset(morph_manual_all_10, x0..px. >= 250 & x0..px. <= 3500 & y0..px. >= 250 & y0..px. <= 3900)


# Let's combine them all into one dataset
morph_manual_all = rbind(morph_manual_all_1_select, morph_manual_all_2_select, morph_manual_all_3_select, morph_manual_all_4_select,
                         morph_manual_all_5_select, morph_manual_all_6_select, morph_manual_all_7_select, morph_manual_all_8_select,
                         morph_manual_all_9_select, morph_manual_all_10_select)

morph_manual_all_original = rbind(morph_manual_all_1, morph_manual_all_2, morph_manual_all_3, morph_manual_all_4,
                         morph_manual_all_5, morph_manual_all_6, morph_manual_all_7, morph_manual_all_8,
                         morph_manual_all_9, morph_manual_all_10)

nrow(morph_manual_all)
nrow(morph_manual_all_original)

# Let's add a name tag
morph_manual_all$name = "manual"

# Let's combine the default and manual dataset together
joined_data_man_default_all= rbind(morph_default_all, morph_manual_all)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts.
joined_data_man_default_all_final = subset(joined_data_man_default_all, axon_diam..um. >= 0.2)

# Let's remove all non-myelinated axons
joined_data_man_default_all_final = subset(joined_data_man_default_all_final, myelin_thickness..um. > 0.01)

# Let's do it for the manual and default datasets separately
morph_manual_all_final = subset(morph_manual_all, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)
morph_default_all_final = subset(morph_default_all, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)


# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
#model_compare_man_default_all = difference_inner_join(morph_manual_all_final, morph_default_all_final, by = c("x0..px.", "y0..px."), max_dist = 10 )

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
# model_compare_man_test_all = difference_inner_join(morph_manual_all_final, morph_test_all_final, by = c("x0..px.", "y0..px."), max_dist = 10 ) # Here we initially used a maximum distance of 10 pixels, this turned out to be too narrow, so we changed it to 100

# IMPORTANT: We found out that if we do this, we are comparing many pictures to each other, so a centroid from one image might be attached to a centroid of an axon in another image, so we need to use fuzzyjoin on all the images separately (see what we did with the y1-10 etc.)

# write.table(model_compare_man_test_all, file = "data.csv", sep = "\t", row.names = F)


y1 = difference_inner_join(morph_manual_all_1_select, morph_default_all_1_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
y2 = difference_inner_join(morph_manual_all_2_select, morph_default_all_2_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
y3 = difference_inner_join(morph_manual_all_3_select, morph_default_all_3_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
y4 = difference_inner_join(morph_manual_all_4_select, morph_default_all_4_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
y5 = difference_inner_join(morph_manual_all_5_select, morph_default_all_5_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
y6 = difference_inner_join(morph_manual_all_6_select, morph_default_all_6_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
y7 = difference_inner_join(morph_manual_all_7_select, morph_default_all_7_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
y8 = difference_inner_join(morph_manual_all_8_select, morph_default_all_8_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
y9 = difference_inner_join(morph_manual_all_9_select, morph_default_all_9_select, by = c("x0..px.", "y0..px."), max_dist = 100 )
y10 = difference_inner_join(morph_manual_all_10_select, morph_default_all_10_select, by = c("x0..px.", "y0..px."), max_dist = 100 )

joined_y = rbind(y1, y2, y3, y4, y5, y6, y7, y8, y9, y10)

joined_y_final = subset(joined_y, axon_diam..um..x >= 0.2, myelin_thickness..um..x > 0.01)
joined_y_final_final = subset(joined_y_final, axon_diam..um..y >= 0.2)
joined_y_final_final = subset(joined_y_final_final, myelin_thickness..um..y > 0.01)

# Now I need to remove all the rows with NaN values (only two, most likely unmyelinated ayons and/or artefacts in the ADS image, but it's easy to filter those out, and they do keep me from getting my data so I think it's alright)

joined_y_final_final <- na.omit(joined_y_final_final)

write.table(joined_y_final_final, file = "joined_y_final_final.csv", sep = "\t", row.names = F)

# Let's create a graph plotting the default and test model g-ratios against the axon diameter

combined_data <- rbind(morph_test_all, morph_default_all)
combined_data_final <- subset(combined_data, axon_diam..um. >= 0.2 & myelin_thickness..um. > 0.01)

# Create the plot
ggplot(combined_data_final, aes(x = axon_diam..um., y = gratio, color = name)) +
  geom_point() +
  labs(title = "Comparison of G-ratio vs Axon Diameter",
       x = "Axon Diameter (µm)",
       y = "G-ratio") +
  theme_minimal()

styled_graph <- ggplot(combined_data_final, aes(x = axon_diam..um., y = gratio, color = name)) +
  geom_point(shape = 16, size = 3, alpha = 0.25) +  # Match point size and alpha
  geom_smooth(method = "lm", se = FALSE) +  # Add lines of fit for each group
  scale_color_manual(values = c("test" = "#00BFC4", "default" = "#F8766D"),
                     labels = c("test" = "Best Model", "default" = "Default Model")) +
  scale_y_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1.01), expand = c(0, 0)) +
  scale_x_continuous(breaks = seq(0, 2, 0.2), limits = c(0, 2.01), expand = c(0, 0)) +
  labs(
    title = "Comparison of G-ratio vs Axon Diameter",
    x = "Axon Diameter (µm)",
    y = "G-ratio",
    color = "Model"  # Legend title
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Adjust title size and style
    axis.title.x = element_text(size = 16, face = "bold"),  # Adjust axis title size and style
    axis.title.y = element_text(size = 16, face = "bold"),  # Adjust axis title size and style
    axis.text.x = element_text(size = 15),  # Adjust axis text size
    axis.text.y = element_text(size = 15),  # Adjust axis text size
    legend.position = "right",
    plot.margin = margin(t = 20, r = 20, b = 40, l = 20)  # Adjust margins
  )

# Print the styled graph
print(styled_graph)

ggsave("Original_protocol_all_images/g_ratio_vs_axon_diam_default_vs_test.png", bg = "white", dpi = 200)

```

## Statistics

```{r}
# First, let's check if the data follows a normal distribution using a Shapiro-Wilk default for Normality
shapiro.test(joined_data_man_default_all_final$gratio[joined_data_man_default_all_final$name == "manual"])
shapiro.test(joined_data_man_default_all_final$gratio[joined_data_man_default_all_final$name == "default"])

# Okay, we see that for both we have a (p<0.05), which means we cannot reject the null-hypothesis and thus the data can be considered to follow a normal distribution, so we should perform a parametric default:


# Let's perform a paired t-test on my filtered data
t_test_result_all_default <- t.test(joined_y_final_final$gratio.x, joined_y_final_final$gratio.y, paired = FALSE)
t_test_result_all_default

# Perform the Wilcoxon signed-rank default
#wilcox_test_result <- wilcox.test(joined_y_final_final$gratio.x, joined_y_final_final$gratio.y, paired = TRUE)

# Print the default result
#print(wilcox_test_result)

### We get a p-value of 2.2e-16. Since the p-value is lower than 0.05, we reject the null hypothesis and say that there is a statistically significant difference between the two methods of measurement.

# Now we need to figure out the effect size
# First we calculate mean difference
mean_difference_all <- mean(joined_y_final_final$gratio.x - joined_y_final_final$gratio.y, na.rm = TRUE)

# Calculate standard deviation of differences
sd_difference_all <- sd(joined_y_final_final$gratio.x - joined_y_final_final$gratio.y, na.rm = TRUE)

# Calculate Cohen's d
effect_size_all <- mean_difference_all / sd_difference_all

# Display results
cat("Mean Difference:", mean_difference_all, "\n")
cat("Effect Size (Cohen's d):", effect_size_all, "\n")

# The mean difference we get is X, this is higher than the maximum difference we concluded was acceptable from the variability comparison.



# Let's calculate the average of the absolute difference of g-ratios

# Calculate the absolute differences
joined_y_final_final$abs_diff_gratio <- abs(joined_y_final_final$gratio.x - joined_y_final_final$gratio.y)

# Compute the average of the absolute differences
average_abs_difference <- mean(joined_y_final_final$abs_diff_gratio)

# Display the result
print(paste("Average absolute G-ratio difference:", average_abs_difference))

```

## Graphs

```{r}
# Let's compare the default model and manual tracings
formatted_p_value <- ifelse(t_test_result_all_default$p.value < 0.0001, "p < 0.0001", sprintf("p = %.4f", t_test_result_all_default$p.value))

default_model_manual_graph <- ggplot(joined_data_man_default_all_final, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 3, alpha = 0.3, position = position_jitter(width = .1)) +  # Match point size and alpha
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "default" = "ADS Default Model")) +
  scale_y_continuous(breaks = seq(0.3, 1, 0.05), limits = c(0.3, 1.01), expand = c(0, 0)) + # Match y-axis scale
  scale_color_manual(values = c("manual" = "#00BFC4", "default" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of ground truth vs default model",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Adjust title size and style
    axis.title.x = element_text(size = 16, face = "bold"),  # Adjust axis title size and style
    axis.title.y = element_text(size = 16, face = "bold"),  # Adjust axis title size and style
    axis.text.x = element_text(size = 15),  # Adjust axis text size
    axis.text.y = element_text(size = 15),  # Adjust axis text size
    legend.position = "none"
  ) #+
  #geom_hline(yintercept = seq(0.45, 0.95, by = 0.05), linetype = "dashed", color = "gray")  # Match horizontal grid lines

# Adding significance bars and annotation
ymax <- max(joined_data_man_default_all_final$gratio, na.rm = TRUE) + 0.05
default_model_manual_graph <- default_model_manual_graph +
  geom_segment(aes(x = 1, xend = 2, y = ymax, yend = ymax), color = "black") + # Horizontal line
  geom_segment(aes(x = 1, xend = 1, y = ymax - 0.01, yend = ymax), color = "black") + # Left vertical line
  geom_segment(aes(x = 2, xend = 2, y = ymax - 0.01, yend = ymax), color = "black") + # Right vertical line
  annotate("text", x = 1.5, y = ymax + 0.01, label = "*", size = 6, color = "black") +
  annotate("text", x = 1.5, y = ymax - 0.03, label = formatted_p_value, size = 4, color = "black")  # Display p-value

# Print the updated plot
print(default_model_manual_graph)

ggsave("Original_protocol_all_images/geom_point_gratio_man_vs_default_all_dashed.png", bg = "white", dpi = 200)
```

```{r}
joined_data_man_default_test_all = rbind(morph_default_all, morph_test_all, morph_manual_all)

joined_data_man_default_test_all = subset(joined_data_man_default_test_all, axon_diam..um. >= 0.2)
joined_data_man_default_test_all = subset(joined_data_man_default_test_all, myelin_thickness..um. > 0.01)


# Let's compare the default model and manual tracings
formatted_p_value <- ifelse(wilcox_test_result$p.value < 0.0001, "p < 0.0001", sprintf("%.4f", wilcox_test_result$p.value))

joined_data_man_default_test_all$name <- factor(joined_data_man_default_test_all$name, levels = c("manual", "test", "default"))

default_model_manual_graph <- ggplot(joined_data_man_default_test_all, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 5, alpha = 0.6, position = position_jitter(width = .1)) +
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "default" = "ADS default model", "test" = "My best model")) +
  scale_y_continuous(breaks = seq(0.35, 1, 0.05), limits = c(0.35, 1), expand = c(0, 0)) + # Adjusted y limit here
  scale_color_manual(values = c("manual" = "#00BFC4", "default" = "#F8766D", "test" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of the two models vs the ground truth",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    axis.title.x = element_text(face = "bold"),
    axis.title.y = element_text(face = "bold"),
    legend.position = "none"
  ) +
  geom_hline(yintercept = seq(0.35, 1, by = 0.05), linetype = "dashed", color = "gray") 

# Adding significance bars and annotation
ymax <- max(joined_data_man_default_test_all$gratio, na.rm = TRUE) + 0.05
default_model_manual_graph <- default_model_manual_graph +
  geom_segment(aes(x = 1, xend = 2, y = ymax, yend = ymax), color = "black") + # Horizontal line
  geom_segment(aes(x = 1, xend = 1, y = ymax - 0.01, yend = ymax), color = "black") + # Left vertical line
  geom_segment(aes(x = 2, xend = 2, y = ymax - 0.01, yend = ymax), color = "black") + # Right vertical line
  annotate("text", x = 1.5, y = ymax + 0.01, label = "*", size = 6, color = "black") +
  annotate("text", x = 1.5, y = ymax - 0.03, label = formatted_p_value, size = 4, color = "black")  # Display p-value

# Print the plot
print(default_model_manual_graph)

ggsave("Three_combined.png", bg = "white", dpi = 200)
```


```{r, warning=FALSE}
# Let's plot the gratio of the model against the gratio of the manual tracings
my.formula_all <- y~x

joined_y_final_final_updated <- ggplot(joined_y_final_final, aes(x = gratio.x, y = gratio.y)) +
  geom_point(shape = 16, size = 5, alpha = 0.6) +  # Ensure point size and transparency match
  geom_abline(slope = 1, intercept = 0, linetype = "dotted", color = "red", size = 1) +  # Consistent y=x line style
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +  # Consistent line smoothing
  stat_poly_eq(formula = my.formula_all, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # Consistent label size for equation
  scale_x_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1.01), expand = c(0, 0)) + # Adjust x-axis scale to match
  scale_y_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1.01), expand = c(0, 0)) + # Adjust y-axis scale to match
  labs(
    title = "Comparison of G-ratio Measurements",
    x = "G-ratio of the Ground Truth", # Updated x label
    y = "G-ratio of the Default Model" # Update y label to be specific to this model
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    legend.position = "none"
  )

# Print the updated plot
print(joined_y_final_final_updated)

ggsave("Original_protocol_all_images/default_model_vs_manual_line_of_fit.png", dpi = 200)

```

```{r}
# Let's create a violin graph to see the difference in distributions
ggplot(joined_data_man_default_all_final, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +  # Adding a boxplot inside the violin for more detail
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
  scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1), expand = c(0, 0)) + # Adjusting y-axis scale
  theme_minimal() +
  scale_x_discrete(labels = c("Ground Truth", "ADS default model")) +
  scale_fill_manual(values = c(manual = "blue", default = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS default model")) +
  theme(legend.position = "none")

ggsave("Original_protocol_all_images/default_violin_plot.png", bg = "white", dpi = 200)
```

```{r}
# Lets add a variable that shows the gratio difference
# Assuming model_compare already contains the gratio values as gratio.x (manual) and gratio.y (auto)
model_compare_gratio_difference_all <- joined_y_final_final %>%
  mutate(diff_gratio = gratio.x - gratio.y,
         percent_diff_gratio = ((gratio.x - gratio.y) / gratio.y) * 100)

# Plotting gratio differences
# First with gratio on x-axis
ggplot(model_compare_gratio_difference_all, aes(x = gratio.x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  annotate("text", x = max(bland_altman_data$Average), y = 0.011615, label = sprintf("Upper Limit: %.5f", 0.011615), hjust = 1, vjust = -1, size = 3) +
  annotate("text", x = max(bland_altman_data$Average), y = -0.011615, label = sprintf("Lower Limit: %.5f", -0.011615), hjust = 1, vjust = 1.5, size = 3) +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Gratio",
       y = "Difference in Gratio") +
  theme_minimal() +
  theme(
    axis.line = element_line(color = "black", size = 1),
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 8)) +
  scale_y_continuous(limits = c(-0.2, 0.2), breaks = seq(-0.2, 0.2, by = 0.05), expand = c(0, 0))  # Setting y-axis scale from -0.2 to 0.2

ggsave("Original_protocol_all_images/g_ratio_difference.png", bg = "white", dpi = 200)

ggplot(model_compare_gratio_difference_all, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Then with axon diameter on x axis
ggplot(model_compare_gratio_difference_all, aes(x = axon_diam..um..x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Axon diameter (um)",
       y = "Difference in Gratio") +
  theme_minimal()

ggsave("Original_protocol_all_images/axon_diam_difference.png", bg = "white", dpi = 200)

ggplot(model_compare_gratio_difference_all, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Let's see how many points are within our limit
within_limit_count_all <- model_compare_gratio_difference_all %>%
  filter(abs(diff_gratio) <= 0.011615) %>%
  summarise(count = n())

total_points_all <- nrow(model_compare_gratio_difference_all)

proportion_within_limit_all <- within_limit_count_all / total_points_all

percentage_within_limit_all <- proportion_within_limit_all * 100

print(paste("Percentage of points within ±0.011615 limit:", round(percentage_within_limit_all, 2), "%"))


# Do this with gratio and diameter on y axis
# Also, just raw difference, not just percent difference
```

# 10) ADS data - Original vs new protocol comparison

```{r}

morph_manual_all_new$name = "manual"

# Assuming 'manual' is a column name in your data frame
joined_data_man_test_all_final$name[joined_data_man_test_all_final$name == "manual"] <- "manual1"
joined_data_man_test_all_final$name[joined_data_man_test_all_final$name == "test"] <- "test1"
joined_data_man_test_all_new_final$name[joined_data_man_test_all_new_final$name == "manual"] <- "manual2"
joined_data_man_test_all_new_final$name[joined_data_man_test_all_new_final$name == "test"] <- "test2"


# Let's combine both the old and new fixation's together
joined_data_man_test_all_old_and_new_combined = rbind(joined_data_man_test_all_new_final, joined_data_man_test_all_final)


joined_data_man_test_all_old_and_new_combined$name <- factor(joined_data_man_test_all_old_and_new_combined$name)

# Get and print the current levels to see the order
current_levels <- levels(joined_data_man_test_all_old_and_new_combined$name)
print(current_levels)  # See the current order

if (length(current_levels) >= 3) {
  new_order <- current_levels[c(1, 3, 2, 4:length(current_levels))]  # Adjust this as per your actual data
  joined_data_man_test_all_old_and_new_combined$name <- factor(
    joined_data_man_test_all_old_and_new_combined$name,
    levels = new_order
  )
}

ggplot(joined_data_man_test_all_old_and_new_combined, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
  theme_minimal() + 
  scale_x_discrete(labels = c("Ground Truth - original", "ADS test model - original", "Ground Truth", "ADS test model")) +
  scale_fill_manual(values = c(manual1 = "blue", test1 = "#F8766D", manual2 = "blue", test2 = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS test model")) +
  theme(legend.position = "none")

ggplot(joined_data_man_test_all_old_and_new_combined, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 5, alpha = 0.6, position = position_jitter(width = .1)) +
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual1" = "Ground Truth - original", "test1" = "ADS test model - original", "manual2" = "Ground Truth", "test2" = "ADS test model")) +
  scale_y_continuous(breaks = seq(0.25, 0.9, 0.05), limits = c(0.25, 0.9), expand = c(0, 0)) +
  scale_color_manual(values = c("manual1" = "#00BFC4", "test1" = "#F8766D", "manual2" = "#00BFC4", "test2" = "#F8766D")) +
  labs(
    title = "Comparing results from the two different fixation protocols",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  #scale_color_manual(aesthetics = "colour", 
   #                  breaks=c("OPALIN", "PDGFRA"), 
    #                 labels = c("Opalin-cre", "Pdgfra-cre"),
     #                values = c("#ba3c3c", "#9290d1") )  +
  #ylab("internodal length [um]") +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),  # Center the title
    axis.title.x = element_text(face = "bold"),  # Set x axis title in bold
    axis.title.y = element_text(face = "bold"),  # Set y axis title in bold
    #axis.line = element_line(size= 2, colour = graph_col),
    #axis.ticks.y = element_line(size = 2, colour = graph_col),
    #axis.ticks.x = element_blank(),
    #axis.ticks.length=unit(.5, "cm"),
    #axis.title=element_blank(),
    #axis.text= element_blank(),
    #legend.title = element_blank(),
    legend.position = "none"
    #legend.direction = "vertical",
    #legend.text = element_text(colour="black", size = 12)
  ) +
  geom_hline(yintercept = seq(0.25, 0.9, by = 0.05), linetype = "dashed", color = "gray")  # Add dashed lines
```

# 11) ADS data - Original protocol (model_3 on image 61072)

## First we will only compare the manual and test datasets on image 61072

## Settings

```{r}
# Let's start by importing our data
morph_mod3_61072 <- read.table("Image61072/Morpho_4_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_61072 <- read.table("Image61072/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_mod3_61072$name = "mod3"
morph_man_61072$name = "manual"

# Let's combine the manual and test (auto) datasets together
joined_data_man_mod3_61072 = rbind(morph_man_61072, morph_mod3_61072)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_mod3_61072_selection = subset(joined_data_man_mod3_61072, axon_diam..um. >= 0.2)

# Let's do it for the manual and test datasets separately
morph_man_61072_selection = subset(morph_man_61072, axon_diam..um. >= 0.2)
morph_mod3_61072_selection = subset(morph_mod3_61072, axon_diam..um. >= 0.2)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61072) so:
# Exclude all rows where x0 (px) < 250 or x0 (px) > 3750 and y0 (px) < 300 or y0 (px) > 3500
joined_data_man_mod3_61072_final = subset(joined_data_man_mod3_61072_selection, x0..px. >= 550 & x0..px. <= 3800 & y0..px. >= 275 & y0..px. <= 3600)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 250-3750 and y0 (px) is outside 300-3500
morph_man_61072_final = subset(morph_man_61072_selection, x0..px. >= 550 & x0..px. <= 3800 & y0..px. >= 275 & y0..px. <= 3600)
morph_mod3_61072_final = subset(morph_mod3_61072_selection, x0..px. >= 550 & x0..px. <= 3800 & y0..px. >= 275 & y0..px. <= 3600)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_mod3_61072 = difference_inner_join(morph_man_61072_final, morph_mod3_61072_final, by = c("x0..px.", "y0..px."), max_dist = 10 )
```

## Graphs

```{r}
# Let's compare the test model and manual tracings
ggplot(joined_data_man_mod3_61072_final, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 5, alpha = 0.6, position = position_jitter(width = .1)) +
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "mod3" = "ADS test model")) +
  scale_y_continuous(breaks = seq(0.5, 0.85, 0.05), limits = c(0.5, 0.85), expand = c(0, 0)) +
  scale_color_manual(values = c("manual" = "#00BFC4", "mod3" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of Ground Truth vs ADS test model",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  #scale_color_manual(aesthetics = "colour", 
   #                  breaks=c("OPALIN", "PDGFRA"), 
    #                 labels = c("Opalin-cre", "Pdgfra-cre"),
     #                values = c("#ba3c3c", "#9290d1") )  +
  #ylab("internodal length [um]") +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),  # Center the title
    axis.title.x = element_text(face = "bold"),  # Set x axis title in bold
    axis.title.y = element_text(face = "bold"),  # Set y axis title in bold
    #axis.line = element_line(size= 2, colour = graph_col),
    #axis.ticks.y = element_line(size = 2, colour = graph_col),
    #axis.ticks.x = element_blank(),
    #axis.ticks.length=unit(.5, "cm"),
    #axis.title=element_blank(),
    #axis.text= element_blank(),
    #legend.title = element_blank(),
    legend.position = "none"
    #legend.direction = "vertical",
    #legend.text = element_text(colour="black", size = 12)
  ) +
  geom_hline(yintercept = seq(0.5, 0.85, by = 0.05), linetype = "dashed", color = "gray")  # Add dashed lines

ggsave("Image61072/geom_point_gratio_man_vs_test_61072_dashed.png", bg = "white", dpi = 200)
```

```{r, warning=FALSE}
# Let's plot the gratio of the model against the gratio of the manual tracings

my.formula_mod3_61072 <- y~x



ggplot(model_compare_man_mod3_61072, aes(x = gratio.x, y = gratio.y)) +
  geom_point(shape = 16, size = 5, alpha = .6) +
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +
  stat_poly_eq(formula = my.formula_mod3_61072, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # adjust label.size for equation size
  scale_x_continuous(breaks = seq(0.5, 0.85, 0.1), limits = c(0.5, 0.85), expand = c(0, 0)) +
  scale_y_continuous(breaks = seq(0.5, 0.85, 0.1), limits = c(0.5, 0.85), expand = c(0, 0)) +
  labs(
    x = "G-ratio of the Ground Truth", # new x label
    y = "G-ratio of the Model" # new y label
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 20),
    axis.line = element_line(size = 2, colour = "black"),
    axis.ticks.y = element_line(size = 2, colour = "black"),
    axis.ticks.length = unit(.5, "cm"),
    axis.text = element_text(size = 18), # adjust size for axis text
    axis.title = element_text(size = 20, face = "bold"), # bold axis titles
    legend.position = "none",
    plot.caption = element_text(size = 16) # adjust size for caption (equation)
  )

ggsave("Image61072/model_vs_manual_line_of_fit.png", dpi = 200)

```

```{r}
# Let's create a violin graph to see the difference in distributions
ggplot(joined_data_man_mod3_61072_final, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +  # Adding a boxplot inside the violin for more detail
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
  theme_minimal() +
  scale_x_discrete(labels = c("Ground Truth", "ADS test model")) +
  scale_fill_manual(values = c(manual = "blue", mod3 = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS test model")) +
  theme(legend.position = "none")
```

## Statistics

```{r}
# First, let's check if the data follows a normal distribution using a Shapiro-Wilk Test for Normality
shapiro.test(joined_data_man_mod3_61072_final$gratio[joined_data_man_mod3_61072_final$name == "manual"])
shapiro.test(joined_data_man_mod3_61072_final$gratio[joined_data_man_mod3_61072_final$name == "mod3"])

# Okay, we see that for both we have a (p>0.05), which means we cannot reject the null-hypothesis and thus the data can be considered to follow a normal distribution, so we should perform a parametric test:

# Let's perform a paired t-test on my filtered data
t_test_result_mod3_61072 <- t.test(model_compare_man_mod3_61072$gratio.x, model_compare_man_mod3_61072$gratio.y, paired = TRUE)
t_test_result_mod3_61072

# We get a p-value of 0.03656. Since the p-value is less than 0.05, we reject the null hypothesis and say that there is a statistically significant difference between the two methods of measurement.

# Now we need to figure out the effect size
# First we calculate mean difference
mean_difference_mod3 <- mean(model_compare_man_mod3_61072$gratio.x - model_compare_man_mod3_61072$gratio.y)

# Calculate standard deviation of differences
sd_difference_mod3 <- sd(model_compare_man_mod3_61072$gratio.x - model_compare_man_mod3_61072$gratio.y)

# Calculate Cohen's d
effect_size_mod3 <- mean_difference_mod3 / sd_difference_mod3

# Display results
cat("Mean Difference:", mean_difference_mod3, "\n")
cat("Effect Size (Cohen's d):", effect_size_mod3, "\n")

# The mean difference we get is 0.01712859, this is higher than the maximum difference we concluded was acceptable from the variability comparison.


```

```{r}
# Lets add a variable that shows the gratio difference
# Assuming model_compare already contains the gratio values as gratio.x (manual) and gratio.y (auto)
model_compare_gratio_difference_mod3_61072 <- model_compare_man_mod3_61072 %>%
  mutate(diff_gratio = gratio.x - gratio.y,
         percent_diff_gratio = ((gratio.x - gratio.y) / gratio.y) * 100)

# Plotting percent differences
# First with gratio on x-axis
ggplot(model_compare_gratio_difference_mod3_61072, aes(x = gratio.x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Gratio",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_mod3_61072, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Then with axon diameter on x axis
ggplot(model_compare_gratio_difference_mod3_61072, aes(x = axon_diam..um..x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Axon diameter (um)",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_mod3_61072, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()


# Let's see how many points are within our limit
within_limit_count_61072_mod3 <- model_compare_gratio_difference_mod3_61072 %>%
  filter(abs(diff_gratio) <= 0.011615) %>%
  summarise(count = n())

total_points_61072_mod3 <- nrow(model_compare_gratio_difference_mod3_61072)

proportion_within_limit_61072_mod3 <- within_limit_count_61072_mod3 / total_points_61072_mod3

percentage_within_limit_61072_mod3 <- proportion_within_limit_61072_mod3 * 100

print(paste("Percentage of points within ±0.011615 limit:", round(percentage_within_limit_61072_mod3, 2), "%"))



# Do this with gratio and diameter on y axis
# Also, just raw difference, not just percent difference
```

# 12) Let's look at true positives and false positives/negatives for the test model vs manual tracing

```{r}

# Let's start by sorting everything, that is all the files after removing the edge axons, and eliminating all the ones with an axon diameter < 0.2 um
## So the dataset with the ground truth for the original protocol is: morph_manual_all_final_final
## The dataset with the ADS calculations for the original protocol is: morph_test_all_final_final
## The dataset with the ground truth for the new protocol is: morph_manual_all_new_final_final
## The dataset with the ADS calculations for the new protocol is: morph_test_all_new_final_final

# Let's start with the original protocol and the test model

# True positive is the number that we get when we do the fuzzyjoin
Truepositive_original <- joined_x_final_final

# False Positives - entries in the test dataset that don't match with the manual dataset
false_positives_original <- anti_join(morph_test_all_final, joined_x_final_final, 
                             by = c("x0..px." = "x0..px..y", "y0..px." = "y0..px..y"))

# False Negatives - entries in the manual dataset that don't match with the test dataset
false_negatives_original <- anti_join(morph_manual_all_final, joined_x_final_final, 
                             by = c("x0..px." = "x0..px..x", "y0..px." = "y0..px..x"))

# Count the results
tp_count_original <- nrow(joined_x_final_final)  # True Positives
fp_count_original <- nrow(false_positives_original)
fn_count_original <- nrow(false_negatives_original)
total_count_original <- tp_count_original + fp_count_original + fn_count_original  # Total considered detections

# Print the counts or ratios
cat("True Positives Count: ", tp_count_original, "\n")
cat("False Positives Count: ", fp_count_original, "\n")
cat("False Negatives Count: ", fn_count_original, "\n")
cat("True Positives Ratio: ", tp_count_original / total_count_original, "\n")
cat("False Positives Ratio: ", fp_count_original / total_count_original, "\n")
cat("False Negatives Ratio: ", fn_count_original / total_count_original, "\n")


# Now let's do the new protocol and test model

# True positive is the number that we get when we do the fuzzyjoin
#Truepositive_new <- model_compare_gratio_difference_all_new

# False Positives - entries in the test dataset that don't match with the manual dataset
#false_positives_new <- anti_join(morph_test_all_new_final_final, joined_x_final_final_new, 
                             #by = c("x0..px." = "x0..px..y", "y0..px." = "y0..px..y"))

# False Negatives - entries in the manual dataset that don't match with the test dataset
#false_negatives_new <- anti_join(morph_manual_all_new_final_final, joined_x_final_final_new, 
                             #by = c("x0..px." = "x0..px..x", "y0..px." = "y0..px..x"))

# Count the results
#tp_count_new <- nrow(joined_x_final_final_new)  # True Positives
#fp_count_new <- nrow(false_positives_new)
#fn_count_new <- nrow(false_negatives_new)
#total_count_new <- tp_count_new + fp_count_new + fn_count_new  # Total considered detections

# Print the counts or ratios
#cat("True Positives Count: ", tp_count_new, "\n")
#cat("False Positives Count: ", fp_count_new, "\n")
#cat("False Negatives Count: ", fn_count_new, "\n")
#cat("True Positives Ratio: ", tp_count_new / total_count_new, "\n")
#cat("False Positives Ratio: ", fp_count_new / total_count_new, "\n")
#cat("False Negatives Ratio: ", fn_count_new / total_count_new, "\n")


# Now let's do the original protocol and model_3

# True positive is the number that we get when we do the fuzzyjoin
#Truepositive_original <- model_compare_man_test_all

# False Positives - entries in the test dataset that don't match with the manual dataset
#false_positives_original <- anti_join(morph_test_all_final, model_compare_man_test_all, by = c("x0..px." = "x0..px..y", "y0..px." = "y0..px..y"))

# False Negatives - entries in the manual dataset that don't match with the test dataset
#false_negatives_original <- anti_join(morph_manual_all_final, model_compare_man_test_all, by = c("x0..px." = "x0..px..x", "y0..px." = "y0..px..x"))

# Count the results
#tp_count_original <- nrow(model_compare_man_test_all)  # True Positives
#fp_count_original <- nrow(false_positives)
#fn_count_original <- nrow(false_negatives)
#total_count_original <- tp_count + fp_count + fn_count  # Total considered detections

# Print the counts or ratios
#cat("True Positives Count: ", tp_count, "\n")
#cat("False Positives Count: ", fp_count, "\n")
#cat("False Negatives Count: ", fn_count, "\n")
#cat("True Positives Ratio: ", tp_count / total_count, "\n")
#cat("False Positives Ratio: ", fp_count / total_count, "\n")
#cat("False Negatives Ratio: ", fn_count / total_count, "\n")


# Now let's do the new protocol and model_3

# True positive is the number that we get when we do the fuzzyjoin
#Truepositive_original <- model_compare_man_test_all

# False Positives - entries in the test dataset that don't match with the manual dataset
#false_positives_original <- anti_join(morph_test_all_final, model_compare_man_test_all, by = c("x0..px." = "x0..px..y", "y0..px." = "y0..px..y"))

# False Negatives - entries in the manual dataset that don't match with the test dataset
#false_negatives_original <- anti_join(morph_manual_all_final, model_compare_man_test_all, by = c("x0..px." = "x0..px..x", "y0..px." = "y0..px..x"))

# Count the results
#tp_count_original <- nrow(model_compare_man_test_all)  # True Positives
#fp_count_original <- nrow(false_positives)
#fn_count_original <- nrow(false_negatives)
#total_count_original <- tp_count + fp_count + fn_count  # Total considered detections

# Print the counts or ratios
#cat("True Positives Count: ", tp_count, "\n")
#cat("False Positives Count: ", fp_count, "\n")
#cat("False Negatives Count: ", fn_count, "\n")
#cat("True Positives Ratio: ", tp_count / total_count, "\n")
#cat("False Positives Ratio: ", fp_count / total_count, "\n")
#cat("False Negatives Ratio: ", fn_count / total_count, "\n")


```

# 13) Let's do some work on model_3 and 61073

```{r}
# Let's start by importing our data
morph_model3_61073 <- read.table("Image61073/Morpho_3_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_61073 <- read.table("Image61073/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_model3_61073$name = "3"
morph_man_61073$name = "manual"

# Let's combine the manual and test (auto) datasets together
joined_data_man_model3_61073 = rbind(morph_man_61073, morph_model3_61073)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_model3_61073_selection = subset(joined_data_man_model3_61073, axon_diam..um. >= 0.2)

# Let's do it for the manual and test datasets separately
morph_man_61073_selection = subset(morph_man_61073, axon_diam..um. >= 0.2)
morph_model3_61073_selection = subset(morph_model3_61073, axon_diam..um. >= 0.2)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61073) so:
# Exclude all rows where x0 (px) < 550 or x0 (px) > 3900 and y0 (px) < 250 or y0 (px) > 3650
joined_data_man_model3_61073_final = subset(joined_data_man_model3_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_61073_final = subset(morph_man_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)
morph_model3_61073_final = subset(morph_model3_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_model3_61073 = difference_inner_join(morph_man_61073_final, morph_model3_61073_final, by = c("x0..px.", "y0..px."), max_dist = 10 )

# Now let's do the original and model_3

# True positive is the number that we get when we do the fuzzyjoin
Truepositive_model3 <- model_compare_man_model3_61073

# False Positives - entries in the test dataset that don't match with the manual dataset
false_positives_model3 <- anti_join(morph_model3_61073_final, model_compare_man_model3_61073,
                             by = c("x0..px." = "x0..px..y", "y0..px." = "y0..px..y"))

# False Negatives - entries in the manual dataset that don't match with the test dataset
false_negatives_model3 <- anti_join(morph_man_61073_final, model_compare_man_model3_61073, 
                             by = c("x0..px." = "x0..px..x", "y0..px." = "y0..px..x"))

# Count the results
tp_count_model3 <- nrow(model_compare_man_model3_61073)  # True Positives
fp_count_model3 <- nrow(false_positives_model3)
fn_count_model3 <- nrow(false_negatives_model3)
total_count_model3 <- tp_count_model3 + fp_count_model3 + fn_count_model3  # Total considered detections

# Print the counts or ratios
cat("True Positives Count: ", tp_count_model3, "\n")
cat("False Positives Count: ", fp_count_model3, "\n")
cat("False Negatives Count: ", fn_count_model3, "\n")
cat("True Positives Ratio: ", tp_count_model3 / total_count_model3, "\n")
cat("False Positives Ratio: ", fp_count_model3 / total_count_model3, "\n")
cat("False Negatives Ratio: ", fn_count_model3 / total_count_model3, "\n")
```

# 13) Let's do some work on model_A and 434

```{r}
# Let's start by importing our data
morph_modelA_434 <- read.table("Image434/Morpho_A_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_434 <- read.table("Image434/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_modelA_434$name = "A"
morph_man_434$name = "manual"

# Let's combine the manual and test (auto) datasets together
joined_data_man_modelA_434 = rbind(morph_man_434, morph_modelA_434)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_modelA_434_selection = subset(joined_data_man_modelA_434, axon_diam..um. >= 0.2)

# Let's do it for the manual and test datasets separately
morph_man_434_selection = subset(morph_man_434, axon_diam..um. >= 0.2)
morph_modelA_434_selection = subset(morph_modelA_434, axon_diam..um. >= 0.2)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61073) so:
# Exclude all rows where x0 (px) < 550 or x0 (px) > 3900 and y0 (px) < 250 or y0 (px) > 3650
joined_data_man_modelA_434_final = subset(joined_data_man_modelA_434_selection, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 300 & y0..px. <= 3500)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_434_final = subset(morph_man_434_selection, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 300 & y0..px. <= 3500)
morph_modelA_434_final = subset(morph_modelA_434_selection, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 300 & y0..px. <= 3500)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_modelA_434 = difference_inner_join(morph_man_434_final, morph_modelA_434_final, by = c("x0..px.", "y0..px."), max_dist = 10 )

# Now let's do the original and model_3

# True positive is the number that we get when we do the fuzzyjoin
Truepositive_modelA <- model_compare_man_modelA_434

# False Positives - entries in the test dataset that don't match with the manual dataset
false_positives_modelA <- anti_join(morph_modelA_434_final, model_compare_man_modelA_434,
                             by = c("x0..px." = "x0..px..y", "y0..px." = "y0..px..y"))

# False Negatives - entries in the manual dataset that don't match with the test dataset
false_negatives_modelA <- anti_join(morph_man_434_final, model_compare_man_modelA_434, 
                             by = c("x0..px." = "x0..px..x", "y0..px." = "y0..px..x"))

# Count the results
tp_count_modelA <- nrow(model_compare_man_modelA_434)  # True Positives
fp_count_modelA <- nrow(false_positives_modelA)
fn_count_modelA <- nrow(false_negatives_modelA)
total_count_modelA <- tp_count_modelA + fp_count_modelA + fn_count_modelA  # Total considered detections

# Print the counts or ratios
cat("True Positives Count: ", tp_count_modelA, "\n")
cat("False Positives Count: ", fp_count_modelA, "\n")
cat("False Negatives Count: ", fn_count_modelA, "\n")
cat("True Positives Ratio: ", tp_count_modelA / total_count_modelA, "\n")
cat("False Positives Ratio: ", fp_count_modelA / total_count_modelA, "\n")
cat("False Negatives Ratio: ", fn_count_modelA / total_count_modelA, "\n")
```


# Now let's look at the test model and 61073

```{r}
# Let's start by importing our data
morph_test_61073 <- read.table("Image61073/Morpho_test_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_61073 <- read.table("Image61073/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_test_61073$name = "test"
morph_man_61073$name = "manual"

# Let's combine the manual and test (auto) datasets together
joined_data_man_test_61073 = rbind(morph_man_61073, morph_test_61073)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_test_61073_selection = subset(joined_data_man_test_61073, axon_diam..um. >= 0.2)
joined_data_man_test_61073_selection = subset(joined_data_man_test_61073_selection, myelin_thickness..um. > 0.01)

# Let's do it for the manual and test datasets separately
morph_man_61073_selection = subset(morph_man_61073, axon_diam..um. >= 0.2)
morph_man_61073_selection = subset(morph_man_61073_selection, myelin_thickness..um. > 0.01)
morph_test_61073_selection = subset(morph_test_61073, axon_diam..um. >= 0.2)
morph_test_61073_selection = subset(morph_test_61073_selection, myelin_thickness..um. > 0.01)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61073) so:
# Exclude all rows where x0 (px) < 550 or x0 (px) > 3900 and y0 (px) < 250 or y0 (px) > 3650
joined_data_man_test_61073_final = subset(joined_data_man_test_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_61073_final = subset(morph_man_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)
morph_test_61073_final = subset(morph_test_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_test_61073 = difference_inner_join(morph_man_61073_final, morph_test_61073_final, by = c("x0..px.", "y0..px."), max_dist = 100 ) # Here we initially used a maximum distance of 10 pixels, this turned out to be too narrow, so we changed it to 100


# True positive is the number that we get when we do the fuzzyjoin
Truepositive_original_61073 <- model_compare_man_test_61073

# False Positives - entries in the test dataset that don't match with the manual dataset
false_positives_original_61073 <- anti_join(morph_test_61073_final, model_compare_man_test_61073, 
                             by = c("x0..px." = "x0..px..y", "y0..px." = "y0..px..y"))

# False Negatives - entries in the manual dataset that don't match with the test dataset
false_negatives_original_61073 <- anti_join(morph_man_61073_final, model_compare_man_test_61073, 
                             by = c("x0..px." = "x0..px..x", "y0..px." = "y0..px..x"))

# Count the results
tp_count_original_61073 <- nrow(model_compare_man_test_61073)  # True Positives
fp_count_original_61073 <- nrow(false_positives_original_61073)
fn_count_original_61073 <- nrow(false_negatives_original_61073)
total_count_original_61073 <- tp_count_original_61073 + fp_count_original_61073 + fn_count_original_61073  # Total considered detections

# Print the counts or ratios
cat("True Positives Count: ", tp_count_original_61073, "\n")
cat("False Positives Count: ", fp_count_original_61073, "\n")
cat("False Negatives Count: ", fn_count_original_61073, "\n")
cat("True Positives Ratio: ", tp_count_original_61073 / total_count_original_61073, "\n")
cat("False Positives Ratio: ", fp_count_original_61073 / total_count_original_61073, "\n")
cat("False Negatives Ratio: ", fn_count_original_61073 / total_count_original_61073, "\n")
```

# Now let's look at the test model and 434

```{r}
# True positive is the number that we get when we do the fuzzyjoin
Truepositive_original_434 <- model_compare_man_test_434

# False Positives - entries in the test dataset that don't match with the manual dataset
false_positives_original_434 <- anti_join(morph_test_434_final, model_compare_man_test_434, 
                             by = c("x0..px." = "x0..px..y", "y0..px." = "y0..px..y"))

# False Negatives - entries in the manual dataset that don't match with the test dataset
false_negatives_original_434 <- anti_join(morph_man_434_final, model_compare_man_test_434, 
                             by = c("x0..px." = "x0..px..x", "y0..px." = "y0..px..x"))

# Count the results
tp_count_original_434 <- nrow(model_compare_man_test_434)  # True Positives
fp_count_original_434 <- nrow(false_positives_original_434)
fn_count_original_434 <- nrow(false_negatives_original_434)
total_count_original_434 <- tp_count_original_434 + fp_count_original_434 + fn_count_original_434  # Total considered detections

# Print the counts or ratios
cat("True Positives Count: ", tp_count_original_434, "\n")
cat("False Positives Count: ", fp_count_original_434, "\n")
cat("False Negatives Count: ", fn_count_original_434, "\n")
cat("True Positives Ratio: ", tp_count_original_434 / total_count_original_434, "\n")
cat("False Positives Ratio: ", fp_count_original_434 / total_count_original_434, "\n")
cat("False Negatives Ratio: ", fn_count_original_434 / total_count_original_434, "\n")
```

# Let's do some work on model_12 and 61073

```{r}
# Let's start by importing our data
morph_model12_61073 <- read.table("Image61073/Morpho_12_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_61073 <- read.table("Image61073/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_model12_61073$name = "12"
morph_man_61073$name = "manual"

# Let's combine the manual and test (auto) datasets together
joined_data_man_model12_61073 = rbind(morph_man_61073, morph_model12_61073)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_model12_61073_selection = subset(joined_data_man_model12_61073, axon_diam..um. >= 0.2)
joined_data_man_model12_61073_selection = subset(joined_data_man_model12_61073_selection, myelin_thickness..um. > 0.01)


# Let's do it for the manual and test datasets separately
morph_man_61073_selection = subset(morph_man_61073, axon_diam..um. >= 0.2)
morph_man_61073_selection = subset(morph_man_61073_selection, myelin_thickness..um. > 0.01)
morph_model12_61073_selection = subset(morph_model12_61073, axon_diam..um. >= 0.2)
morph_model12_61073_selection = subset(morph_model12_61073_selection, myelin_thickness..um. > 0.01)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61073) so:
# Exclude all rows where x0 (px) < 550 or x0 (px) > 3900 and y0 (px) < 250 or y0 (px) > 3650
joined_data_man_model12_61073_final = subset(joined_data_man_model12_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_61073_final = subset(morph_man_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)
morph_model12_61073_final = subset(morph_model12_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_model12_61073 = difference_inner_join(morph_man_61073_final, morph_model12_61073_final, by = c("x0..px.", "y0..px."), max_dist = 100 )

# Now let's do the original and model_3

# True positive is the number that we get when we do the fuzzyjoin
Truepositive_model12 <- model_compare_man_model12_61073

# False Positives - entries in the test dataset that don't match with the manual dataset
false_positives_model12 <- anti_join(morph_model12_61073_final, model_compare_man_model12_61073,
                             by = c("x0..px." = "x0..px..y", "y0..px." = "y0..px..y"))

# False Negatives - entries in the manual dataset that don't match with the test dataset
false_negatives_model12 <- anti_join(morph_man_61073_final, model_compare_man_model12_61073, 
                             by = c("x0..px." = "x0..px..x", "y0..px." = "y0..px..x"))

# Count the results
tp_count_model12 <- nrow(model_compare_man_model12_61073)  # True Positives
fp_count_model12 <- nrow(false_positives_model12)
fn_count_model12 <- nrow(false_negatives_model12)
total_count_model12 <- tp_count_model12 + fp_count_model12 + fn_count_model12  # Total considered detections

# Print the counts or ratios
cat("True Positives Count: ", tp_count_model12, "\n")
cat("False Positives Count: ", fp_count_model12, "\n")
cat("False Negatives Count: ", fn_count_model12, "\n")
cat("True Positives Ratio: ", tp_count_model12 / total_count_model12, "\n")
cat("False Positives Ratio: ", fp_count_model12 / total_count_model12, "\n")
cat("False Negatives Ratio: ", fn_count_model12 / total_count_model12, "\n")
```

# Let's do some work on model_13 and 61073

```{r}
# Let's start by importing our data
morph_model13_61073 <- read.table("Image61073/Morpho_13_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_61073 <- read.table("Image61073/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_model13_61073$name = "13"
morph_man_61073$name = "manual"

# Let's combine the manual and test (auto) datasets together
joined_data_man_model13_61073 = rbind(morph_man_61073, morph_model13_61073)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_model13_61073_selection = subset(joined_data_man_model13_61073, axon_diam..um. >= 0.2)
joined_data_man_model13_61073_selection = subset(joined_data_man_model13_61073_selection, myelin_thickness..um. > 0.01)

# Let's do it for the manual and test datasets separately
morph_man_61073_selection = subset(morph_man_61073, axon_diam..um. >= 0.2)
morph_man_61073_selection = subset(morph_man_61073_selection, myelin_thickness..um. > 0.01)
morph_model13_61073_selection = subset(morph_model13_61073, axon_diam..um. >= 0.2)
morph_model13_61073_selection = subset(morph_model13_61073_selection, myelin_thickness..um. > 0.01)


# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61073) so:
# Exclude all rows where x0 (px) < 550 or x0 (px) > 3900 and y0 (px) < 250 or y0 (px) > 3650
joined_data_man_model13_61073_final = subset(joined_data_man_model13_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_61073_final = subset(morph_man_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)
morph_model13_61073_final = subset(morph_model13_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_model13_61073 = difference_inner_join(morph_man_61073_final, morph_model13_61073_final, by = c("x0..px.", "y0..px."), max_dist = 100 )

# Now let's do the original and model_13

# True positive is the number that we get when we do the fuzzyjoin
Truepositive_model13 <- model_compare_man_model13_61073

# False Positives - entries in the test dataset that don't match with the manual dataset
false_positives_model13 <- anti_join(morph_model13_61073_final, model_compare_man_model13_61073,
                             by = c("x0..px." = "x0..px..y", "y0..px." = "y0..px..y"))

# False Negatives - entries in the manual dataset that don't match with the test dataset
false_negatives_model13 <- anti_join(morph_man_61073_final, model_compare_man_model13_61073, 
                             by = c("x0..px." = "x0..px..x", "y0..px." = "y0..px..x"))

# Count the results
tp_count_model13 <- nrow(model_compare_man_model13_61073)  # True Positives
fp_count_model13 <- nrow(false_positives_model13)
fn_count_model13 <- nrow(false_negatives_model13)
total_count_model13 <- tp_count_model13 + fp_count_model13 + fn_count_model13  # Total considered detections

# Print the counts or ratios
cat("True Positives Count: ", tp_count_model13, "\n")
cat("False Positives Count: ", fp_count_model13, "\n")
cat("False Negatives Count: ", fn_count_model13, "\n")
cat("True Positives Ratio: ", tp_count_model13 / total_count_model13, "\n")
cat("False Positives Ratio: ", fp_count_model13 / total_count_model13, "\n")
cat("False Negatives Ratio: ", fn_count_model13 / total_count_model13, "\n")
```

# Let's do some work on model_14 and 61073

```{r}
# Let's start by importing our data
morph_model14_61073 <- read.table("Image61073/Morpho_14_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_61073 <- read.table("Image61073/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_model14_61073$name = "14"
morph_man_61073$name = "manual"

# Let's combine the manual and test (auto) datasets together
joined_data_man_model14_61073 = rbind(morph_man_61073, morph_model14_61073)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_model14_61073_selection = subset(joined_data_man_model14_61073, axon_diam..um. >= 0.2)
joined_data_man_model14_61073_selection = subset(joined_data_man_model14_61073_selection, myelin_thickness..um. > 0.01)

# Let's do it for the manual and test datasets separately
morph_man_61073_selection = subset(morph_man_61073, axon_diam..um. >= 0.2)
morph_man_61073_selection = subset(morph_man_61073_selection, myelin_thickness..um. > 0.01)
morph_model14_61073_selection = subset(morph_model14_61073, axon_diam..um. >= 0.2)
morph_model14_61073_selection = subset(morph_model14_61073_selection, myelin_thickness..um. > 0.01)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61073) so:
# Exclude all rows where x0 (px) < 550 or x0 (px) > 3900 and y0 (px) < 250 or y0 (px) > 3650
joined_data_man_model14_61073_final = subset(joined_data_man_model14_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_61073_final = subset(morph_man_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)
morph_model14_61073_final = subset(morph_model14_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_model14_61073 = difference_inner_join(morph_man_61073_final, morph_model14_61073_final, by = c("x0..px.", "y0..px."), max_dist = 100 )

# Now let's do the original and model_14

# True positive is the number that we get when we do the fuzzyjoin
Truepositive_model14 <- model_compare_man_model14_61073

# False Positives - entries in the test dataset that don't match with the manual dataset
false_positives_model14 <- anti_join(morph_model14_61073_final, model_compare_man_model14_61073,
                             by = c("x0..px." = "x0..px..y", "y0..px." = "y0..px..y"))

# False Negatives - entries in the manual dataset that don't match with the test dataset
false_negatives_model14 <- anti_join(morph_man_61073_final, model_compare_man_model14_61073, 
                             by = c("x0..px." = "x0..px..x", "y0..px." = "y0..px..x"))

# Count the results
tp_count_model14 <- nrow(model_compare_man_model14_61073)  # True Positives
fp_count_model14 <- nrow(false_positives_model14)
fn_count_model14 <- nrow(false_negatives_model14)
total_count_model14 <- tp_count_model14 + fp_count_model14 + fn_count_model14  # Total considered detections

# Print the counts or ratios
cat("True Positives Count: ", tp_count_model14, "\n")
cat("False Positives Count: ", fp_count_model14, "\n")
cat("False Negatives Count: ", fn_count_model14, "\n")
cat("True Positives Ratio: ", tp_count_model14 / total_count_model14, "\n")
cat("False Positives Ratio: ", fp_count_model14 / total_count_model14, "\n")
cat("False Negatives Ratio: ", fn_count_model14 / total_count_model14, "\n")
```

# Let's do some work on model_15 and 61073

```{r}
# Let's start by importing our data
morph_model15_61073 <- read.table("Image61073/Morpho_15_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_61073 <- read.table("Image61073/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_model15_61073$name = "15"
morph_man_61073$name = "manual"

# Let's combine the manual and test (auto) datasets together
joined_data_man_model15_61073 = rbind(morph_man_61073, morph_model15_61073)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_model15_61073_selection = subset(joined_data_man_model15_61073, axon_diam..um. >= 0.2)
joined_data_man_model15_61073_selection = subset(joined_data_man_model15_61073_selection, myelin_thickness..um. > 0.01)

# Let's do it for the manual and test datasets separately
morph_man_61073_selection = subset(morph_man_61073, axon_diam..um. >= 0.2)
morph_man_61073_selection = subset(morph_man_61073_selection, myelin_thickness..um. > 0.01)
morph_model15_61073_selection = subset(morph_model15_61073, axon_diam..um. >= 0.2)
morph_model15_61073_selection = subset(morph_model15_61073_selection, myelin_thickness..um. > 0.01)


# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61073) so:
# Exclude all rows where x0 (px) < 550 or x0 (px) > 3900 and y0 (px) < 250 or y0 (px) > 3650
joined_data_man_model15_61073_final = subset(joined_data_man_model15_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_61073_final = subset(morph_man_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)
morph_model15_61073_final = subset(morph_model15_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_model15_61073 = difference_inner_join(morph_man_61073_final, morph_model15_61073_final, by = c("x0..px.", "y0..px."), max_dist = 50 )

# Now let's do the original and model_13

# True positive is the number that we get when we do the fuzzyjoin
Truepositive_model15 <- model_compare_man_model15_61073

# False Positives - entries in the test dataset that don't match with the manual dataset
false_positives_model15 <- anti_join(morph_model15_61073_final, model_compare_man_model15_61073,
                             by = c("x0..px." = "x0..px..y", "y0..px." = "y0..px..y"))

# False Negatives - entries in the manual dataset that don't match with the test dataset
false_negatives_model15 <- anti_join(morph_man_61073_final, model_compare_man_model15_61073, 
                             by = c("x0..px." = "x0..px..x", "y0..px." = "y0..px..x"))

# Count the results
tp_count_model15 <- nrow(model_compare_man_model15_61073)  # True Positives
fp_count_model15 <- nrow(false_positives_model15)
fn_count_model15 <- nrow(false_negatives_model15)
total_count_model15 <- tp_count_model15 + fp_count_model15 + fn_count_model15  # Total considered detections

# Print the counts or ratios
cat("True Positives Count: ", tp_count_model15, "\n")
cat("False Positives Count: ", fp_count_model15, "\n")
cat("False Negatives Count: ", fn_count_model15, "\n")
cat("True Positives Ratio: ", tp_count_model15 / total_count_model15, "\n")
cat("False Positives Ratio: ", fp_count_model15 / total_count_model15, "\n")
cat("False Negatives Ratio: ", fn_count_model15 / total_count_model15, "\n")
```

# Showing how we got to the best model (using the test image from original protocol to check for overfitting too)
# 21) ADS data - Original protocol (61073)

## First we will compare model 12 and manual datasets on image 61073

## Settings

```{r}
# Let's start by importing our data
morph_model12_61073 <- read.table("Image61073/Morpho_12_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_61073 <- read.table("Image61073/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_model12_61073$name = "12"
morph_man_61073$name = "manual"

# Let's combine the manual and 12 (auto) datasets together
joined_data_man_model12_61073 = rbind(morph_man_61073, morph_model12_61073)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_model12_61073_selection = subset(joined_data_man_model12_61073, axon_diam..um. >= 0.2)

# Let's do it for the manual and 12 datasets separately
morph_man_61073_selection = subset(morph_man_61073, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)
morph_model12_61073_selection = subset(morph_model12_61073, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61073) so:
# Exclude all rows where x0 (px) < 550 or x0 (px) > 3900 and y0 (px) < 250 or y0 (px) > 3650
joined_data_man_model12_61073_final = subset(joined_data_man_model12_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_61073_final = subset(morph_man_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)
morph_model12_61073_final = subset(morph_model12_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_model12_61073 = difference_inner_join(morph_man_61073_final, morph_model12_61073_final, by = c("x0..px.", "y0..px."), max_dist = 100 )
```

## Statistics

```{r}
# First, let's check if the data follows a normal distribution using a Shapiro-Wilk model12 for Normality
shapiro.test(joined_data_man_model12_61073_final$gratio[joined_data_man_model12_61073_final$name == "manual"])
shapiro.test(joined_data_man_model12_61073_final$gratio[joined_data_man_model12_61073_final$name == "12"])

# Okay, we see that for both we have a (p>0.05), which means we cannot reject the null-hypothesis and thus the data can be considered to follow a normal distribution, so we should perform a parametric test:

# Let's perform a paired t-model12 on my filtered data
t_test_result_61073 <- t.test(model_compare_man_model12_61073$gratio.x, model_compare_man_model12_61073$gratio.y, paired = TRUE)
t_test_result_61073

### CHANGE: We get a p-value of 0.0322. Since the p-value is lower than 0.05, we can reject the null hypothesis and say that there is a statistically significant difference between the two methods of measurement.

# Now we need to figure out the effect size
# First we calculate mean difference
mean_difference_61073 <- mean(model_compare_man_model12_61073$gratio.x - model_compare_man_model12_61073$gratio.y)

# Calculate standard deviation of differences
sd_difference_61073 <- sd(model_compare_man_model12_61073$gratio.x - model_compare_man_model12_61073$gratio.y)

# Calculate Cohen's d
effect_size_61073 <- mean_difference_61073 / sd_difference_61073

# Display results
cat("Mean Difference:", mean_difference_61073, "\n")
cat("Effect Size (Cohen's d):", effect_size_61073, "\n")

# The mean difference we get is X, this is higher than the maximum difference we concluded was acceptable from the variability comparison.

# Let's calculate the average of the absolute difference of g-ratios

# Calculate the absolute differences
model_compare_man_model12_61073$abs_diff_gratio <- abs(model_compare_man_model12_61073$gratio.x - model_compare_man_model12_61073$gratio.y)

# Compute the average of the absolute differences
average_abs_difference_61073 <- mean(model_compare_man_model12_61073$abs_diff_gratio)

# Display the result
print(paste("Average absolute G-ratio difference:", average_abs_difference_61073))
```

## Graphs

```{r}
# Let's compare the model12 model and manual tracings
joined_data_man_model12_61073_final$name <- factor(joined_data_man_model12_61073_final$name, levels = c("manual", "12"))

model12_manual_graph <- ggplot(joined_data_man_model12_61073_final, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 3, alpha = 0.5, position = position_jitter(width = .1)) +  # Match point size and alpha
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "12" = "Model 12")) +
  scale_y_continuous(breaks = seq(0.45, 0.95, 0.05), limits = c(0.45, 0.95), expand = c(0, 0)) +
  scale_color_manual(values = c("manual" = "#00BFC4", "12" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of ground truth vs model 12",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15), # Match font size
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5), # Match title size and style
    axis.title.x = element_text(size = 16, face = "bold"), # Match axis title size and style
    axis.title.y = element_text(size = 16, face = "bold"), # Match axis title size and style
    axis.text.x = element_text(size = 15),  # Match axis text size
    axis.text.y = element_text(size = 15),  # Match axis text size
    legend.position = "none"
  ) #+
  #geom_hline(yintercept = seq(0.45, 0.95, by = 0.05), linetype = "dashed", color = "gray")  # Keep the horizontal grid lines

# Add p-value annotation with updated position and text size
model12_manual_graph <- model12_manual_graph + annotate("text", x = 1.5, y = 0.925, label = sprintf("p = %.4f", t_test_result_61073$p.value), size = 6, color = "black")

# Print the updated plot
print(model12_manual_graph)

ggsave("Image61073/geom_point_gratio_man_vs_model12_61073_dashed.png", bg = "white", dpi = 200)

```

```{r, warning=FALSE}
# Let's plot the gratio of the model against the gratio of the manual tracings
my.formula_61073 <- y~x

# Update the graph to match the style of the first graph
model_compare_graph <- ggplot(model_compare_man_model12_61073, aes(x = gratio.x, y = gratio.y)) +
  geom_point(shape = 16, size = 5, alpha = 0.6) +  # Match point size and transparency
  geom_abline(slope = 1, intercept = 0, linetype = "dotted", color = "red", size = 1) +  # Match the y=x line style
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +
  stat_poly_eq(formula = my.formula_61073, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # Adjust label size for equation
  scale_x_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1), expand = c(0, 0)) + # Match x-axis scale
  scale_y_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1), expand = c(0, 0)) + # Match y-axis scale
  labs(
    title = "Comparison of G-ratio Measurements",
    x = "G-ratio of the Ground Truth", # Updated x label
    y = "G-ratio of Model 12" # Updated y label
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    legend.position = "none"
  )

# Print the updated plot
print(model_compare_graph)

ggsave("Image61073/model12_vs_manual_line_of_fit.png", dpi = 200)

```

```{r}
# Let's create a violin graph to see the difference in distributions
ggplot(joined_data_man_model12_61073_final, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +  # Adding a boxplot inside the violin for more detail
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
  theme_minimal() +
  scale_x_discrete(labels = c("Ground Truth", "ADS model12 model")) +
  scale_fill_manual(values = c(manual = "blue", model12 = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS model12 model")) +
  theme(legend.position = "none")
```

```{r}
# Lets add a variable that shows the gratio difference
# Assuming model_compare already contains the gratio values as gratio.x (manual) and gratio.y (auto)
model_compare_gratio_difference_61073 <- model_compare_man_model12_61073 %>%
  mutate(diff_gratio = gratio.x - gratio.y,
         percent_diff_gratio = ((gratio.x - gratio.y) / gratio.y) * 100)

# Plotting percent differences
# First with gratio on x-axis
ggplot(model_compare_gratio_difference_61073, aes(x = gratio.x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Gratio",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_61073, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Then with axon diameter on x axis
ggplot(model_compare_gratio_difference_61073, aes(x = axon_diam..um..x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Axon diameter (um)",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_61073, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Let's see how many points are within our limit
within_limit_count_61073 <- model_compare_gratio_difference_61073 %>%
  filter(abs(diff_gratio) <= 0.011615) %>%
  summarise(count = n())

total_points_61073 <- nrow(model_compare_gratio_difference_61073)

proportion_within_limit_61073 <- within_limit_count_61073 / total_points_61073

percentage_within_limit_61073 <- proportion_within_limit_61073 * 100

print(paste("Percentage of points within ±0.011615 limit:", round(percentage_within_limit_61073, 2), "%"))

# Do this with gratio and diameter on y axis
# Also, just raw difference, not just percent difference
```


## Now we will compare model 13 and manual datasets on image 61073

## Settings

```{r}
# Let's start by importing our data
morph_model13_61073 <- read.table("Image61073/Morpho_13_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_61073 <- read.table("Image61073/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_model13_61073$name = "13"
morph_man_61073$name = "manual"

# Let's combine the manual and 13 (auto) datasets together
joined_data_man_model13_61073 = rbind(morph_man_61073, morph_model13_61073)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_model13_61073_selection = subset(joined_data_man_model13_61073, axon_diam..um. >= 0.2)

# Let's do it for the manual and 13 datasets separately
morph_man_61073_selection = subset(morph_man_61073, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)
morph_model13_61073_selection = subset(morph_model13_61073, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61073) so:
# Exclude all rows where x0 (px) < 550 or x0 (px) > 3900 and y0 (px) < 250 or y0 (px) > 3650
joined_data_man_model13_61073_final = subset(joined_data_man_model13_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_61073_final = subset(morph_man_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)
morph_model13_61073_final = subset(morph_model13_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_model13_61073 = difference_inner_join(morph_man_61073_final, morph_model13_61073_final, by = c("x0..px.", "y0..px."), max_dist = 100 )
```

## Statistics

```{r}
# First, let's check if the data follows a normal distribution using a Shapiro-Wilk model13 for Normality
shapiro.test(joined_data_man_model13_61073_final$gratio[joined_data_man_model13_61073_final$name == "manual"])
shapiro.test(joined_data_man_model13_61073_final$gratio[joined_data_man_model13_61073_final$name == "13"])

# Okay, we see that for both we have a (p>0.05), which means we cannot reject the null-hypothesis and thus the data can be considered to follow a normal distribution, so we should perform a parametric test:

# Let's perform a paired t-model13 on my filtered data
t_test_result_61073 <- t.test(model_compare_man_model13_61073$gratio.x, model_compare_man_model13_61073$gratio.y, paired = TRUE)
t_test_result_61073

### CHANGE: We get a p-value of 0.0322. Since the p-value is lower than 0.05, we can reject the null hypothesis and say that there is a statistically significant difference between the two methods of measurement.

# Now we need to figure out the effect size
# First we calculate mean difference
mean_difference_61073 <- mean(model_compare_man_model13_61073$gratio.x - model_compare_man_model13_61073$gratio.y)

# Calculate standard deviation of differences
sd_difference_61073 <- sd(model_compare_man_model13_61073$gratio.x - model_compare_man_model13_61073$gratio.y)

# Calculate Cohen's d
effect_size_61073 <- mean_difference_61073 / sd_difference_61073

# Display results
cat("Mean Difference:", mean_difference_61073, "\n")
cat("Effect Size (Cohen's d):", effect_size_61073, "\n")

# The mean difference we get is X, this is higher than the maximum difference we concluded was acceptable from the variability comparison.

# Let's calculate the average of the absolute difference of g-ratios

# Calculate the absolute differences
model_compare_man_model13_61073$abs_diff_gratio <- abs(model_compare_man_model13_61073$gratio.x - model_compare_man_model13_61073$gratio.y)

# Compute the average of the absolute differences
average_abs_difference_61073 <- mean(model_compare_man_model13_61073$abs_diff_gratio)

# Display the result
print(paste("Average absolute G-ratio difference:", average_abs_difference_61073))
```

## Graphs

```{r}
# Let's compare the model13 model and manual tracings
joined_data_man_model13_61073_final$name <- factor(joined_data_man_model13_61073_final$name, levels = c("manual", "13"))

model13_manual_graph <- ggplot(joined_data_man_model13_61073_final, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 3, alpha = 0.5, position = position_jitter(width = .1)) +  # Match point size and alpha to model12
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "13" = "Model 13")) +  # Corrected label for model 13
  scale_y_continuous(breaks = seq(0.45, 0.95, 0.05), limits = c(0.45, 0.95), expand = c(0, 0)) +
  scale_color_manual(values = c("manual" = "#00BFC4", "13" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of ground truth vs model 13",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15), # Match font size
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5), # Match title size and style to model12
    axis.title.x = element_text(size = 16, face = "bold"), # Match axis title size and style
    axis.title.y = element_text(size = 16, face = "bold"), # Match axis title size and style
    axis.text.x = element_text(size = 15),  # Match axis text size
    axis.text.y = element_text(size = 15),  # Match axis text size
    legend.position = "none"
  ) #+
  #geom_hline(yintercept = seq(0.45, 0.95, by = 0.05), linetype = "dashed", color = "gray")  # Retain horizontal grid lines

# Add p-value annotation with updated position and text size
model13_manual_graph <- model13_manual_graph + annotate("text", x = 1.5, y = 0.925, label = sprintf("p = %.4f", t_test_result_61073$p.value), size = 6, color = "black")  # Match text size and color to model12

model13_manual_graph <- model13_manual_graph +
  geom_segment(aes(x = 1, xend = 2, y = 0.86, yend = 0.86), color = "black") + # Horizontal line
  geom_segment(aes(x = 1, xend = 1, y = 0.85, yend = 0.86), color = "black") + # Left vertical line
  geom_segment(aes(x = 2, xend = 2, y = 0.85, yend = 0.86), color = "black") + # Right vertical line
  annotate("text", x = 1.5, y = 0.87, label = "*", size = 6, color = "black")

# Print the updated plot
print(model13_manual_graph)

ggsave("Image61073/geom_point_gratio_man_vs_model13_61073_dashed.png", bg = "white", dpi = 200)

```

```{r, warning=FALSE}
# Let's plot the gratio of the model against the gratio of the manual tracings
my.formula_61073 <- y~x

# Update the graph to match the style of the model_compare_graph
model_compare_man_model13_61073_updated <- ggplot(model_compare_man_model13_61073, aes(x = gratio.x, y = gratio.y)) +
  geom_point(shape = 16, size = 5, alpha = 0.6) +  # Match point size and transparency
  geom_abline(slope = 1, intercept = 0, linetype = "dotted", color = "red", size = 1) +  # Match the y=x line style
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +
  stat_poly_eq(formula = my.formula_61073, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # Adjust label size for equation
  scale_x_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1), expand = c(0, 0)) + # Match x-axis scale
  scale_y_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1), expand = c(0, 0)) + # Match y-axis scale
  labs(
    title = "Comparison of G-ratio Measurements",
    x = "G-ratio of the Ground Truth",
    y = "G-ratio of Model 13" # Update y label to match naming style
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    legend.position = "none"
  )

# Print the updated plot
print(model_compare_man_model13_61073_updated)

ggsave("Image61073/model13_vs_manual_line_of_fit.png", dpi = 200)
```

```{r}
# Let's create a violin graph to see the difference in distributions
ggplot(joined_data_man_model13_61073_final, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +  # Adding a boxplot inside the violin for more detail
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
  theme_minimal() +
  scale_x_discrete(labels = c("Ground Truth", "ADS model13 model")) +
  scale_fill_manual(values = c(manual = "blue", model13 = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS model13 model")) +
  theme(legend.position = "none")
```

```{r}
# Lets add a variable that shows the gratio difference
# Assuming model_compare already contains the gratio values as gratio.x (manual) and gratio.y (auto)
model_compare_gratio_difference_61073 <- model_compare_man_model13_61073 %>%
  mutate(diff_gratio = gratio.x - gratio.y,
         percent_diff_gratio = ((gratio.x - gratio.y) / gratio.y) * 100)

# Plotting percent differences
# First with gratio on x-axis
ggplot(model_compare_gratio_difference_61073, aes(x = gratio.x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Gratio",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_61073, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Then with axon diameter on x axis
ggplot(model_compare_gratio_difference_61073, aes(x = axon_diam..um..x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Axon diameter (um)",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_61073, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Let's see how many points are within our limit
within_limit_count_61073 <- model_compare_gratio_difference_61073 %>%
  filter(abs(diff_gratio) <= 0.011615) %>%
  summarise(count = n())

total_points_61073 <- nrow(model_compare_gratio_difference_61073)

proportion_within_limit_61073 <- within_limit_count_61073 / total_points_61073

percentage_within_limit_61073 <- proportion_within_limit_61073 * 100

print(paste("Percentage of points within ±0.011615 limit:", round(percentage_within_limit_61073, 2), "%"))

# Do this with gratio and diameter on y axis
# Also, just raw difference, not just percent difference
```

## Now we will compare model 14 and manual datasets on image 61073

## Settings

```{r}
# Let's start by importing our data
morph_model14_61073 <- read.table("Image61073/Morpho_14_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_61073 <- read.table("Image61073/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_model14_61073$name = "14"
morph_man_61073$name = "manual"

# Let's combine the manual and 14 (auto) datasets together
joined_data_man_model14_61073 = rbind(morph_man_61073, morph_model14_61073)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_model14_61073_selection = subset(joined_data_man_model14_61073, axon_diam..um. >= 0.2)

# Let's do it for the manual and 14 datasets separately
morph_man_61073_selection = subset(morph_man_61073, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)
morph_model14_61073_selection = subset(morph_model14_61073, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61073) so:
# Exclude all rows where x0 (px) < 550 or x0 (px) > 3900 and y0 (px) < 250 or y0 (px) > 3650
joined_data_man_model14_61073_final = subset(joined_data_man_model14_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_61073_final = subset(morph_man_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)
morph_model14_61073_final = subset(morph_model14_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_model14_61073 = difference_inner_join(morph_man_61073_final, morph_model14_61073_final, by = c("x0..px.", "y0..px."), max_dist = 100 )
```

## Statistics

```{r}
# First, let's check if the data follows a normal distribution using a Shapiro-Wilk model14 for Normality
shapiro.test(joined_data_man_model14_61073_final$gratio[joined_data_man_model14_61073_final$name == "manual"])
shapiro.test(joined_data_man_model14_61073_final$gratio[joined_data_man_model14_61073_final$name == "14"])

# Okay, we see that for both we have a (p>0.05), which means we cannot reject the null-hypothesis and thus the data can be considered to follow a normal distribution, so we should perform a parametric test:

# Let's perform a paired t-model14 on my filtered data
t_test_result_61073 <- t.test(model_compare_man_model14_61073$gratio.x, model_compare_man_model14_61073$gratio.y, paired = TRUE)
t_test_result_61073

### CHANGE: We get a p-value of 0.0322. Since the p-value is lower than 0.05, we can reject the null hypothesis and say that there is a statistically significant difference between the two methods of measurement.

# Now we need to figure out the effect size
# First we calculate mean difference
mean_difference_61073 <- mean(model_compare_man_model14_61073$gratio.x - model_compare_man_model14_61073$gratio.y)

# Calculate standard deviation of differences
sd_difference_61073 <- sd(model_compare_man_model14_61073$gratio.x - model_compare_man_model14_61073$gratio.y)

# Calculate Cohen's d
effect_size_61073 <- mean_difference_61073 / sd_difference_61073

# Display results
cat("Mean Difference:", mean_difference_61073, "\n")
cat("Effect Size (Cohen's d):", effect_size_61073, "\n")

# The mean difference we get is X, this is higher than the maximum difference we concluded was acceptable from the variability comparison.

# Let's calculate the average of the absolute difference of g-ratios

# Calculate the absolute differences
model_compare_man_model14_61073$abs_diff_gratio <- abs(model_compare_man_model14_61073$gratio.x - model_compare_man_model14_61073$gratio.y)

# Compute the average of the absolute differences
average_abs_difference_61073 <- mean(model_compare_man_model14_61073$abs_diff_gratio)

# Display the result
print(paste("Average absolute G-ratio difference:", average_abs_difference_61073))
```

## Graphs

```{r}
# Let's compare the model14 model and manual tracings
model14_manual_graph <- ggplot(joined_data_man_model14_61073_final, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 3, alpha = 0.5, position = position_jitter(width = .1)) +  # Match point size and alpha to model13
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "model14" = "ADS model14 model")) +  # Ensure labels are specific to model14
  scale_y_continuous(breaks = seq(0.45, 0.95, 0.05), limits = c(0.45, 0.95), expand = c(0, 0)) +
  scale_color_manual(values = c("manual" = "#00BFC4", "14" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of Ground truth vs model_14",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15), # Match font size
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5), # Match title size and style to model13
    axis.title.x = element_text(size = 16, face = "bold"), # Match axis title size and style
    axis.title.y = element_text(size = 16, face = "bold"), # Match axis title size and style
    axis.text.x = element_text(size = 15),  # Match axis text size
    axis.text.y = element_text(size = 15),  # Match axis text size
    legend.position = "none"
  ) #+
  #geom_hline(yintercept = seq(0.45, 0.95, by = 0.05), linetype = "dashed", color = "gray")  # Keep the horizontal grid lines

# Add p-value annotation with updated position and text size
model14_manual_graph <- model14_manual_graph + annotate("text", x = 1.5, y = 0.925, label = sprintf("p = %.4f", t_test_result_61073$p.value), size = 6, color = "black")  # Match text size and color to model13

# Print the updated plot
print(model14_manual_graph)

ggsave("Image61073/geom_point_gratio_man_vs_model14_61073_dashed.png", bg = "white", dpi = 200)
```

```{r, warning=FALSE}
# Let's plot the gratio of the model against the gratio of the manual tracings

my.formula_61073 <- y~x

ggplot(model_compare_man_model14_61073, aes(x = gratio.x, y = gratio.y)) +
  geom_point(shape = 16, size = 5, alpha = .6) +
  geom_abline(slope = 1, intercept = 0, linetype = "dotted", color = "red", size = 1) +  # Add the y=x line
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +
  stat_poly_eq(formula = my.formula_61073, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # adjust label.size for equation size
  scale_x_continuous(breaks = seq(0.45, 0.95, 0.1), limits = c(0.45, 0.95), expand = c(0, 0)) +
  scale_y_continuous(breaks = seq(0.45, 0.95, 0.1), limits = c(0.45, 0.95), expand = c(0, 0)) +
  labs(
    x = "G-ratio of the Ground Truth", # new x label
    y = "G-ratio of the Model" # new y label
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 20),
    axis.line = element_line(size = 2, colour = "black"),
    axis.ticks.y = element_line(size = 2, colour = "black"),
    axis.ticks.length = unit(.5, "cm"),
    axis.text = element_text(size = 18), # adjust size for axis text
    axis.title = element_text(size = 20, face = "bold"), # bold axis titles
    legend.position = "none",
    plot.caption = element_text(size = 16) # adjust size for caption (equation)
  )

ggsave("Image61073/model14_vs_manual_line_of_fit.png", dpi = 200)

```

```{r}
# Let's create a violin graph to see the difference in distributions
ggplot(joined_data_man_model14_61073_final, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +  # Adding a boxplot inside the violin for more detail
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
  theme_minimal() +
  scale_x_discrete(labels = c("Ground Truth", "ADS model14 model")) +
  scale_fill_manual(values = c(manual = "blue", model14 = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS model14 model")) +
  theme(legend.position = "none")
```

## Now we will compare model 15 and manual datasets on image 61073

## Settings

```{r}
# Let's start by importing our data
morph_model15_61073 <- read.table("Image61073/Morpho_15_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_61073 <- read.table("Image61073/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_model15_61073$name = "15"
morph_man_61073$name = "manual"

# Let's combine the manual and 15 (auto) datasets together
joined_data_man_model15_61073 = rbind(morph_man_61073, morph_model15_61073)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_model15_61073_selection = subset(joined_data_man_model15_61073, axon_diam..um. >= 0.2)

# Let's do it for the manual and 15 datasets separately
morph_man_61073_selection = subset(morph_man_61073, axon_diam..um. >= 0.2)
morph_model15_61073_selection = subset(morph_model15_61073, axon_diam..um. >= 0.2)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 415
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 61073) so:
# Exclude all rows where x0 (px) < 550 or x0 (px) > 3900 and y0 (px) < 250 or y0 (px) > 3650
joined_data_man_model15_61073_final = subset(joined_data_man_model15_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 500-3800 and y0 (px) is outside 275-3600
morph_man_61073_final = subset(morph_man_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)
morph_model15_61073_final = subset(morph_model15_61073_selection, x0..px. >= 550 & x0..px. <= 3900 & y0..px. >= 250 & y0..px. <= 3650)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_model15_61073 = difference_inner_join(morph_man_61073_final, morph_model15_61073_final, by = c("x0..px.", "y0..px."), max_dist = 100 )
```

## Statistics

```{r}
# First, let's check if the data follows a normal distribution using a Shapiro-Wilk model15 for Normality
shapiro.test(joined_data_man_model15_61073_final$gratio[joined_data_man_model15_61073_final$name == "manual"])
shapiro.test(joined_data_man_model15_61073_final$gratio[joined_data_man_model15_61073_final$name == "15"])

# Okay, we see that for both we have a (p>0.05), which means we cannot reject the null-hypothesis and thus the data can be considered to follow a normal distribution, so we should perform a parametric test:

# Let's perform a paired t-model15 on my filtered data
t_test_result_61073 <- t.test(model_compare_man_model15_61073$gratio.x, model_compare_man_model15_61073$gratio.y, paired = TRUE)
t_test_result_61073

### CHANGE: We get a p-value of 0.0322. Since the p-value is lower than 0.05, we can reject the null hypothesis and say that there is a statistically significant difference between the two methods of measurement.

# Now we need to figure out the effect size
# First we calculate mean difference
mean_difference_61073 <- mean(model_compare_man_model15_61073$gratio.x - model_compare_man_model15_61073$gratio.y)

# Calculate standard deviation of differences
sd_difference_61073 <- sd(model_compare_man_model15_61073$gratio.x - model_compare_man_model15_61073$gratio.y)

# Calculate Cohen's d
effect_size_61073 <- mean_difference_61073 / sd_difference_61073

# Display results
cat("Mean Difference:", mean_difference_61073, "\n")
cat("Effect Size (Cohen's d):", effect_size_61073, "\n")

# The mean difference we get is X, this is higher than the maximum difference we concluded was acceptable from the variability comparison.

# Let's calculate the average of the absolute difference of g-ratios

# Calculate the absolute differences
model_compare_man_model15_61073$abs_diff_gratio <- abs(model_compare_man_model15_61073$gratio.x - model_compare_man_model15_61073$gratio.y)

# Compute the average of the absolute differences
average_abs_difference_61073 <- mean(model_compare_man_model15_61073$abs_diff_gratio)

# Display the result
print(paste("Average absolute G-ratio difference:", average_abs_difference_61073))


```

## Graphs

```{r}
# Let's compare the model15 model and manual tracings
joined_data_man_model15_61073_final$name <- factor(joined_data_man_model15_61073_final$name, levels = c("manual", "15"))

model15_manual_graph <- ggplot(joined_data_man_model15_61073_final, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 3, alpha = 0.5, position = position_jitter(width = .1)) +  # Adjust point size and transparency
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "15" = "Model 15")) +  # Ensure labels are correct
  scale_y_continuous(breaks = seq(0.45, 0.95, 0.05), limits = c(0.45, 0.95), expand = c(0, 0)) +
  scale_color_manual(values = c("manual" = "#00BFC4", "15" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of ground truth vs model 15",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15), # Match font size
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5), # Adjust title size and style
    axis.title.x = element_text(size = 16, face = "bold"), # Adjust axis title size and style
    axis.title.y = element_text(size = 16, face = "bold"), # Adjust axis title size and style
    axis.text.x = element_text(size = 15),  # Adjust axis text size
    axis.text.y = element_text(size = 15),  # Adjust axis text size
    legend.position = "none"
  ) #+
  #geom_hline(yintercept = seq(0.45, 0.95, by = 0.05), linetype = "dashed", color = "gray")  # Retain horizontal grid lines

# Add p-value annotation with updated position and text size
model15_manual_graph <- model15_manual_graph + annotate("text", x = 1.5, y = 0.925, label = sprintf("p = %.4f", t_test_result_61073$p.value), size = 6, color = "black")  # Adjust text size and color to match

# Print the updated plot
print(model15_manual_graph)

ggsave("Image61073/geom_point_gratio_man_vs_model15_61073_dashed.png", bg = "white", dpi = 200)

```

```{r, warning=FALSE}
# Let's plot the gratio of the model against the gratio of the manual tracings

my.formula_61073 <- y~x

# Update the graph to match the style of the model_compare_man_model13_61073_updated
model_compare_man_model15_61073_updated <- ggplot(model_compare_man_model15_61073, aes(x = gratio.x, y = gratio.y)) +
  geom_point(shape = 16, size = 5, alpha = 0.6) +  # Ensure point size and transparency match
  geom_abline(slope = 1, intercept = 0, linetype = "dotted", color = "red", size = 1) +  # Consistent y=x line style
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +  # Consistent line smoothing
  stat_poly_eq(formula = my.formula_61073, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # Consistent label size for equation
  scale_x_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1), expand = c(0, 0)) + # Adjust x-axis scale to match
  scale_y_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1), expand = c(0, 0)) + # Adjust y-axis scale to match
  labs(
    title = "Comparison of G-ratio Measurements",
    x = "G-ratio of the Ground Truth", # Updated x label
    y = "G-ratio of Model 15" # Update y label to be specific to this model
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    legend.position = "none"
  )

# Print the updated plot
print(model_compare_man_model15_61073_updated)

ggsave("Image61073/model15_vs_manual_line_of_fit.png", dpi = 200)

```

```{r}
# Let's create a violin graph to see the difference in distributions
ggplot(joined_data_man_model15_61073_final, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +  # Adding a boxplot inside the violin for more detail
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
  theme_minimal() +
  scale_x_discrete(labels = c("Ground Truth", "ADS model15 model")) +
  scale_fill_manual(values = c(manual = "blue", model15 = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS model15 model")) +
  theme(legend.position = "none")
```

```{r}
# Lets add a variable that shows the gratio difference
# Assuming model_compare already contains the gratio values as gratio.x (manual) and gratio.y (auto)
model_compare_gratio_difference_61073 <- model_compare_man_model15_61073 %>%
  mutate(diff_gratio = gratio.x - gratio.y,
         percent_diff_gratio = ((gratio.x - gratio.y) / gratio.y) * 100)

# Plotting percent differences
# First with gratio on x-axis
ggplot(model_compare_gratio_difference_61073, aes(x = gratio.x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Gratio",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_61073, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Then with axon diameter on x axis
ggplot(model_compare_gratio_difference_61073, aes(x = axon_diam..um..x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Axon diameter (um)",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_61073, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Let's see how many points are within our limit
within_limit_count_61073 <- model_compare_gratio_difference_61073 %>%
  filter(abs(diff_gratio) <= 0.011615) %>%
  summarise(count = n())

total_points_61073 <- nrow(model_compare_gratio_difference_61073)

proportion_within_limit_61073 <- within_limit_count_61073 / total_points_61073

percentage_within_limit_61073 <- proportion_within_limit_61073 * 100

print(paste("Percentage of points within ±0.011615 limit:", round(percentage_within_limit_61073, 2), "%"))

# Do this with gratio and diameter on y axis
# Also, just raw difference, not just percent difference
```

# 22) ADS data - Testing old model on new protocol (434)

## First we will only compare the manual and test datasets on image 434

## Settings

```{r}
# Let's start by importing our data
morph_old_test_434 <- read.table("Image434/Morpho_old_test_auto.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)
morph_man_434 <- read.table("Image434/Morpho_manual.txt", sep= "\t",  stringsAsFactors=F, header=TRUE)

# Let's add name tags
morph_old_test_434$name = "test"
morph_man_434$name = "manual"

# Let's combine the manual and test (auto) datasets together
joined_data_man_old_test_434 = rbind(morph_man_434, morph_old_test_434)

# Let's remove all values where the axon diameter is <0.2um, as this is almost certain to be artifacts
joined_data_man_old_test_434_selection = subset(joined_data_man_old_test_434, axon_diam..um. >= 0.2)

# Let's do it for the manual and test datasets separately
morph_man_434_selection = subset(morph_man_434, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)
morph_old_test_434_selection = subset(morph_old_test_434, axon_diam..um. >= 0.2, myelin_thickness..um. > 0.01)

# Remove edge axons
## I've found that 275<y<3600 and 500<x<3800 cut out all the edge axons and leave in all the whole axons in image 61072
## I've found that 250<y<3650 and 550<x<3900 cut out all the edge axons and leave in all the whole axons in image 61073
## I've found that 400<y<3700 and 325<x<3800 cut out all the edge axons and leave in all the whole axons in image 414
## I've found that 300<y<3500 and 250<x<3750 cut out all the edge axons and leave in all the whole axons in image 434

# So let's do that (in this case we have image 434) so:
# Exclude all rows where x0 (px) < 250 or x0 (px) > 3750 and y0 (px) < 300 or y0 (px) > 3500
joined_data_man_old_test_434_final = subset(joined_data_man_old_test_434_selection, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 300 & y0..px. <= 3500)

# Let's do the same for the different datasets independently
# Exclude all rows where x0 (px) is outside 250-3750 and y0 (px) is outside 300-3500
morph_man_434_final = subset(morph_man_434_selection, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 300 & y0..px. <= 3500)
morph_old_test_434_final = subset(morph_old_test_434_selection, x0..px. >= 250 & x0..px. <= 3750 & y0..px. >= 300 & y0..px. <= 3500)

# We can now use these filtered datasets for further analysis or plotting
# Let's use fuzzyjoin to align axons that are less than 10 pixels apart
model_compare_man_old_test_434 = difference_inner_join(morph_man_434_final, morph_old_test_434_final, by = c("x0..px.", "y0..px."), max_dist = 100 )
```

## Statistics

```{r}
# First, let's check if the data follows a normal distribution using a Shapiro-Wilk Test for Normality
shapiro.test(joined_data_man_old_test_434_final$gratio[joined_data_man_old_test_434_final$name == "manual"])
shapiro.test(joined_data_man_old_test_434_final$gratio[joined_data_man_old_test_434_final$name == "test"])

# Okay, we see that for both we have a (p>0.05), which means we cannot reject the null-hypothesis and thus the data can be considered to follow a normal distribution, so we should perform a parametric test:

# Let's perform a paired t-test on my filtered data
t_test_result_434 <- t.test(model_compare_man_old_test_434$gratio.x, model_compare_man_old_test_434$gratio.y, paired = TRUE)
t_test_result_434

### CHANGE: We get a p-value of 0.7082. Since the p-value is greater than 0.05, we can't reject the null hypothesis and say that there is not a statistically significant difference between the two methods of measurement.

# Now we need to figure out the effect size
# First we calculate mean difference
mean_difference_434 <- mean(model_compare_man_old_test_434$gratio.x - model_compare_man_old_test_434$gratio.y)

# Calculate standard deviation of differences
sd_difference_434 <- sd(model_compare_man_old_test_434$gratio.x - model_compare_man_old_test_434$gratio.y)

# Calculate Cohen's d
effect_size_434 <- mean_difference_434 / sd_difference_434

# Display results
cat("Mean Difference:", mean_difference_434, "\n")
cat("Effect Size (Cohen's d):", effect_size_434, "\n")

# The mean difference we get is X, this is higher than the maximum difference we concluded was acceptable from the variability comparison.


# Let's calculate the average of the absolute difference of g-ratios

# Calculate the absolute differences
model_compare_man_old_test_434$abs_diff_gratio <- abs(model_compare_man_old_test_434$gratio.x - model_compare_man_old_test_434$gratio.y)

# Compute the average of the absolute differences
average_abs_difference_434 <- mean(model_compare_man_old_test_434$abs_diff_gratio)

# Display the result
print(paste("Average absolute G-ratio difference:", average_abs_difference_434))
```

## Graphs

```{r}
# Let's compare the test model and manual tracings
formatted_p_value <- ifelse(t_test_result_434$p.value < 0.0001, "p < 0.0001", sprintf("p = %.4f", t_test_result_434$p.value))

old_test_model_manual_graph <- ggplot(joined_data_man_old_test_434_final, aes(x = name, y = gratio, col = name)) +
  geom_point(shape = 16, size = 5, alpha = 0.6, position = position_jitter(width = .1)) +
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = .3, col = "black", size = .5) +
  stat_summary(fun = mean, fun.min = mean, fun.max = mean, geom = "crossbar", width = 0.1, size = .4, col = "black") +
  scale_x_discrete(labels = c("manual" = "Ground Truth", "test" = "ADS test model")) +
  scale_y_continuous(breaks = seq(0.35, 1, 0.05), limits = c(0.35, 1), expand = c(0, 0)) +
  scale_color_manual(values = c("manual" = "#00BFC4", "test" = "#F8766D")) +
  labs(
    title = "G-ratio comparison of Ground truth vs test model",
    x = "Measurement Method",
    y = "G-ratio"
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 15),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    axis.title.x = element_text(face = "bold"),
    axis.title.y = element_text(face = "bold"),
    legend.position = "none"
  ) +
  geom_hline(yintercept = seq(0.35, 1, by = 0.05), linetype = "dashed", color = "gray")  # Add dashed lines

ymax <- max(joined_data_man_old_test_434_final$gratio, na.rm = TRUE) + 0.05

# Add p-value annotation
old_test_model_manual_graph <- old_test_model_manual_graph +
  geom_segment(aes(x = 1, xend = 2, y = ymax, yend = ymax), color = "black") + # Horizontal line
  geom_segment(aes(x = 1, xend = 1, y = ymax - 0.01, yend = ymax), color = "black") + # Left vertical line
  geom_segment(aes(x = 2, xend = 2, y = ymax - 0.01, yend = ymax), color = "black") + # Right vertical line
  annotate("text", x = 1.5, y = ymax + 0.01, label = "*", size = 6, color = "black") +
  annotate("text", x = 1.5, y = ymax - 0.03, label = formatted_p_value, size = 4, color = "black")  # Display p-value

# Print the plot
print(old_test_model_manual_graph)


ggsave("Image434/geom_point_gratio_man_vs_old_test_434_dashed.png", bg = "white", dpi = 200)
```

```{r, warning=FALSE}
# Let's plot the gratio of the model against the gratio of the manual tracings

my.formula_434 <- y~x

ggplot(model_compare_man_old_test_434, aes(x = gratio.x, y = gratio.y)) +
  geom_point(shape = 16, size = 5, alpha = .6) +
  geom_abline(slope = 1, intercept = 0, linetype = "dotted", color = "red", size = 1) +  # Add the y=x line
  stat_smooth(method = "lm", fullrange = TRUE, fill = NA, size = 0.4) +
  stat_poly_eq(formula = my.formula_434, aes(label = paste(after_stat(eq.label))), parse = TRUE, size = 6) + # adjust label.size for equation size
  scale_x_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1), expand = c(0, 0)) +
  scale_y_continuous(breaks = seq(0.3, 1, 0.1), limits = c(0.3, 1), expand = c(0, 0)) +
  labs(
    x = "G-ratio of the Ground Truth", # new x label
    y = "G-ratio of the Model" # new y label
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 20),
    axis.line = element_line(size = 2, colour = "black"),
    axis.ticks.y = element_line(size = 2, colour = "black"),
    axis.ticks.length = unit(.5, "cm"),
    axis.text = element_text(size = 18), # adjust size for axis text
    axis.title = element_text(size = 20, face = "bold"), # bold axis titles
    legend.position = "none",
    plot.caption = element_text(size = 16) # adjust size for caption (equation)
  )

ggsave("Image434/old_model_vs_manual_line_of_fit.png", dpi = 200)

```

```{r}
# Let's create a violin graph to see the difference in distributions
ggplot(joined_data_man_old_test_434_final, aes(x = name, y = gratio, fill = name)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white") +  # Adding a boxplot inside the violin for more detail
  labs(title = "Comparison of Gratio by Method",
       x = "Method",
       y = "G-ratio") +
  theme_minimal() +
  scale_x_discrete(labels = c("Ground Truth", "ADS test model")) +
  scale_fill_manual(values = c(manual = "blue", test = "#F8766D"),
                    name = "Method", 
                    labels = c("Ground Truth", "ADS test model")) +
  theme(legend.position = "none")
```

```{r}
# Lets add a variable that shows the gratio difference
# Assuming model_compare already contains the gratio values as gratio.x (manual) and gratio.y (auto)
model_compare_gratio_difference_old_434 <- model_compare_man_old_test_434 %>%
  mutate(diff_gratio = gratio.x - gratio.y,
         percent_diff_gratio = ((gratio.x - gratio.y) / gratio.y) * 100)

# Plotting percent differences
# First with gratio on x-axis
ggplot(model_compare_gratio_difference_old_434, aes(x = gratio.x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Gratio",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_old_434, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Then with axon diameter on x axis
ggplot(model_compare_gratio_difference_old_434, aes(x = axon_diam..um..x, y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +  # Adds a reference line at 0 percent difference
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Axon diameter (um)",
       y = "Difference in Gratio") +
  theme_minimal()

ggplot(model_compare_gratio_difference_old_434, aes(x = seq_along(diff_gratio), y = diff_gratio)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_hline(yintercept = 0.011615, linetype = "solid", color = "red") +
  geom_hline(yintercept = -0.011615, linetype = "solid", color = "red") +
  labs(title = "Difference in Gratio (Manual vs. Auto)",
       x = "Index of Axon",
       y = "Difference in Gratio") +
  theme_minimal()

# Let's see how many points are within our limit
within_limit_count_434 <- model_compare_gratio_difference_old_434 %>%
  filter(abs(diff_gratio) <= 0.011615) %>%
  summarise(count = n())

total_points_434 <- nrow(model_compare_gratio_difference_old_434)

proportion_within_limit_434 <- within_limit_count_434 / total_points_434

percentage_within_limit_434 <- proportion_within_limit_434 * 100

print(paste("Percentage of points within ±0.011615 limit:", round(percentage_within_limit_434, 2), "%"))


# Do this with gratio and diameter on y axis
# Also, just raw difference, not just percent difference
```